<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chris Paciorek">
<meta name="dcterms.date" content="2022-09-06">

<title>Statistics 243 Fall 2022 - Programming concepts</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../units/unit6-parallel.html" rel="next">
<link href="../units/unit4-goodPractices.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Statistics 243 Fall 2022</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../syllabus.html">Syllabus</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../office_hours.html">Office hours</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../schedule.html">Schedule</a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-units" role="button" data-bs-toggle="dropdown" aria-expanded="false">Units</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-units">    
        <li>
    <a class="dropdown-item" href="../units/unit1-intro.html">
 <span class="dropdown-text">Unit 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../units/unit2-dataTech.html">
 <span class="dropdown-text">Unit 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../units/unit3-bash.html">
 <span class="dropdown-text">Unit 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../units/unit4-goodPractices.html">
 <span class="dropdown-text">Unit 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../units/unit5-programming.html">
 <span class="dropdown-text">Unit 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../units/unit6-parallel.html">
 <span class="dropdown-text">Unit 6</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../units/unit7-bigData.html">
 <span class="dropdown-text">Unit 7</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-labs" role="button" data-bs-toggle="dropdown" aria-expanded="false">Labs</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-labs">    
        <li>
    <a class="dropdown-item" href="../labs/01/intro_git_knitr.html">
 <span class="dropdown-text">Lab 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../labs/02/assertionsAndTesting.html">
 <span class="dropdown-text">Lab 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../labs/03/reproducibility.html">
 <span class="dropdown-text">Lab 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../labs/04/debugging.html">
 <span class="dropdown-text">Lab 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../labs/05/code_review.html">
 <span class="dropdown-text">Lab 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../labs/06/scf.html">
 <span class="dropdown-text">Lab 6</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-how-tos" role="button" data-bs-toggle="dropdown" aria-expanded="false">How tos</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-how-tos">    
        <li>
    <a class="dropdown-item" href="../howtos/RandRStudioInstall.html">
 <span class="dropdown-text">Installing R &amp; RStudio</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howtos/accessingPython.html">
 <span class="dropdown-text">Accessing Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howtos/accessingUnixCommandLine.html">
 <span class="dropdown-text">Accessing the Unix Command Line</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howtos/gitInstall.html">
 <span class="dropdown-text">Installing Git</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howtos/ps-submission.html">
 <span class="dropdown-text">Problem Set Submissions</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Windows</li>
        <li>
    <a class="dropdown-item" href="../howtos/windowsAndLinux.html">
 <span class="dropdown-text">Installing the Linux Subsystem on Windows</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howtos/windowsInstall.html">
 <span class="dropdown-text">Using R, RStudio, and LaTeX on Windows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="https://edstem.org/us/courses/25090/discussion/">Discussion</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://statistics.berkeley.edu/computing/training/tutorials">Tutorials</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/berkeley-stat243/stat243-fall-2022"><i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Programming concepts</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit1-intro.html" class="sidebar-item-text sidebar-link">Unit 1</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit2-dataTech.html" class="sidebar-item-text sidebar-link">Unit 2</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit3-bash.html" class="sidebar-item-text sidebar-link">Unit 3</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit4-goodPractices.html" class="sidebar-item-text sidebar-link">Unit 4</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit5-programming.html" class="sidebar-item-text sidebar-link active">Unit 5</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit6-parallel.html" class="sidebar-item-text sidebar-link">Unit 6</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit7-bigData.html" class="sidebar-item-text sidebar-link">Unit 7</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#text-manipulation-string-processing-and-regular-expressions-regex" id="toc-text-manipulation-string-processing-and-regular-expressions-regex" class="nav-link" data-scroll-target="#text-manipulation-string-processing-and-regular-expressions-regex">1. Text manipulation, string processing and regular expressions (regex)</a>
  <ul class="collapse">
  <li><a href="#string-processing-and-regular-expressions-in-r" id="toc-string-processing-and-regular-expressions-in-r" class="nav-link" data-scroll-target="#string-processing-and-regular-expressions-in-r">String processing and regular expressions in R</a></li>
  <li><a href="#regexstring-processing-challenges" id="toc-regexstring-processing-challenges" class="nav-link" data-scroll-target="#regexstring-processing-challenges">Regex/string processing challenges</a></li>
  <li><a href="#side-notes-on-special-characters-in-r" id="toc-side-notes-on-special-characters-in-r" class="nav-link" data-scroll-target="#side-notes-on-special-characters-in-r">Side notes on special characters in R</a></li>
  </ul></li>
  <li><a href="#interacting-with-the-operating-system-and-external-code-and-configuring-r" id="toc-interacting-with-the-operating-system-and-external-code-and-configuring-r" class="nav-link" data-scroll-target="#interacting-with-the-operating-system-and-external-code-and-configuring-r">2. Interacting with the operating system and external code and configuring R</a>
  <ul class="collapse">
  <li><a href="#interacting-with-the-operating-system" id="toc-interacting-with-the-operating-system" class="nav-link" data-scroll-target="#interacting-with-the-operating-system">Interacting with the operating system</a></li>
  <li><a href="#controlling-the-behavior-of-r" id="toc-controlling-the-behavior-of-r" class="nav-link" data-scroll-target="#controlling-the-behavior-of-r">Controlling the behavior of R</a></li>
  <li><a href="#interacting-with-external-code" id="toc-interacting-with-external-code" class="nav-link" data-scroll-target="#interacting-with-external-code">Interacting with external code</a></li>
  </ul></li>
  <li><a href="#packages-and-namespaces" id="toc-packages-and-namespaces" class="nav-link" data-scroll-target="#packages-and-namespaces">3. Packages and namespaces</a>
  <ul class="collapse">
  <li><a href="#loading-packages" id="toc-loading-packages" class="nav-link" data-scroll-target="#loading-packages">Loading packages</a></li>
  <li><a href="#installing-packages" id="toc-installing-packages" class="nav-link" data-scroll-target="#installing-packages">Installing packages</a>
  <ul class="collapse">
  <li><a href="#source-vs.-binary-packages" id="toc-source-vs.-binary-packages" class="nav-link" data-scroll-target="#source-vs.-binary-packages">Source vs.&nbsp;binary packages</a></li>
  </ul></li>
  <li><a href="#managing-packages-using-package-managers" id="toc-managing-packages-using-package-managers" class="nav-link" data-scroll-target="#managing-packages-using-package-managers">Managing packages using package managers</a></li>
  <li><a href="#package-namespaces" id="toc-package-namespaces" class="nav-link" data-scroll-target="#package-namespaces">Package namespaces</a>
  <ul class="collapse">
  <li><a href="#why-have-namespaces" id="toc-why-have-namespaces" class="nav-link" data-scroll-target="#why-have-namespaces">Why have namespaces?</a></li>
  <li><a href="#namespace-resolution" id="toc-namespace-resolution" class="nav-link" data-scroll-target="#namespace-resolution">Namespace resolution</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#types-and-data-structures" id="toc-types-and-data-structures" class="nav-link" data-scroll-target="#types-and-data-structures">4. Types and data structures</a>
  <ul class="collapse">
  <li><a href="#data-structures" id="toc-data-structures" class="nav-link" data-scroll-target="#data-structures">Data structures</a></li>
  <li><a href="#types-and-classes" id="toc-types-and-classes" class="nav-link" data-scroll-target="#types-and-classes">Types and classes</a>
  <ul class="collapse">
  <li><a href="#overview-and-static-vs.-dynamic-typing" id="toc-overview-and-static-vs.-dynamic-typing" class="nav-link" data-scroll-target="#overview-and-static-vs.-dynamic-typing">Overview and static vs.&nbsp;dynamic typing</a></li>
  <li><a href="#types-and-classes-in-r" id="toc-types-and-classes-in-r" class="nav-link" data-scroll-target="#types-and-classes-in-r">Types and classes in R</a></li>
  <li><a href="#attributes" id="toc-attributes" class="nav-link" data-scroll-target="#attributes">Attributes</a></li>
  <li><a href="#converting-between-types" id="toc-converting-between-types" class="nav-link" data-scroll-target="#converting-between-types">Converting between types</a></li>
  </ul></li>
  <li><a href="#data-frames-and-related-concepts" id="toc-data-frames-and-related-concepts" class="nav-link" data-scroll-target="#data-frames-and-related-concepts">Data frames and related concepts</a>
  <ul class="collapse">
  <li><a href="#some-notes-on-data-frames-and-operations-on-data-frames" id="toc-some-notes-on-data-frames-and-operations-on-data-frames" class="nav-link" data-scroll-target="#some-notes-on-data-frames-and-operations-on-data-frames">Some notes on data frames and operations on data frames</a></li>
  <li><a href="#split-apply-combine" id="toc-split-apply-combine" class="nav-link" data-scroll-target="#split-apply-combine">split-apply-combine</a></li>
  <li><a href="#long-and-wide-formats" id="toc-long-and-wide-formats" class="nav-link" data-scroll-target="#long-and-wide-formats">Long and wide formats</a></li>
  <li><a href="#piping" id="toc-piping" class="nav-link" data-scroll-target="#piping">Piping</a></li>
  <li><a href="#non-standard-evaluation-and-the-tidyverse" id="toc-non-standard-evaluation-and-the-tidyverse" class="nav-link" data-scroll-target="#non-standard-evaluation-and-the-tidyverse">Non-standard evaluation and the tidyverse</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#programming-paradigms-object-oriented-and-functional-programming" id="toc-programming-paradigms-object-oriented-and-functional-programming" class="nav-link" data-scroll-target="#programming-paradigms-object-oriented-and-functional-programming">5. Programming paradigms: object-oriented and functional programming</a></li>
  <li><a href="#object-oriented-programming-oop" id="toc-object-oriented-programming-oop" class="nav-link" data-scroll-target="#object-oriented-programming-oop">6. Object-oriented programming (OOP)</a>
  <ul class="collapse">
  <li><a href="#principles" id="toc-principles" class="nav-link" data-scroll-target="#principles">Principles</a></li>
  <li><a href="#generic-function-oop" id="toc-generic-function-oop" class="nav-link" data-scroll-target="#generic-function-oop">Generic function OOP</a>
  <ul class="collapse">
  <li><a href="#s3-classes-in-r" id="toc-s3-classes-in-r" class="nav-link" data-scroll-target="#s3-classes-in-r">S3 classes in R</a></li>
  <li><a href="#multiple-dispatch-oop" id="toc-multiple-dispatch-oop" class="nav-link" data-scroll-target="#multiple-dispatch-oop">Multiple dispatch OOP</a></li>
  </ul></li>
  <li><a href="#standard-oop" id="toc-standard-oop" class="nav-link" data-scroll-target="#standard-oop">‘Standard’ OOP</a>
  <ul class="collapse">
  <li><a href="#r6-classes" id="toc-r6-classes" class="nav-link" data-scroll-target="#r6-classes">R6 classes</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#functional-programming" id="toc-functional-programming" class="nav-link" data-scroll-target="#functional-programming">7. Functional programming</a>
  <ul class="collapse">
  <li><a href="#overview-of-functional-programming" id="toc-overview-of-functional-programming" class="nav-link" data-scroll-target="#overview-of-functional-programming">Overview of functional programming</a></li>
  <li><a href="#functional-programming-in-r" id="toc-functional-programming-in-r" class="nav-link" data-scroll-target="#functional-programming-in-r">Functional programming in R</a>
  <ul class="collapse">
  <li><a href="#no-side-effects" id="toc-no-side-effects" class="nav-link" data-scroll-target="#no-side-effects">No side effects</a></li>
  <li><a href="#functions-are-first-class-objects" id="toc-functions-are-first-class-objects" class="nav-link" data-scroll-target="#functions-are-first-class-objects">Functions are first-class objects</a></li>
  <li><a href="#all-operations-are-functions" id="toc-all-operations-are-functions" class="nav-link" data-scroll-target="#all-operations-are-functions">All operations are functions</a></li>
  <li><a href="#map-operations" id="toc-map-operations" class="nav-link" data-scroll-target="#map-operations">Map operations</a></li>
  </ul></li>
  <li><a href="#function-evaluation-frames-and-the-call-stack" id="toc-function-evaluation-frames-and-the-call-stack" class="nav-link" data-scroll-target="#function-evaluation-frames-and-the-call-stack">Function evaluation, frames, and the call stack</a>
  <ul class="collapse">
  <li><a href="#overview-1" id="toc-overview-1" class="nav-link" data-scroll-target="#overview-1">Overview</a></li>
  <li><a href="#frames-and-the-call-stack" id="toc-frames-and-the-call-stack" class="nav-link" data-scroll-target="#frames-and-the-call-stack">Frames and the call stack</a></li>
  </ul></li>
  <li><a href="#function-inputs-and-outputs" id="toc-function-inputs-and-outputs" class="nav-link" data-scroll-target="#function-inputs-and-outputs">Function inputs and outputs</a>
  <ul class="collapse">
  <li><a href="#arguments" id="toc-arguments" class="nav-link" data-scroll-target="#arguments">Arguments</a></li>
  <li><a href="#function-outputs" id="toc-function-outputs" class="nav-link" data-scroll-target="#function-outputs">Function outputs</a></li>
  </ul></li>
  <li><a href="#pass-by-value-vs.-pass-by-reference" id="toc-pass-by-value-vs.-pass-by-reference" class="nav-link" data-scroll-target="#pass-by-value-vs.-pass-by-reference">Pass by value vs.&nbsp;pass by reference</a>
  <ul class="collapse">
  <li><a href="#pointers" id="toc-pointers" class="nav-link" data-scroll-target="#pointers">Pointers</a></li>
  <li><a href="#pointers-in-r" id="toc-pointers-in-r" class="nav-link" data-scroll-target="#pointers-in-r">Pointers in R?</a></li>
  <li><a href="#alternatives-to-pass-by-value-in-r" id="toc-alternatives-to-pass-by-value-in-r" class="nav-link" data-scroll-target="#alternatives-to-pass-by-value-in-r">Alternatives to pass by value in R</a></li>
  <li><a href="#promises-and-lazy-evaluation" id="toc-promises-and-lazy-evaluation" class="nav-link" data-scroll-target="#promises-and-lazy-evaluation">Promises and lazy evaluation</a></li>
  </ul></li>
  <li><a href="#variable-scope-and-lookup" id="toc-variable-scope-and-lookup" class="nav-link" data-scroll-target="#variable-scope-and-lookup">Variable scope and lookup</a>
  <ul class="collapse">
  <li><a href="#lexical-scoping" id="toc-lexical-scoping" class="nav-link" data-scroll-target="#lexical-scoping">Lexical scoping</a></li>
  <li><a href="#closures" id="toc-closures" class="nav-link" data-scroll-target="#closures">Closures</a></li>
  <li><a href="#environments-and-the-search-path" id="toc-environments-and-the-search-path" class="nav-link" data-scroll-target="#environments-and-the-search-path">Environments and the search path</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#memory-and-copies" id="toc-memory-and-copies" class="nav-link" data-scroll-target="#memory-and-copies">8. Memory and copies</a>
  <ul class="collapse">
  <li><a href="#overview-2" id="toc-overview-2" class="nav-link" data-scroll-target="#overview-2">Overview</a>
  <ul class="collapse">
  <li><a href="#allocating-and-freeing-memory" id="toc-allocating-and-freeing-memory" class="nav-link" data-scroll-target="#allocating-and-freeing-memory">Allocating and freeing memory</a></li>
  <li><a href="#the-heap-and-the-stack" id="toc-the-heap-and-the-stack" class="nav-link" data-scroll-target="#the-heap-and-the-stack">The heap and the stack</a></li>
  </ul></li>
  <li><a href="#monitoring-memory-use" id="toc-monitoring-memory-use" class="nav-link" data-scroll-target="#monitoring-memory-use">Monitoring memory use</a>
  <ul class="collapse">
  <li><a href="#monitoring-overall-memory-use-on-a-unix-style-computer" id="toc-monitoring-overall-memory-use-on-a-unix-style-computer" class="nav-link" data-scroll-target="#monitoring-overall-memory-use-on-a-unix-style-computer">Monitoring overall memory use on a UNIX-style computer</a></li>
  <li><a href="#monitoring-memory-use-in-r" id="toc-monitoring-memory-use-in-r" class="nav-link" data-scroll-target="#monitoring-memory-use-in-r">Monitoring memory use in R</a></li>
  </ul></li>
  <li><a href="#how-memory-is-used-in-r" id="toc-how-memory-is-used-in-r" class="nav-link" data-scroll-target="#how-memory-is-used-in-r">How memory is used in R</a>
  <ul class="collapse">
  <li><a href="#a-secret-weapon-inspect" id="toc-a-secret-weapon-inspect" class="nav-link" data-scroll-target="#a-secret-weapon-inspect">A secret weapon: <code>inspect</code></a></li>
  <li><a href="#memory-use-in-specific-circumstances" id="toc-memory-use-in-specific-circumstances" class="nav-link" data-scroll-target="#memory-use-in-specific-circumstances">Memory use in specific circumstances</a></li>
  <li><a href="#copy-on-modify" id="toc-copy-on-modify" class="nav-link" data-scroll-target="#copy-on-modify">Copy-on-modify</a></li>
  </ul></li>
  <li><a href="#strategies-for-saving-memory" id="toc-strategies-for-saving-memory" class="nav-link" data-scroll-target="#strategies-for-saving-memory">Strategies for saving memory</a></li>
  <li><a href="#example-1" id="toc-example-1" class="nav-link" data-scroll-target="#example-1">Example</a></li>
  </ul></li>
  <li><a href="#efficiency" id="toc-efficiency" class="nav-link" data-scroll-target="#efficiency">9. Efficiency</a>
  <ul class="collapse">
  <li><a href="#interpreters-and-compilation" id="toc-interpreters-and-compilation" class="nav-link" data-scroll-target="#interpreters-and-compilation">Interpreters and compilation</a>
  <ul class="collapse">
  <li><a href="#why-are-interpreted-languages-slow" id="toc-why-are-interpreted-languages-slow" class="nav-link" data-scroll-target="#why-are-interpreted-languages-slow">Why are interpreted languages slow?</a></li>
  <li><a href="#compilation" id="toc-compilation" class="nav-link" data-scroll-target="#compilation">Compilation</a></li>
  </ul></li>
  <li><a href="#benchmarking-and-profiling" id="toc-benchmarking-and-profiling" class="nav-link" data-scroll-target="#benchmarking-and-profiling">Benchmarking and profiling</a></li>
  <li><a href="#writing-efficient-r-code" id="toc-writing-efficient-r-code" class="nav-link" data-scroll-target="#writing-efficient-r-code">Writing efficient R code</a></li>
  <li><a href="#hashing-including-name-lookup" id="toc-hashing-including-name-lookup" class="nav-link" data-scroll-target="#hashing-including-name-lookup">Hashing (including name lookup)</a></li>
  <li><a href="#efficiency-challenges" id="toc-efficiency-challenges" class="nav-link" data-scroll-target="#efficiency-challenges">Efficiency challenges</a></li>
  </ul></li>
  <li><a href="#computing-on-the-language-optional" id="toc-computing-on-the-language-optional" class="nav-link" data-scroll-target="#computing-on-the-language-optional">10. Computing on the language (optional)</a>
  <ul class="collapse">
  <li><a href="#the-r-interpreter" id="toc-the-r-interpreter" class="nav-link" data-scroll-target="#the-r-interpreter">The R interpreter</a>
  <ul class="collapse">
  <li><a href="#parsing" id="toc-parsing" class="nav-link" data-scroll-target="#parsing">Parsing</a></li>
  <li><a href="#primitive-and-.internal-and-.external" id="toc-primitive-and-.internal-and-.external" class="nav-link" data-scroll-target="#primitive-and-.internal-and-.external"><code>.Primitive()</code> and <code>.Internal()</code> (and <code>.External()</code>)</a></li>
  </ul></li>
  <li><a href="#parsing-code-and-understanding-language-objects" id="toc-parsing-code-and-understanding-language-objects" class="nav-link" data-scroll-target="#parsing-code-and-understanding-language-objects">Parsing code and understanding language objects</a></li>
  <li><a href="#manipulating-the-parse-tree" id="toc-manipulating-the-parse-tree" class="nav-link" data-scroll-target="#manipulating-the-parse-tree">Manipulating the parse tree</a></li>
  <li><a href="#parsing-replacement-expressions" id="toc-parsing-replacement-expressions" class="nav-link" data-scroll-target="#parsing-replacement-expressions">Parsing replacement expressions</a></li>
  <li><a href="#substitute" id="toc-substitute" class="nav-link" data-scroll-target="#substitute">substitute()</a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final thoughts</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Programming concepts</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Chris Paciorek </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 6, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<p><a href="./unit5-programming.pdf" class="btn btn-primary">PDF</a></p>
<p>References:</p>
<ul>
<li>Books on R listed on the syllabus: Adler, Chambers, Wickham</li>
<li><a href="http://cran.r-project.org/doc/manuals/R-intro.html">R intro manual</a> and <a href="http://cran.r-project.org/doc/manuals/R-lang.html">R language manual</a> (R-lang), both on CRAN.</li>
<li>Murrell, Introduction to Data Technologies</li>
</ul>
<p>(Optional) Videos</p>
<p>There are various videos from 2020 in the bCourses Media Gallery that you can use for reference if you want to. Note that I’ve reorganized the material in this Unit relative to 2020, so the section numbers and ordering in the videos may differ from that in the current Unit, but you should be able to match things up fairly easily.</p>
<ul>
<li>Video 1. Strings and regular expressions</li>
<li>Video 3. Type/class coercion</li>
<li>Video 4. Object-oriented programming - S3 classes</li>
<li>Video 5. Object-oriented programming - R6 classes</li>
<li>Video 6. Nested function calls and the call stack</li>
<li>Video 7. Operators in R</li>
<li>Video 8. Unexpected functions and replacement functions</li>
<li>Video 13. Memory and copying</li>
<li>Video 9. Timing and profiling code</li>
<li>Video 10. Pre-allocating memory</li>
<li>Video 11: Variable lookup by name and hashing</li>
<li>Video 12: Cache-aware programming</li>
</ul>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>This unit covers a variety of programming concepts, illustrated in the context of R and with comments about and connections to other languages. It also serves as a way to teach some advanced features of R. In general the concepts are relevant in other languages, though other languages may implement things differently. One of my goals for the unit is for us to think about why things are the way they are in R. I.e., what principles were used in creating the language and what choices were made? While other languages use different principles and made different choices, understanding what one language does in detail will be helpful when you are learning another language or choosing a language for a project.</p>
<p>I’ll likely refer to R syntax as <em>statements</em> or <em>expressions</em>, meaning any code that is a valid, complete R expression. But note that the term <em>expression</em> also means a specific type of object within the R language, as seen late in this Unit when we discuss computing on the language.</p>
</section>
<section id="text-manipulation-string-processing-and-regular-expressions-regex" class="level1">
<h1>1. Text manipulation, string processing and regular expressions (regex)</h1>
<p>Text manipulations in R have a number of things in common with Python, Perl, and UNIX, as many of these evolved from UNIX. When I use the term <em>string</em> here, I’ll be referring to any sequence of characters that may include numbers, white space, and special characters, rather than to the character class of R objects. The string or strings will generally be stored as an R character vector.</p>
<section id="string-processing-and-regular-expressions-in-r" class="level2">
<h2 class="anchored" data-anchor-id="string-processing-and-regular-expressions-in-r">String processing and regular expressions in R</h2>
<p>For details of string processing in R, including use of regular expressions, see the <a href="https://berkeley-scf.github.io/tutorial-string-processing">string processing tutorial</a>. (You can ignore the sections on Python if you wish.) That tutorial then refers to the <a href="https://berkeley-scf.github.io/tutorial-using-bash/regex">bash shell tutorial</a> for details on regular expressions.</p>
<p>In class we’ll work through some problems in the string processing tutorial, focusing in particular on the use of regular expressions with the <em>stringr</em> package. This will augment our consideration of regular expressions in the shell, in particular by seeing how we can replace patterns in addition to finding them.</p>
</section>
<section id="regexstring-processing-challenges" class="level2">
<h2 class="anchored" data-anchor-id="regexstring-processing-challenges">Regex/string processing challenges</h2>
<p>We’ll work on these challenges (and perhaps one or two others) in class in the process of working through the string processing tutorial.</p>
<ol type="1">
<li><p>What regex would I use to find any number with or without a decimal place.</p></li>
<li><p>Suppose a text string has dates in the form “Aug-3”, “May-9”, etc. and I want them in the form “3 Aug”, “9 May”, etc. How would I do this search and replace operation? (Alternatively, how could I do this without using regular expressions at all?)</p></li>
</ol>
</section>
<section id="side-notes-on-special-characters-in-r" class="level2">
<h2 class="anchored" data-anchor-id="side-notes-on-special-characters-in-r">Side notes on special characters in R</h2>
<p>Recall that when characters are used for special purposes, we need to ‘escape’ them if we want them interpreted as the actual character. In what follows, I show this in R, but similar manipulations are sometimes needed in the shell and in Python.</p>
<p>This can get particularly confusing in R as the backslash is also used to input special characters such as newline (<code>\n</code>) or tab (<code>\t</code>).</p>
<p>Here are some examples of using special characters.</p>
<blockquote class="blockquote">
<p><strong>Note</strong> It is hard to compile the Rmd file correctly for these R chunks, so I am just pasting in the output from running in R ‘manually’ in some cases.)</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="st">"Harry said, </span><span class="sc">\"</span><span class="st">Hi</span><span class="sc">\"</span><span class="st">"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="do">## cat(tmp)   # prints out without a newline -- this is hard to show in the pdf</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="st">"Harry said, </span><span class="sc">\"</span><span class="st">Hi</span><span class="sc">\"</span><span class="st">.</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(tmp)      <span class="co"># prints out with the newline</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Harry said, "Hi".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"azar"</span>, <span class="st">"foo"</span>, <span class="st">"hello</span><span class="sc">\t</span><span class="st">there</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(tmp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>azar foo hello  there</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tmp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "azar"           "foo"            "hello\tthere\n"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span>(<span class="st">"[</span><span class="sc">\t</span><span class="st">z]"</span>, tmp)   <span class="do">## search for a tab or a 'z'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 3</code></pre>
</div>
</div>
<p>As a result, in R we often need two backslashes when working with regular expressions. In the next examples, the first backslash says to interpret the next backslash literally, with the second backslash being used to indicate that the caret (^) should be interpreted literally and not as a special character in the regular expression syntax.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Search for characters that are not 'z'</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="do">## (using ^ as regular expression syntax)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span>(<span class="st">"[^z]"</span>, <span class="fu">c</span>(<span class="st">"a^2"</span>, <span class="st">"93"</span>, <span class="st">"zzz"</span>, <span class="st">"zit"</span>, <span class="st">"azar"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 4 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Search for either a '^' (as a regular charcter) or a 'z':</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span>(<span class="st">"[</span><span class="sc">\\</span><span class="st">^z]"</span>, <span class="fu">c</span>(<span class="st">"a^2"</span>, <span class="st">"93"</span>, <span class="st">"zzz"</span>, <span class="st">"zit"</span>, <span class="st">"azar"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 3 4 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## This fails (and the Rmd won't compile) because</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="do">## '\^' is not an escape sequence (i.e., a special character):</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="do">## grep("[\^z]", c("a^2", "93", "zit", "azar", "zzz"))</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Error: '\^' is an unrecognized escape in character string starting ""[\^"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Search for exactly three characters</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="do">## (using . as regular expression syntax)</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span>(<span class="st">"^.{3}$"</span>, <span class="fu">c</span>(<span class="st">"abc"</span>, <span class="st">"1234"</span>, <span class="st">"def"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Search for a period (as a regular character)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">."</span>, <span class="fu">c</span>(<span class="st">"3.9"</span>, <span class="st">"27"</span>, <span class="st">"4.2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">## This fails (and the Rmd won't compile) because </span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="do">## '\.' is not an escape sequence (i.e., a special character):</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="do">## grep("\.", c("3.9", "27")))</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Error: '\.' is an unrecognized escape in character string starting ""\."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Challenge</strong> Explain why we use a single backslash to get a newline and double backslash to write out a Windows path in the examples here:</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Suppose we want to use a \ in our string:</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"hello</span><span class="sc">\n</span><span class="st">again"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hello
again</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"hello</span><span class="sc">\\</span><span class="st">nagain"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hello\nagain</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"My Windows path is: C:</span><span class="sc">\\</span><span class="st">Users</span><span class="sc">\\</span><span class="st">My Documents."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>My Windows path is: C:\Users\My Documents.</code></pre>
</div>
</div>
<p>For more information, see <code>?Quotes</code> in R and the subsections of the string processing tutorial that discuss backslashes and escaping.</p>
<p>Advanced note: Searching for an actual backslash gets even more complicated, because we need to pass two backslashes as the regular expression, so that a literal backslash is searched for. However, to pass two backslashes, we need to escape each of them with a backslash so R doesn’t treat each backslash as part of a special character. So that’s four backslashes to search for a single backslash! Yikes. One rule of thumb is just to keep entering backslashes until things work!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Search for an actual backslash</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="st">"something </span><span class="sc">\\</span><span class="st"> other</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(tmp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>something \ other</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span>(<span class="st">"</span><span class="sc">\\\\</span><span class="st">"</span>, tmp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">grep</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">"</span>, tmp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in grep("\\", tmp): TRE pattern compilation error 'Trailing backslash'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in grep("\\", tmp) : 
  invalid regular expression '\', reason 'Trailing backslash'</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p><strong>Warning</strong> Be careful when cutting and pasting from documents that are not text files as you may paste in something that looks like a single or double quote, but which R cannot interpret as a quote because it’s some other ASCII quote character. If you paste in a ” from PDF, it will not be interpreted as a standard R double quote mark.</p>
</blockquote>
<p>Similar things come up in the shell and in Python, but in the shell you often don’t need two backslashes. E.g. you could do this to look for a literal ^ character.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="st">'\^'</span> file.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="interacting-with-the-operating-system-and-external-code-and-configuring-r" class="level1">
<h1>2. Interacting with the operating system and external code and configuring R</h1>
<section id="interacting-with-the-operating-system" class="level2">
<h2 class="anchored" data-anchor-id="interacting-with-the-operating-system">Interacting with the operating system</h2>
<p>Scripting languages allow one to interact with the operating system in various ways. Most allow you to call out to the shell to run arbitrary shell code and save results within your session.</p>
<p>I’ll assume everyone knows about the following functions/functionality for interacting with the filesystem and file in R: <em>getwd</em>, <em>setwd</em>, <em>source</em>, <em>pdf</em>, <em>save</em>, <em>save.image</em>, <em>load</em>.</p>
<ul>
<li><p>To run UNIX commands from within R, use <code>system()</code>, as follows, noting that we can save the result of a system call to an R object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="st">"ls -al"</span>)   <span class="do">## results apparently not shown when compiled...</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="st">"ls"</span>, <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>files[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0-bash-shell.sh" "badCode.R"       "cache"           "calc_mean.py"   
[5] "convert.sh"     </code></pre>
</div>
</div></li>
<li><p>There are also a bunch of functions that will do specific queries of the filesystem, including</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">file.exists</span>(<span class="st">"unit2-dataTech.Rmd"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="st">"../data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "airline.csv"           "coop.txt.gz"           "cpds.csv"             
[4] "hivSequ.csv"           "IPs.RData"             "precip.txt"           
[7] "precipData.txt"        "RTADataSub.csv"        "stackoverflow-2016.db"</code></pre>
</div>
</div></li>
<li><p>There are some tools for dealing with differences between operating systems. <em>file.path</em> is a nice example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="fu">file.path</span>(<span class="st">".."</span>, <span class="st">"data"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "airline.csv"           "coop.txt.gz"           "cpds.csv"             
[4] "hivSequ.csv"           "IPs.RData"             "precip.txt"           
[7] "precipData.txt"        "RTADataSub.csv"        "stackoverflow-2016.db"</code></pre>
</div>
</div>
<p>It’s best if you can to write your code in a way that is <em>agnostic</em> to the underlying operating system.</p></li>
<li><p>To get some info on the system you’re running on:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.info</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                       sysname 
                                       "Linux" 
                                       release 
                           "5.4.0-120-generic" 
                                       version 
"#136-Ubuntu SMP Fri Jun 10 13:40:48 UTC 2022" 
                                      nodename 
                                     "smeagol" 
                                       machine 
                                      "x86_64" 
                                         login 
                                    "paciorek" 
                                          user 
                                    "paciorek" 
                                effective_user 
                                    "paciorek" </code></pre>
</div>
</div></li>
</ul>
</section>
<section id="controlling-the-behavior-of-r" class="level2">
<h2 class="anchored" data-anchor-id="controlling-the-behavior-of-r">Controlling the behavior of R</h2>
<p>Scripting languages generally allow you to control/customize their behavior in various ways by setting options.</p>
<ul>
<li><p>To see some of the options that control how R behaves, try the <em>options</em> function. The <em>width</em> option changes the number of characters of width printed to the screen, while <em>max.print</em> revents too much of a large object from being printed to the screen.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">## options()  # this would print out a long list of options</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$add.smooth
[1] TRUE

$bitmapType
[1] "cairo"

$browser
[1] "xdg-open"

$browserNLdisabled
[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>()[<span class="fu">c</span>(<span class="st">'width'</span>, <span class="st">'digits'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$width
[1] 80

$digits
[1] 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Often it's nice to have more characters in each line on the screen,</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="do">## but that would cause overly lines in the compiled file.</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="do">## options(width = 120)</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">max.print =</span> <span class="dv">5000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <em>digits</em> option changes the number of digits of numbers printed to the screen (but be careful as this can be deceptive if you then try to compare two numbers based on what you see on the screen).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fl">0.123456</span>; b <span class="ot">&lt;-</span> <span class="fl">0.1234561</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>a; b; a <span class="sc">==</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.123</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.123</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>More on how to (and how not to) compare real-valued numbers on a computer in Unit 8.</p></li>
<li><p>Use <code>Ctrl-C</code> to interrupt execution. This will generally back out gracefully, returning you to a state as if the command had not been started. Note that if R is exceeding the amount of memory available, there can be a long delay. This can be frustrating, particularly since a primary reason you would want to interrupt is when R runs out of memory.</p></li>
<li><p><em>sessionInfo</em> gives information on the current R session and can be very helpful for recording the state of your session (including package versions) to allow for reproducibility.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.2.0 (2022-04-22)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.3 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/liblapack.so.3

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] SCF_4.1.0

loaded via a namespace (and not attached):
 [1] digest_0.6.29     jsonlite_1.8.0    magrittr_2.0.3    evaluate_0.15    
 [5] rlang_1.0.5       stringi_1.7.8     cli_3.3.0         rmarkdown_2.14   
 [9] tools_4.2.0       stringr_1.4.0     htmlwidgets_1.5.4 xfun_0.31        
[13] yaml_2.3.5        fastmap_1.1.0     compiler_4.2.0    htmltools_0.5.3  
[17] knitr_1.39       </code></pre>
</div>
</div></li>
<li><p>Any code that you wanted executed automatically when starting R can be placed in <code>~/.Rprofile</code> (or in individual, project-specific <code>.Rprofile</code> files in specific directories). This could include loading packages (see below), sourcing files that contain user-defined functions that you commonly use (you can also put the function code itself in <code>.Rprofile</code>), assigning variables, and specifying options via <code>options()</code>.</p></li>
<li><p>You can have an R script act as a shell script (like running a bash shell script) as follows. This will probably on work on Linux and Mac.</p>
<ol type="1">
<li>Write your R code in a text file, say <code>exampleRscript.R</code>.</li>
<li>As the first line of the file, include <code>#!/usr/bin/Rscript</code> (like <code>#!/bin/bash</code> in a bash shell file, as seen in Unit 2) or for more portability across machines, include <code>#!/usr/bin/env Rscript</code>.</li>
<li>Make the R code file executable with <em>chmod</em>: <code>chmod ugo+x exampleRscript.R</code>.</li>
<li>Run the script from the command line: <code>./exampleRscript.R</code></li>
</ol>
<p>If you want to pass arguments into your script, you can do so as long as you set up the R code to interpret the incoming arguments:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Now args is a character vector containing the arguments.</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Suppose the first argument should be interpreted as a number </span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="do">## and the second as a character string and the third as a boolean:</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>numericArg <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(args[<span class="dv">1</span>])</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>charArg <span class="ot">&lt;-</span> args[<span class="dv">2</span>]</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>logicalArg <span class="ot">&lt;-</span> <span class="fu">as.logical</span>(args[<span class="dv">3</span>])</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"First arg is: "</span>, numericArg, <span class="st">"; second is: "</span>, charArg, </span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"; third is: "</span>, logicalArg, <span class="st">".</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can run it as follows in the shell:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./exampleRscript.R</span> 53 blah T</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./exampleRscript.R</span> blah 22.5 t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>First arg is:  53 ; second is:  blah ; third is:  TRUE .
Warning message:
NAs introduced by coercion 
First arg is:  NA ; second is:  22.5 ; third is:  NA .</code></pre>
</div>
</div></li>
</ul>
</section>
<section id="interacting-with-external-code" class="level2">
<h2 class="anchored" data-anchor-id="interacting-with-external-code">Interacting with external code</h2>
<p>Scripting languages such as R, Python, and Julia allow you to call out to “external code”, which often means C or C++ (but also Fortran, Java and other languages).</p>
<p>In fact, the predecessor language to R, which was called ‘S’ was developed specifically (at AT&amp;T’s Bell Labs in the 1970s and 1980s) as an interactive wrapper around Fortran, the numerical programming language most commonly used at the time (and still widely relied on today in various legacy codes).</p>
<p>Calling out to external code is particularly important in languages like R and Python that are often much slower than compiled code and less important in a fast language like Julia (which uses Just-In-Time compilation – more on that later).</p>
<p>In R, one can call directly out to C or C++ code using <em>.Call</em> or one can use the <a href="https://adv-r.hadley.nz/rcpp.html">Rcpp package</a>. <em>Rcpp</em> is specifically designed to be able to write C++ code that feels somewhat like writing R code and where it is very easy to pass data between R and C++.</p>
<p>In Python, one can <a href="https://docs.python.org/3/extending/extending.html">directly call out to C or C++ code</a> or one can use <em>Cython</em> to interact with C. With Cython, one can: - Have Cython automatically translate Python code to C, if you provide type definitions for your variables. - Define C functions that can be called from your Python code.</p>
</section>
</section>
<section id="packages-and-namespaces" class="level1">
<h1>3. Packages and namespaces</h1>
<p>Scripting languages that become popular generally have an extensive collection of add-on packages available online (the causal relationship of the popularity and the extensive add-on packages goes in both directions). Packages need to be <em>installed</em> (once) on your computer and <em>loaded</em> (every time you start a new session).</p>
<p>A big part of R’s popularity is indeed the extensive collection of add-on packages on <a href="https://cran.r-project.org">CRAN</a> (and GitHub and elsewhere) that provide much of R’s functionality. To make use of a package it needs to be installed on your system (using <em>install.packages</em> once only) and loaded into R (using <em>library</em> every time you start R).</p>
<p>Some packages are <em>installed</em> by default with R and of these, some are <em>loaded</em> by default, while others require a call to <em>library</em>.</p>
<p>If you want to sound like an R expert, make sure to call them <em>packages</em> and not <em>libraries</em>. A <em>library</em> is the location in the directory structure where the packages are installed/stored.</p>
<section id="loading-packages" class="level2">
<h2 class="anchored" data-anchor-id="loading-packages">Loading packages</h2>
<p>You can use <em>library</em> to either (1) make a package available (loading it), (2) get an overview of the package, or (3) (if called without arguments) to see all the installed packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)              <span class="co"># load the package</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="at">help =</span> dplyr)       <span class="co"># get some help info about the package</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Packages in R (and in Python, Julia, etc.) may be installed in various places on the filesystem, and it sometimes it is helpful (e.g., if you end up with multiple versions of a package installed on your system) to be able to figure out where on the filesystem the package is being loaded from. If you run <code>library()</code>, you’ll notice that some of the packages are in a system directory and some are in your home directory.</p>
<p><code>.libPaths()</code> shows where R looks for packages on your system and <code>searchpaths()</code> shows where individual packages currently loaded in your session have been loaded from. The help information for <em>.libPaths</em> gives some information about how R decides what locations to look in for packages (and how you can modify that).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.libPaths</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/accounts/vis/paciorek/R/x86_64-pc-linux-gnu-library/4.2"
[2] "/system/linux/lib/R-20.04/4.2.0/x86_64/site-library"     
[3] "/usr/lib/R/site-library"                                 
[4] "/usr/lib/R/library"                                      </code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">searchpaths</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] ".GlobalEnv"                                             
 [2] "tools:quarto"                                           
 [3] "/usr/lib/R/library/stats"                               
 [4] "/usr/lib/R/library/graphics"                            
 [5] "/usr/lib/R/library/grDevices"                           
 [6] "/usr/lib/R/library/utils"                               
 [7] "/usr/lib/R/library/datasets"                            
 [8] "/system/linux/lib/R-20.04/4.2.0/x86_64/site-library/SCF"
 [9] "/usr/lib/R/library/methods"                             
[10] "Autoloads"                                              
[11] "/usr/lib/R/library/base"                                </code></pre>
</div>
</div>
</section>
<section id="installing-packages" class="level2">
<h2 class="anchored" data-anchor-id="installing-packages">Installing packages</h2>
<p>If a package is on CRAN but not on your system, you can install it easily (usually). You don’t need root permission on a machine to install a package (though sometimes you run into hassles if you are installing it just as a user, so if you have administrative privileges it may help to use them). Of course in RStudio, you can install via the GUI.</p>
<p>Packages often depend on other packages. In general, if one package depends on another, R will install the dependency automatically, but sometimes you’ll need to install a dependency yourself. In general, package dependencies are handled very cleanly in R without you having having to worry much about it; this is less the case in Python.</p>
<p>Note that R will generally install the package in a reasonable place by default but you can control where it is installed using the <em>lib</em> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'dplyr'</span>, <span class="at">lib =</span> <span class="st">'~/Rlibs'</span>) <span class="co"># ~/Rlibs needs to exist!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can also download the zipped source file from CRAN and install from the file; see the help page for <em>install.packages</em>. This is called “installing from source”. On Windows and Mac, you’ll need to do something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'dplyr_VERSION.tar.gz'</span>, <span class="at">repos =</span> <span class="cn">NULL</span>, <span class="at">type =</span> <span class="st">'source'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This can be handy if you need to install <a href="https://cran.r-project.org/src/contrib/Archive">an older version of a package</a> for reproducibility or because of some dependency incompatibility.</p>
<p>If you’ve downloaded the binary package (files ending in .tgz for Mac and .zip for Windows) and want to install the package directly from the file, use the syntax above but omit the <code>type= 'source'</code> argument.</p>
<section id="source-vs.-binary-packages" class="level3">
<h3 class="anchored" data-anchor-id="source-vs.-binary-packages">Source vs.&nbsp;binary packages</h3>
<p>The difference between a <em>source</em> package and a <em>binary</em> package is that the source package has the raw R (and C and Fortran, in some cases) code as text files while the binary package has all the code in a binary/non-text format, including that any C and Fortran code will have already been compiled. To install a source package with C or Fortran code in it, you’ll need to have developer/command-line tools (e.g., <em>XCode</em> on Mac or <em>Rtools.exe</em> on Windows) installed on your system so that you have a compiler.</p>
</section>
</section>
<section id="managing-packages-using-package-managers" class="level2">
<h2 class="anchored" data-anchor-id="managing-packages-using-package-managers">Managing packages using package managers</h2>
<p>For reproducibility, it’s important to know the versions of the packages you use (and the version of R). Package managers make it easy to do this. Some useful packages that do package management in R are <em>checkpoint</em>, <em>renv</em>, and <em>packrat</em>. The basic commonality is that they try to make it easy to ‘freeze’ the versions of hte packages you are using, record that information, and restore the versions (potentially on some other machine and by some user other than yourself). The package manager may tell you where the packages are installed, but you can always verify things with <code>.libPaths()</code>.</p>
<p>In Python, you can set up and manage isolated environments in which you can control the package versions using virtualenvs or Conda environments.</p>
</section>
<section id="package-namespaces" class="level2">
<h2 class="anchored" data-anchor-id="package-namespaces">Package namespaces</h2>
<p>The objects in a package (primarily functions, but also data) are in their own workspaces, and are accessible after you load the package using <code>library()</code>, but are not directly visible when you use <code>ls()</code>. In other words, each package has its own <em>namespace</em>. Namespaces help achieve modularity and avoid having zillions of objects all reside in your workspace. If we want to see the objects in a package’s namespace, we can do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">search</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] ".GlobalEnv"        "tools:quarto"      "package:stats"    
 [4] "package:graphics"  "package:grDevices" "package:utils"    
 [7] "package:datasets"  "package:SCF"       "package:methods"  
[10] "Autoloads"         "package:base"     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ls(pos = 4) # for the stats package</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>(<span class="at">pos =</span> <span class="dv">4</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="co"># just show the first few</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "abline"    "arrows"    "assocplot" "axis"      "Axis"     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>(<span class="st">"package:stats"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="co"># equivalent</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "acf"        "acf2AR"     "add.scope"  "add1"       "addmargins"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>(<span class="st">"package:stats"</span>, <span class="at">pattern =</span> <span class="st">"^lm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "lm"           "lm.fit"       "lm.influence" "lm.wfit"     </code></pre>
</div>
</div>
<section id="why-have-namespaces" class="level3">
<h3 class="anchored" data-anchor-id="why-have-namespaces">Why have namespaces?</h3>
<p>We’ll talk more about namespaces when we talk about variable scope and environments. But as some motivation for why this is useful, consider the following.</p>
<p>The <em>lm</em> function calls the <em>lm.fit</em> function to calculate the least squares solution in regression.</p>
<p>Suppose we write our own <em>lm.fit</em> function that does something else:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>lm.fit <span class="ot">&lt;-</span> <span class="cf">function</span>(x)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'hi'</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.fit</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "hi"</code></pre>
</div>
</div>
<p>One might expect that if one now uses <code>lm()</code> to fit a regression, that it wouldn’t work correctly because we have an <em>lm.fit</em> function in our workspace that doesn’t calculate the least squares solution. But it works just fine (see below), because <em>lm</em> and <em>lm.fit</em> are in the <em>stats</em> package namespace (see above) and R’s scoping rules (more later) ensure that the <em>lm.fit</em> that is found when I run <em>lm</em> is the <em>lm.fit</em> needed to run the regression and not my silly <em>lm.fit</em> function in current workspace.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>mod</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x)

Coefficients:
(Intercept)            x  
     0.5187       0.0753  </code></pre>
</div>
</div>
</section>
<section id="namespace-resolution" class="level3">
<h3 class="anchored" data-anchor-id="namespace-resolution">Namespace resolution</h3>
<p>Standard practice in R has generally been to load a package and then use any of the items in the package namespace directly, e.g.,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="st">"hello there"</span>, <span class="st">"hello"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>However, particularly if you’re using the package in only a limited way, it can be a nice idea to not load the entire package and instead use the namespace resolution operator in a style that might remind you of Python and some other languages:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="st">"hello there"</span>, <span class="st">"hello"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.ndarray([<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Of course in Python you could also load the entire package (i.e., import the entire namespace), though it’s not standard practice:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy <span class="im">import</span> <span class="op">*</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co">## OR: from numpy import ndarray</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> ndarray([<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Loading entire packages often causes ‘name collisions’ where there are multiple functions (or variables, more genreally) that have the same name. This can be confusing. We’ll see how R determines what function to use later in the Unit.</p>
</section>
</section>
</section>
<section id="types-and-data-structures" class="level1">
<h1>4. Types and data structures</h1>
<section id="data-structures" class="level2">
<h2 class="anchored" data-anchor-id="data-structures">Data structures</h2>
<p>Please see the <a href="unit2-dataTech.html#data-structures">data structures section of Unit 2</a> for some general discussion of data structures.</p>
<p>We’ll also see more complicated data structures when we consider objects in the next section on object-oriented programming.</p>
</section>
<section id="types-and-classes" class="level2">
<h2 class="anchored" data-anchor-id="types-and-classes">Types and classes</h2>
<section id="overview-and-static-vs.-dynamic-typing" class="level3">
<h3 class="anchored" data-anchor-id="overview-and-static-vs.-dynamic-typing">Overview and static vs.&nbsp;dynamic typing</h3>
<p>The term ‘type’ refers to how a given piece of information is stored and what operations can be done with the information. ‘Primitive’ types are the most basic types that often relate directly to how data are stored in memory or on disk (e.g., boolean, integer, numeric (real-valued, aka <em>double</em> or <em>floating point</em>), character, pointer (aka <em>address</em>, <em>reference</em>).</p>
<p>In compiled languages like C and C++, one has to define the type of each variable. Such languages are <em>statically</em> typed. Interpreted (or scripting) languages such as Python and R have <em>dynamic</em> types. One can associate different types of information with a given variable name at different times and without declaring the type of the variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">'hello'</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "hello"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>x<span class="sc">*</span><span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 21</code></pre>
</div>
</div>
<p>In contrast in a language like C, one has to declare a variable based on its type before using it:</p>
<pre><code>double y;
double x = 3.1;
y = x * 7.1;</code></pre>
<p>Dynamic typing can be quite helpful from the perspective of quick implementation and avoiding tedious type definitions and problems from minor inconsistencies between types (e.g., multiplying an integer by a real-valued number). But static typing has some critical advantages from the perspective of software development, including:</p>
<ul>
<li>protecting against errors from mismatched values and unexpected user inputs, and</li>
<li>generally much faster execution because the type of a variable does not need to be checked when the code is run.</li>
</ul>
<p>More complex types in R (and in Python) often use references (<em>pointers</em>, aka <em>addresses</em>) to the actual locations of the data. We’ll see this in detail later in the Unit.</p>
</section>
<section id="types-and-classes-in-r" class="level3">
<h3 class="anchored" data-anchor-id="types-and-classes-in-r">Types and classes in R</h3>
<p>You should be familiar with vectors as the basic data structure in R, with character, integer, numeric, etc. classes. Vectors are either <em>atomic vectors</em> or <em>lists</em>. Atomic vectors generally contain one of the four following types: <em>logical</em>, <em>integer</em>, <em>double</em> (i.e., <em>numeric</em>), and <em>character</em>.</p>
<p>Everything in R is an object and all objects have a class. For simple objects class and type are often closely related, but this is not the case for more complicated objects. As we’ll see later in the Unit, the class describes what the object contains and standard functions associated with it. In general, you mainly need to know what class an object is rather than its type.</p>
<blockquote class="blockquote">
<p><strong>Note</strong> You can look at Table 7.1 in the Adler book to see some other types.</p>
</blockquote>
<p>Let’s look at the type and class of various data structures in R. We’ll first see that real-valued are stored as double-precision (8 byte) floating point numbers internally in R (as ‘doubles’ in C, as the R interpreter is a program written in C).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>devs <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(devs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "numeric"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(devs)   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "double"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "data.frame"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is.data.frame</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is.matrix</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is</span>(a, <span class="st">"matrix"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">nrow =</span> <span class="dv">2</span>) </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(m) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "matrix" "array" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "integer"</code></pre>
</div>
</div>
<p>In most cases integer-valued numbers are stored as numeric values in R, but there are exceptions such as the result of using the sequence operater, <code>:</code>, above. We can force R to store values as integers:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "numeric"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "integer"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">c</span>(1L, 2L, 3L)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>vals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "integer"</code></pre>
</div>
</div>
</section>
<section id="attributes" class="level3">
<h3 class="anchored" data-anchor-id="attributes">Attributes</h3>
<p>We saw the notion of attributes when looking at HTML and XML, where the information was stored as key-value pairs that in many cases had additional information in the form of attributes.</p>
<p>In R, <em>attributes</em> are information about an object attached to an object as something that looks like a named list. Attributes are often copied when operating on an object. This can lead to some weird-looking formatting when in subsequent operations the <em>names</em> attribute is carried along:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span> <span class="sc">*</span> <span class="dv">365</span>)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>qs <span class="ot">&lt;-</span> <span class="fu">quantile</span>(x, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(qs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$names
[1] "2.5%"  "97.5%"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>qs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 2.5% 97.5% 
-1.96  2.03 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>qs[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2.5% 
1.04 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(qs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>352 bytes</code></pre>
</div>
</div>
<p>We can get rid of the attribute:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(qs) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>qs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.96  2.03</code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(qs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>64 bytes</code></pre>
</div>
</div>
<p>A common use of attributes is that rows and columns may be named in matrices and data frames, and elements in vectors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">y =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$names
[1] "x" "y"

$class
[1] "data.frame"

$row.names
[1] 1 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"first"</span>, <span class="st">"second"</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       x y
first  1 3
second 2 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$names
[1] "x" "y"

$class
[1] "data.frame"

$row.names
[1] "first"  "second"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">first =</span> <span class="dv">7</span>, <span class="at">second =</span> <span class="dv">1</span>, <span class="at">third =</span> <span class="dv">5</span>)</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>vec[<span class="st">'first'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>first 
    7 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(vec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$names
[1] "first"  "second" "third" </code></pre>
</div>
</div>
</section>
<section id="converting-between-types" class="level3">
<h3 class="anchored" data-anchor-id="converting-between-types">Converting between types</h3>
<p>This also goes by the term <em>coercion</em> and <em>casting</em>. Casting often needs to be done explicitly in compiled languages and somewhat less so in interpreted languages like R.</p>
<p>We convert between classes using variants on <em>as</em>: e.g.,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.character</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1" "2" "3"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(<span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"2.73"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.00 2.73</code></pre>
</div>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] a b c
Levels: a b c</code></pre>
</div>
</div>
<p>Some common conversions are converting numbers that are being interpreted as characters into actual numbers, converting between factors and characters, and converting between logical TRUE/FALSE vectors and numeric 1/0 vectors.</p>
<p>In some cases R will automatically do conversions behind the scenes in a smart way (or occasionally not so smart way). Consider these examples of implicit coercion:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">'hat'</span> <span class="co"># What do you think is going to happen?</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">2.73</span>)</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>myVec <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>myVec[indices]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2</code></pre>
</div>
</div>
<p>Here’s an example we can work through that will help illustrate how type conversions occur behind the scenes in R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">label =</span> <span class="fu">rep</span>(<span class="st">'a'</span>, n), <span class="at">val1 =</span> <span class="fu">rnorm</span>(n), <span class="at">val2 =</span> <span class="fu">rnorm</span>(n))</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  label   val1   val2
1     a -0.325 -1.068
2     a -1.184  0.606
3     a -0.870  1.215
4     a  0.735 -1.430
5     a  1.097 -0.262</code></pre>
</div>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Why does the following not work?</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>( <span class="fu">apply</span>(df, <span class="dv">1</span>, <span class="cf">function</span>(x) x[<span class="dv">2</span>] <span class="sc">+</span> x[<span class="dv">3</span>]) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in x[2] + x[3] : non-numeric argument to binary operator</code></pre>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Instead, this will work. Why?</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(df[ , <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>], <span class="dv">1</span>, <span class="cf">function</span>(x) x[<span class="dv">1</span>] <span class="sc">+</span> x[<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.393 -0.578  0.345 -0.694  0.836</code></pre>
</div>
</div>
<p>Be careful of using factors as indices:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>students <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"basic"</span>, <span class="st">"proficient"</span>, <span class="st">"advanced"</span>,</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"basic"</span>, <span class="st">"advanced"</span>, <span class="st">"minimal"</span>))</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>score <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">minimal =</span> <span class="dv">65</span>, <span class="at">basic =</span> <span class="dv">75</span>, <span class="at">proficient =</span> <span class="dv">85</span>, <span class="at">advanced =</span> <span class="dv">95</span>)</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>score[<span class="st">"advanced"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>advanced 
      95 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>students[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] advanced
Levels: advanced basic minimal proficient</code></pre>
</div>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>score[students[<span class="dv">3</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>minimal 
     65 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>score[<span class="fu">as.character</span>(students[<span class="dv">3</span>])]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>advanced 
      95 </code></pre>
</div>
</div>
<p>What has gone wrong and how does it relate to type coercion?</p>
</section>
</section>
<section id="data-frames-and-related-concepts" class="level2">
<h2 class="anchored" data-anchor-id="data-frames-and-related-concepts">Data frames and related concepts</h2>
<section id="some-notes-on-data-frames-and-operations-on-data-frames" class="level3">
<h3 class="anchored" data-anchor-id="some-notes-on-data-frames-and-operations-on-data-frames">Some notes on data frames and operations on data frames</h3>
<p>Base R provides a variety of functions for manipulating data frames, but now many researchers use add-on packages (many written by Hadley Wickham as part of a group of packages called the <em>tidyverse</em>) to do these manipulations in a more elegant way. <a href="https://https://berkeley-scf.github.io/r-bootcamp-fall-2022/modules/module6_tidyverse">Module 6 of the R bootcamp</a> describes some of these new tools in more details, but I’ll touch on some aspects of this here, without showing much of the tidyverse syntax.</p>
</section>
<section id="split-apply-combine" class="level3">
<h3 class="anchored" data-anchor-id="split-apply-combine">split-apply-combine</h3>
<p>Often analyses are done in a stratified fashion - the same operation or analysis is done on subsets of the data set. The subsets might be different time points, different locations, different hospitals, different people, etc.</p>
<p>The split-apply-combine framework is intended to operate in this kind of context: first one splits the dataset by one or more variables, then one does something to each subset, and then one combines the results. The <em>dplyr</em> package implements this framework (as does the <em>pandas</em> package for Python). One can also do similar operations using various flavors of the <em>lapply</em> family of functions such as <em>by</em>, <em>tapply</em>, and <em>aggregate</em>, but the dplyr-based tools are often nicer to use.</p>
<p>split-apply-combine is also closely related to the famous Map-Reduce framework underlying big data tools such as Hadoop and Spark.</p>
<p>It’s also very similar to standard SQL queries involving filtering, grouping, and aggregation.</p>
</section>
<section id="long-and-wide-formats" class="level3">
<h3 class="anchored" data-anchor-id="long-and-wide-formats">Long and wide formats</h3>
<p>Finally, we may want to convert between so-called ‘long’ and ‘wide’ formats, which we can motivate in the context of longitudinal data (multiple observations per subject) and panel data (temporal data for each of multiple units such as in econometrics). The wide format has repeated measurements for a subject in separate columns, while the long format has repeated measurements in separate rows, with a column for differentiating the repeated measurements.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>long <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">time =</span> <span class="fu">c</span>(<span class="dv">1980</span>, <span class="dv">1990</span>, <span class="dv">2000</span>, <span class="dv">1980</span>, <span class="dv">1990</span>, <span class="dv">2000</span>),</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">value =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">7</span>, <span class="dv">4</span>, <span class="dv">7</span>))</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>wide <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">value_1980 =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">7</span>), <span class="at">value_1990 =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">4</span>), <span class="at">value_2000 =</span> <span class="fu">c</span>(<span class="dv">9</span>, <span class="dv">7</span>))</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>long</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id time value
1  1 1980     5
2  1 1990     8
3  1 2000     9
4  2 1980     7
5  2 1990     4
6  2 2000     7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>wide</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id value_1980 value_1990 value_2000
1  1          5          8          9
2  2          7          4          7</code></pre>
</div>
</div>
<p>The wide format can be useful in some situations for treating each row as a (multivariate observation), but the long formatwhile the long format is often what is needed for analyses such as mixed models. ANOVA, or for plotting, such as with <em>ggplot2</em>.</p>
<p>There are a variety of functions for converting between wide and long formats. I recommend <em>pivot_longer</em> and <em>pivot_wider</em> in the <em>tidyr</em> package. There are also older <em>tidyr</em> functions called <em>gather</em> and <em>spread</em>. There are also the <em>melt</em> and <em>cast</em> in the <em>reshape2</em> package. These are easier to use than the functions in base R such as <em>reshape</em> or <em>stack</em> and <em>unstack</em> functions<em>.</em></p>
</section>
<section id="piping" class="level3">
<h3 class="anchored" data-anchor-id="piping">Piping</h3>
<p>Piping was introduced into R in conjuction with <em>dplyr</em> and the <em>tidyverse</em>.</p>
<p>The tidyverse pipe is <code>%&gt;%</code> while the new base R pipe is <code>|&gt;</code>. These are based on the UNIX pipe, which we saw in Unit 3, though they behave somewhat differently in that the output of the previous function is passed in as the <em>first</em> argument of the next function. In the shell, the pipe connects <em>stdout</em> from the previous command to <em>stdin</em> for the next command.</p>
</section>
<section id="non-standard-evaluation-and-the-tidyverse" class="level3">
<h3 class="anchored" data-anchor-id="non-standard-evaluation-and-the-tidyverse">Non-standard evaluation and the tidyverse</h3>
<p>Many tidyverse packages use non-standard evaluation to make it easier to code. For example in the following dplyr example, you can refer directly to <em>country</em> and <em>unemp</em>, which are variables in the data frame, without using <code>data$country</code> or <code>data$unemp</code> and without using quotes around the variable names, as in <code>"country"</code> or <code>"unemp"</code>. Referring directly to the variables in the data frame is not standard R usage, hence the term “non-standard evaluation”. One reason it is not standard is that <em>country</em> and <em>unemp</em> are not themselves independent R variables so R can’t find them in the usual way using scoping (discussed later in the Unit).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>cpds <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'cpds.csv'</span>))</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>cpds2 <span class="ot">&lt;-</span> cpds <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(country) <span class="sc">%&gt;%</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">mean_unemp =</span> <span class="fu">mean</span>(unemp))</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cpds2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
# Groups:   country [1]
   year country   vturn outlays realgdpgr unemp mean_unemp
  &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
1  1960 Australia  95.5    NA       NA     1.42       5.52
2  1961 Australia  95.3    NA       -0.07  2.79       5.52
3  1962 Australia  95.3    23.2      5.71  2.63       5.52
4  1963 Australia  95.7    23.0      6.1   2.12       5.52
5  1964 Australia  95.7    22.9      6.28  1.15       5.52
6  1965 Australia  95.7    24.9      4.97  1.15       5.52</code></pre>
</div>
</div>
<p>This ‘magic’ is done by capturing the code expression you write and evaluating it in a special way in the context of the data frame. I believe this uses R’s environment class (discussed later in the Unit), but haven’t looked more deeply.</p>
<p>While this has benefits, this so-called non-standard evaluation makes it harder to program functions in the usual way, as illustrated in the following code chunk, where neither attempt to use the function works.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>add_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(data, group_var, summarize_var) {</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>    data <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(group_var) <span class="sc">%&gt;%</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">mean_of_var =</span> <span class="fu">mean</span>(summarize_var))</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(cpds2 <span class="ot">&lt;-</span> <span class="fu">add_mean</span>(cpds, country, unemp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in group_by(., group_var) : 
  Must group by variables found in `.data`.
✖ Column `group_var` is not found.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(cpds2 <span class="ot">&lt;-</span> <span class="fu">add_mean</span>(cpds, <span class="st">'country'</span>, <span class="st">'unemp'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in group_by(., group_var) : 
  Must group by variables found in `.data`.
✖ Column `group_var` is not found.</code></pre>
</div>
</div>
<p>For more details on how to avoid this problem when writing functions that involve tidyverse manipulations, see <a href="https://dplyr.tidyverse.org/articles/programming.html">this tidyverse programming guide</a>.</p>
<p>Note that the tidyverse is not the only place where non-standard evaluation is used. Consider this <em>lm</em> call:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">weights =</span> w, <span class="at">data =</span> mydf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Challenge</strong> Where is the non-standard evaluation there?</p>
</blockquote>
</section>
</section>
</section>
<section id="programming-paradigms-object-oriented-and-functional-programming" class="level1">
<h1>5. Programming paradigms: object-oriented and functional programming</h1>
<p>Object-oriented and functional programming are two important approaches to programming.</p>
<p>Functional programming focuses on writing functions that take inputs and produce outputs. Ideally those functions don’t change the state (i.e., the values) of any variables and can be treated as black boxes. Functions can be treated like other variables, such as passing functions as arguments (as one does with <em>lapply</em> in R, for example).</p>
<p>Object-oriented programming revolves around objects that belong to classes. The class of an object defines the fields (the data objects) holding information and (often) methods that can be applied to those fields. When one calls a method, it may modify the value of the fields. A statistical analogy is that an object of a class is like the realization (the object) of a random variable (the class).</p>
<p>One can think of functional programming as being focused on actions (or <em>verbs</em> to make an analogy with human language). One carries out a computation as a sequence of function calls. One can think of OOP as being focused on the objects (or <em>nouns</em>). One carries out a computation as a sequence of operations with the objects, using the class methods.</p>
<p>Many languages are multi-paradigm, containing aspects of both approaches and allowing programmers to use either approach. Both R and Python are like this, though some might consider R to be more functional and Python to be more object-oriented. That said, in R everything is an object and has a class, while there are plenty of function-based operations in Python.</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="fl">1.2</span>, <span class="fl">3.5</span>, <span class="fl">4.2</span>])</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>x.shape  <span class="co"># field (or attribute) of the numpy array class</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>x.<span class="bu">sum</span>()  <span class="co"># method of the class</span></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(x)   <span class="co"># function</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Different people have different preferences, but which is better depends on what you are trying to do. If your computation is a data analysis pipeline that involves a series of transformations of some data, a functional approach might make more sense, since the focus is on a series of actions rather than the state of objects. If your computation involves various operations on fixed objects whose state needs to change, OOP might make more sense. For example, if you were writing code to keep track of student information, it would probably make sense to have each student as an object of a Student class with methods such as ‘register’ and ‘assign_grade’.</p>
</section>
<section id="object-oriented-programming-oop" class="level1">
<h1>6. Object-oriented programming (OOP)</h1>
<section id="principles" class="level2">
<h2 class="anchored" data-anchor-id="principles">Principles</h2>
<p>Some of the standard concepts in object-oriented programming include <em>encapsulation</em>, <em>inheritance</em>, <em>polymorphism</em>, and <em>abstraction</em>.</p>
<p><em>Encapsulation</em> involves preventing direct access to internal data in an object from outside the object. Instead the class is designed so that access (reading or writing) happens through the interface set up by the programmer (e.g., ‘getter’ and ‘setter’ methods). We’ll see this in our R6 class example below.</p>
<p><em>Inheritance</em> allows one class to be based on another class, adding more specialized features. An example in R’s S3 system is that the <em>glm</em> class inherits from the <em>lm</em> class.</p>
<p><em>Polymorphism</em> allows for different behavior of an object or function depending on the context. A polymorphic function behaves differently depending on the input types. A polymorphic object is one that can belong to different classes (e.g., based on inheritance), and a given method name can be used with any of the classes. An example would be having a base or super class called ‘algorithm’ and various specific machine learning algorithms inheriting from that class. All of the classes might have a ‘predict’ method.</p>
<p><em>Abstraction</em> involves hiding the details of how something is done (e.g., via the method of a class), giving the user an interface to provide inputs and get outputs. By making the actual computation a black box, the programmer can modify the internals without changing how a user uses the system.</p>
<p>Classes generally have <em>constructors</em> that initialize objects of the class and <em>destructors</em> that remove objects.</p>
</section>
<section id="generic-function-oop" class="level2">
<h2 class="anchored" data-anchor-id="generic-function-oop">Generic function OOP</h2>
<p>Much of the object-oriented programming in R uses <em>generic function OOP</em>, also known as <em>functional OOP</em>. In this style, classes don’t have methods. Instead there are <em>generic functions</em> (also known as <em>generic methods</em>) that change their behavior based on the type of the input(s). Another way to put it is that the nouns and the verbs are separate, unliked in standard OOP.</p>
<p>The use of generic functions is similar in spirit to function or method <em>overloading</em> in C++ and Java.</p>
<p>Generic function OOP is how the (very) old S3 system in R works. It’s also a key part of the (fairly) new Julia language.</p>
<section id="s3-classes-in-r" class="level3">
<h3 class="anchored" data-anchor-id="s3-classes-in-r">S3 classes in R</h3>
<p>S3 classes are widely-used, in particular for statistical models in the <em>stats</em> package. S3 classes are very informal in that there’s not a formal definition for an S3 class. Instead, an S3 object is just a primitive R object such as a list or vector with additional attributes including a class name.</p>
<section id="creating-our-own-class" class="level4">
<h4 class="anchored" data-anchor-id="creating-our-own-class">Creating our own class</h4>
<p>We can create an object with a new class as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>yog <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">firstname =</span> <span class="st">'Yogi'</span>, <span class="at">surname =</span> <span class="st">'the Bear'</span>, <span class="at">age =</span> <span class="dv">20</span>)</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(yog) <span class="ot">&lt;-</span> <span class="st">'bear'</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Actually, if we want to create a new class that we’ll use again, we want to create a <em>constructor</em> function that initializes new bears:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>bear <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">firstname =</span> <span class="cn">NA</span>, <span class="at">surname =</span> <span class="cn">NA</span>, <span class="at">age =</span> <span class="cn">NA</span>){</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># constructor for 'indiv' class</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>    obj <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">firstname =</span> firstname, <span class="at">surname =</span> surname,</span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">age =</span> age)</span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">class</span>(obj) <span class="ot">&lt;-</span> <span class="st">'bear'</span> </span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(obj)</span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>smoke <span class="ot">&lt;-</span> <span class="fu">bear</span>(<span class="st">'Smokey'</span>,<span class="st">'Bear'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For those of you used to more formal OOP, the following is probably disconcerting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(smoke) <span class="ot">&lt;-</span> <span class="st">"celebrity"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Generally S3 classes inherit from lists (i.e., are special cases of lists), so you can obtain components of the object using the $ operator.</p>
</section>
<section id="generic-methods" class="level4">
<h4 class="anchored" data-anchor-id="generic-methods">Generic methods</h4>
<p>The real power of the S3 system comes from defining <em>class-specific methods</em>. For example,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 -1.814  -0.490  -0.034   0.148   1.213   1.943 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x)

Residuals:
   Min     1Q Median     3Q    Max 
-1.442 -0.610 -0.140  0.451  1.806 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)    0.385      0.330    1.17     0.28
x              0.459      0.265    1.73     0.12

Residual standard error: 1.04 on 8 degrees of freedom
Multiple R-squared:  0.272, Adjusted R-squared:  0.181 
F-statistic: 2.99 on 1 and 8 DF,  p-value: 0.122</code></pre>
</div>
</div>
<p>Here <em>summary</em> is a generic function (or generic method) that, based on the type of object given to it (the first argument), dispatches a class-specific function (method) that operates on the object.</p>
<p>The above is equivalent to directly calling the class-specific methods:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">summary</span>(x), <span class="fu">summary.default</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">summary</span>(mod), <span class="fu">summary.lm</span>(mod))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>This use of generic functions is convenient in that it allows us to work with a variety of kinds of objects using familiar functions. Consider the generic methods <em>plot</em>, <em>print</em>, <em>summary</em>, <em>[</em>, and others. We can look at a function and easily see that it is a generic method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (object, ...) 
UseMethod("summary")
&lt;bytecode: 0x55a12fa38b38&gt;
&lt;environment: namespace:base&gt;</code></pre>
</div>
</div>
<p>The <code>UseMethod</code> syntax is what causes the dispatching of the class-specific method associated with <code>object</code> and calls that method. In many cases there will be a default method (here, <em>summary.default</em>), so if no method is defined for the class, R uses the default. Sidenote: arguments to a generic method are passed along to the selected method by passing along the calling environment.</p>
<p>We can also see what classes have methods for a given generic function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="fu">methods</span>(summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] summary,ANY-method                   summary,DBIObject-method            
 [3] summary,diagonalMatrix-method        summary,sparseMatrix-method         
 [5] summary.aov                          summary.aovlist*                    
 [7] summary.aspell*                      summary.check_packages_in_dir*      
 [9] summary.connection                   summary.data.frame                  
[11] summary.Date                         summary.default                     
[13] summary.ecdf*                        summary.factor                      
[15] summary.glm                          summary.infl*                       
[17] summary.lm                           summary.loess*                      
[19] summary.manova                       summary.matrix                      
[21] summary.mlm*                         summary.nls*                        
[23] summary.packageStatus*               summary.pandas.core.frame.DataFrame*
[25] summary.pandas.core.series.Series*   summary.POSIXct                     
[27] summary.POSIXlt                      summary.ppr*                        
[29] summary.prcomp*                      summary.princomp*                   
[31] summary.proc_time                    summary.python.builtin.object*      
[33] summary.rlang_error*                 summary.rlang_message*              
[35] summary.rlang_trace*                 summary.rlang_warning*              
[37] summary.rlang:::list_of_conditions*  summary.shingle*                    
[39] summary.srcfile                      summary.srcref                      
[41] summary.stepfun                      summary.stl*                        
[43] summary.table                        summary.trellis*                    
[45] summary.tukeysmooth*                 summary.vctrs_sclr*                 
[47] summary.vctrs_vctr*                  summary.warnings                    
see '?methods' for accessing help and source code</code></pre>
</div>
</div>
<p>Or from a different angle we can see what specific methods are available for a given class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="fu">methods</span>(<span class="at">class =</span> <span class="st">'lm'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] add1           alias          anova          case.names     coerce        
 [6] confint        cooks.distance deviance       dfbeta         dfbetas       
[11] drop1          dummy.coef     effects        extractAIC     family        
[16] formula        hatvalues      influence      initialize     kappa         
[21] labels         logLik         model.frame    model.matrix   nobs          
[26] plot           predict        print          proj           qr            
[31] residuals      rstandard      rstudent       show           simulate      
[36] slotsFromS3    summary        variable.names vcov          
see '?methods' for accessing help and source code</code></pre>
</div>
</div>
<p>Let’s try this functionality out on our <em>bear</em> class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>summary.bear <span class="ot">&lt;-</span> <span class="cf">function</span>(object) </span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">with</span>(object, <span class="fu">cat</span>(<span class="st">"Bear of age "</span>, age, </span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">" whose name is "</span>, firstname, <span class="st">" "</span>, surname, <span class="st">".</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">sep =</span> <span class="st">""</span>))</span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">invisible</span>(<span class="cn">NULL</span>)</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(yog)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bear of age 20 whose name is Yogi the Bear.</code></pre>
</div>
</div>
<p>We can also define a new generic function.</p>
<p>Let’s do this for the <em>bear</em> class as an illustration, though this won’t provide any functionality beyond what we did with <em>summary</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>summarize <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) </span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">UseMethod</span>(<span class="st">"summarize"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>summarize.bear <span class="ot">&lt;-</span> <span class="cf">function</span>(object) </span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">with</span>(object, <span class="fu">cat</span>(<span class="st">"Bear of age "</span>, age, </span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">" whose name is "</span>, firstname, <span class="st">" "</span>, surname, <span class="st">".</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">sep =</span> <span class="st">""</span>))</span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">invisible</span>(<span class="cn">NULL</span>)</span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize</span>(yog)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bear of age 20 whose name is Yogi the Bear.</code></pre>
</div>
</div>
</section>
<section id="why-use-generic-functions" class="level4">
<h4 class="anchored" data-anchor-id="why-use-generic-functions">Why use generic functions?</h4>
<p>We could have written <em>summary</em> as a regular function with a bunch of if statements or if-else clauses (or <em>switch</em>) so that it can handle different kinds of input objects.</p>
<p>This has two disadvantages:</p>
<ol type="1">
<li>We need to write the code that does the checking (and all the code for the different cases all lives inside one potentially very long function, unless we create class-specific helper functions).</li>
<li>Much more importantly, <em>summary</em> will only work for existing classes. And users can’t easily extend it for new classes that they create because they don’t control the <em>summary</em> function. So a user could not add the additional conditions/classes in a big if-else statement. The generic function approach makes the system <em>extensible</em> – we can build our own new functionality on what is already in R. For example, we could have written <em>summary.bear</em>.</li>
</ol>
</section>
<section id="the-print-method" class="level4">
<h4 class="anchored" data-anchor-id="the-print-method">The print method</h4>
<p>Like <em>summary</em>, <em>print</em> is a generic method, with various class-specific methods, such as <em>print.lm</em>. We could write our own <em>print.bear</em> specific method.</p>
<p>Note that the <em>print</em> function is what is called when you simply type the name of the object, so we can have object information printed out in a structured way. Thus, the output when we type the name of an <em>lm</em> object is NOT simply a regurgitation of the elements of the list - rather <em>print.lm</em> is called.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>mod</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x)

Coefficients:
(Intercept)            x  
      0.385        0.459  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x)

Coefficients:
(Intercept)            x  
      0.385        0.459  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>stats<span class="sc">:::</span><span class="fu">print.lm</span>(mod)  <span class="do">## print.lm is private to the stats namespace</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x)

Coefficients:
(Intercept)            x  
      0.385        0.459  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print.default(mod)   ## lots of output, so don't print in document...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>stats<span class="sc">:::</span>print.lm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, digits = max(3L, getOption("digits") - 3L), ...) 
{
    cat("\nCall:\n", paste(deparse(x$call), sep = "\n", collapse = "\n"), 
        "\n\n", sep = "")
    if (length(coef(x))) {
        cat("Coefficients:\n")
        print.default(format(coef(x), digits = digits), print.gap = 2L, 
            quote = FALSE)
    }
    else cat("No coefficients\n")
    cat("\n")
    invisible(x)
}
&lt;bytecode: 0x55a12bd6c488&gt;
&lt;environment: namespace:stats&gt;</code></pre>
</div>
</div>
<p>Surprisingly, the <em>summary</em> method generally doesn’t actually print out information; rather it computes things not stored in the original object and returns it as a new class (e.g., class <em>summary.lm</em>), which is then automatically printed, per my comment above (e.g., using <em>print.summary.lm</em>), unless one assigns it to a new object. Note that <em>print.summary.lm</em> is hidden from user view (it’s a private object in the <em>stats</em> namespace).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">summary</span>(mod)</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "summary.lm"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x)

Residuals:
   Min     1Q Median     3Q    Max 
-1.442 -0.610 -0.140  0.451  1.806 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)    0.385      0.330    1.17     0.28
x              0.459      0.265    1.73     0.12

Residual standard error: 1.04 on 8 degrees of freedom
Multiple R-squared:  0.272, Adjusted R-squared:  0.181 
F-statistic: 2.99 on 1 and 8 DF,  p-value: 0.122</code></pre>
</div>
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x)

Residuals:
   Min     1Q Median     3Q    Max 
-1.442 -0.610 -0.140  0.451  1.806 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)    0.385      0.330    1.17     0.28
x              0.459      0.265    1.73     0.12

Residual standard error: 1.04 on 8 degrees of freedom
Multiple R-squared:  0.272, Adjusted R-squared:  0.181 
F-statistic: 2.99 on 1 and 8 DF,  p-value: 0.122</code></pre>
</div>
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="do">## One can look at the code for the method (not shown):</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="do">## getS3method(f = "print", class = "summary.lm")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inheritance" class="level4">
<h4 class="anchored" data-anchor-id="inheritance">Inheritance</h4>
<p>Let’s look at the <em>lm</em> class, which builds on lists, and <em>glm</em> class, which builds on the <em>lm</em> class. Here <em>mod</em> is an object (an instance) of class <em>lm</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(methods)</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>ybin <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dv">10</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>ycont <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(ycont <span class="sc">~</span> x)</span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(ybin <span class="sc">~</span> x, <span class="at">family =</span> binomial)</span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "lm"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "glm" "lm" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is.list</span>(mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "coefficients"  "residuals"     "effects"       "rank"         
 [5] "fitted.values" "assign"        "qr"            "df.residual"  
 [9] "xlevels"       "call"          "terms"         "model"        </code></pre>
</div>
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is</span>(mod2, <span class="st">"lm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Here’s an example of why this is useful. We don’t have to define methods for the <em>glm</em> class if the given method for the <em>lm</em> class would work fine:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model.matrix</span>(mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   (Intercept)       x
1            1 -1.0785
2            1  0.0199
3            1 -1.4256
4            1  1.4375
5            1 -0.4247
6            1  0.5253
7            1 -0.1613
8            1  2.8155
9            1 -0.4788
10           1 -0.6805
attr(,"assign")
[1] 0 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model.matrix</span>(mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   (Intercept)       x
1            1 -1.0785
2            1  0.0199
3            1 -1.4256
4            1  1.4375
5            1 -0.4247
6            1  0.5253
7            1 -0.1613
8            1  2.8155
9            1 -0.4788
10           1 -0.6805
attr(,"assign")
[1] 0 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="fu">methods</span>(model.matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] model.matrix.default model.matrix.lm     
see '?methods' for accessing help and source code</code></pre>
</div>
</div>
<p>As noted with <em>lm</em> and <em>glm</em> objects, we can assign more than one class to an object. Here <em>summarize</em> still works, even though the primary class is <em>grizzly_bear</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(yog) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'grizzly_bear'</span>, <span class="st">'bear'</span>)</span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize</span>(yog) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bear of age 20 whose name is Yogi the Bear.</code></pre>
</div>
</div>
<p>The classes should nest within one another with the more specific classes to the left, e.g., here a <em>grizzly_bear</em> would have some additional fields on top of those of a <em>bear</em>, perhaps <em>number_of_people_killed</em> (since grizzly bears are much more dangerous than some other kinds of bears), and perhaps additional or modified methods. <em>grizzly_bear</em> inherits from <em>bear</em>, and R uses methods for the first class before methods for the next class(es).</p>
<p>The above is an example of polymorphism. <code>yog</code> is a polymorphic object and the various methods are polymorphic in that <em>print</em> can be used with the <em>bear</em> class, the <em>grizzly_bear</em> class, and other classes beyond that.</p>
<blockquote class="blockquote">
<p><strong>Challenge</strong> How would you get R to quit immediately, without asking for any more information, when you simply type <code>k</code> (no parentheses!) instead of <code>quit()</code>? (Hint: you can do this by understanding what happens when you type <code>k</code> and how to exploit the S3 system.)</p>
</blockquote>
</section>
</section>
<section id="multiple-dispatch-oop" class="level3">
<h3 class="anchored" data-anchor-id="multiple-dispatch-oop">Multiple dispatch OOP</h3>
<p>S3 method dispatch involves only the first argument to the function. In contrast, <a href="https://docs.julialang.org/en/v1/manual/methods">Julia emphasizes the importance of multiple dispatch</a> as particularly important for mathematical computation. With multiple dispatch, the specific method can be chosen based on more than one argument.</p>
<p>The old (but still used in some contexts) <a href="http://adv-r.had.co.nz/S4.html">S4</a> system in R and the (very) new <a href="https://rconsortium.github.io/OOP-WG">R7</a> system both provide for multiple dispatch.</p>
<p>As a very simple example unrelated to any specific language, multiple dispatch would allow one to do the following with the addition operator:</p>
<pre><code>3 + 7    # 10
3 + 'a'  # '3a'
'hi' +  ' there'  # 'hi there'</code></pre>
<p>The idea of having the behavior of an operator or function adapt to the type of the input(s) is one aspect of <em>polymorphism</em>.</p>
<p>Both S4 and R7 are designed to be more formal than the S3 system (recall how we could just ‘create’ an S3 class by giving a class name to an existing list). With S4 and R7, you need to define your classes.</p>
</section>
</section>
<section id="standard-oop" class="level2">
<h2 class="anchored" data-anchor-id="standard-oop">‘Standard’ OOP</h2>
<p>What I’m calling ‘standard’ object-oriented programming is the style of OOP used in languages such as Python, C++, and Java. In R, one can use this style via the R6 system (or the older <em>referenceClass</em> system).</p>
<p>In this style, objects belong to classes. A class is made up of fields (the data objects) that store information and methods that operate on the fields. Thus, unlike generic function OOP, the verbs are part of the nouns.</p>
<p>We’ll illustrate this style of OOP using an example with an R6 class.</p>
<section id="r6-classes" class="level3">
<h3 class="anchored" data-anchor-id="r6-classes">R6 classes</h3>
<p>R6 classes are a somewhat new construct in R, with a class-based approach fairly similar to Python and C++. Importantly, they behave like pointers. We’ll discuss pointers in detail later. Let’s work through an example where we set up the fields of the class and class methods, including a constructor.</p>
<section id="example" class="level4">
<h4 class="anchored" data-anchor-id="example">Example</h4>
<p>Our example is to create a class for working with random time series. Each object of the class has specific parameter values that control the stochastic behavior of the time series. With a given object we can simulate one or more time series (realizations).</p>
<p>Here’s the initial definition of the class, with both public (user-facing) and private (internal use only) methods and fields.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(R6)</span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>tsSimClass <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"tsSimClass"</span>,</span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a>    <span class="do">## class for holding time series simulators</span></span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb231-6"><a href="#cb231-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">initialize =</span> <span class="cf">function</span>(times, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">corParam =</span> <span class="dv">1</span>) {</span>
<span id="cb231-7"><a href="#cb231-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">library</span>(fields)</span>
<span id="cb231-8"><a href="#cb231-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(corParam), <span class="fu">length</span>(corParam) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb231-9"><a href="#cb231-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(times))</span>
<span id="cb231-10"><a href="#cb231-10" aria-hidden="true" tabindex="-1"></a>            private<span class="sc">$</span>times <span class="ot">&lt;-</span> times</span>
<span id="cb231-11"><a href="#cb231-11" aria-hidden="true" tabindex="-1"></a>            private<span class="sc">$</span>n <span class="ot">&lt;-</span> <span class="fu">length</span>(times)</span>
<span id="cb231-12"><a href="#cb231-12" aria-hidden="true" tabindex="-1"></a>            private<span class="sc">$</span>mean <span class="ot">&lt;-</span> mean</span>
<span id="cb231-13"><a href="#cb231-13" aria-hidden="true" tabindex="-1"></a>            private<span class="sc">$</span>corParam <span class="ot">&lt;-</span> corParam</span>
<span id="cb231-14"><a href="#cb231-14" aria-hidden="true" tabindex="-1"></a>            private<span class="sc">$</span>currentU <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb231-15"><a href="#cb231-15" aria-hidden="true" tabindex="-1"></a>            private<span class="sc">$</span><span class="fu">calcMats</span>()</span>
<span id="cb231-16"><a href="#cb231-16" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb231-17"><a href="#cb231-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb231-18"><a href="#cb231-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">setTimes =</span> <span class="cf">function</span>(newTimes) {</span>
<span id="cb231-19"><a href="#cb231-19" aria-hidden="true" tabindex="-1"></a>            private<span class="sc">$</span>times <span class="ot">&lt;-</span> newTimes</span>
<span id="cb231-20"><a href="#cb231-20" aria-hidden="true" tabindex="-1"></a>            private<span class="sc">$</span><span class="fu">calcMats</span>()</span>
<span id="cb231-21"><a href="#cb231-21" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb231-22"><a href="#cb231-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb231-23"><a href="#cb231-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">getTimes =</span> <span class="cf">function</span>() {</span>
<span id="cb231-24"><a href="#cb231-24" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(private<span class="sc">$</span>times)</span>
<span id="cb231-25"><a href="#cb231-25" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb231-26"><a href="#cb231-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-27"><a href="#cb231-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">print =</span> <span class="cf">function</span>() { <span class="co"># 'print' method</span></span>
<span id="cb231-28"><a href="#cb231-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"R6 Object of class 'tsSimClass' with "</span>,</span>
<span id="cb231-29"><a href="#cb231-29" aria-hidden="true" tabindex="-1"></a>                private<span class="sc">$</span>n, <span class="st">" time points.</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">''</span>)</span>
<span id="cb231-30"><a href="#cb231-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">invisible</span>(self)</span>
<span id="cb231-31"><a href="#cb231-31" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb231-32"><a href="#cb231-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-33"><a href="#cb231-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">simulate =</span> <span class="cf">function</span>() {</span>
<span id="cb231-34"><a href="#cb231-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="sc">!</span>private<span class="sc">$</span>currentU)     </span>
<span id="cb231-35"><a href="#cb231-35" aria-hidden="true" tabindex="-1"></a>                private<span class="sc">$</span><span class="fu">calcMats</span>()</span>
<span id="cb231-36"><a href="#cb231-36" aria-hidden="true" tabindex="-1"></a>            <span class="do">## analogous to mu+sigma*z for generating N(mu, sigma^2)</span></span>
<span id="cb231-37"><a href="#cb231-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(private<span class="sc">$</span>mean <span class="sc">+</span> <span class="fu">crossprod</span>(private<span class="sc">$</span>U, <span class="fu">rnorm</span>(private<span class="sc">$</span>n)))</span>
<span id="cb231-38"><a href="#cb231-38" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb231-39"><a href="#cb231-39" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb231-40"><a href="#cb231-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-41"><a href="#cb231-41" aria-hidden="true" tabindex="-1"></a>    <span class="do">## private methods and functions not accessible externally</span></span>
<span id="cb231-42"><a href="#cb231-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb231-43"><a href="#cb231-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">calcMats =</span> <span class="cf">function</span>() {</span>
<span id="cb231-44"><a href="#cb231-44" aria-hidden="true" tabindex="-1"></a>            <span class="do">## calculates correlation matrix and Cholesky factor</span></span>
<span id="cb231-45"><a href="#cb231-45" aria-hidden="true" tabindex="-1"></a>            lagMat <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(private<span class="sc">$</span>times) <span class="co"># local variable</span></span>
<span id="cb231-46"><a href="#cb231-46" aria-hidden="true" tabindex="-1"></a>            corMat <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>lagMat<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> private<span class="sc">$</span>corParam<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb231-47"><a href="#cb231-47" aria-hidden="true" tabindex="-1"></a>            private<span class="sc">$</span>U <span class="ot">&lt;-</span> <span class="fu">chol</span>(corMat) <span class="co"># square root matrix</span></span>
<span id="cb231-48"><a href="#cb231-48" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Done updating correlation matrix and Cholesky factor.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb231-49"><a href="#cb231-49" aria-hidden="true" tabindex="-1"></a>            private<span class="sc">$</span>currentU <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb231-50"><a href="#cb231-50" aria-hidden="true" tabindex="-1"></a>            <span class="fu">invisible</span>(self)</span>
<span id="cb231-51"><a href="#cb231-51" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb231-52"><a href="#cb231-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="cn">NULL</span>, </span>
<span id="cb231-53"><a href="#cb231-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">times =</span> <span class="cn">NULL</span>,</span>
<span id="cb231-54"><a href="#cb231-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean =</span> <span class="cn">NULL</span>,</span>
<span id="cb231-55"><a href="#cb231-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">corParam =</span> <span class="cn">NULL</span>,</span>
<span id="cb231-56"><a href="#cb231-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">U =</span> <span class="cn">NULL</span>,</span>
<span id="cb231-57"><a href="#cb231-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">currentU =</span> <span class="cn">FALSE</span></span>
<span id="cb231-58"><a href="#cb231-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb231-59"><a href="#cb231-59" aria-hidden="true" tabindex="-1"></a>)   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s see how we would use the class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>myts <span class="ot">&lt;-</span> tsSimClass<span class="sc">$</span><span class="fu">new</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done updating correlation matrix and Cholesky factor.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a>myts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R6 Object of class 'tsSimClass' with 100 time points.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a><span class="do">## here's a simulated time series</span></span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> myts<span class="sc">$</span><span class="fu">simulate</span>()</span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myts<span class="sc">$</span><span class="fu">getTimes</span>(), y1, <span class="at">type =</span> <span class="st">'l'</span>, <span class="at">xlab =</span> <span class="st">'time'</span>,</span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">'process values'</span>)</span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a><span class="do">## simulate a second series</span></span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a>y2 <span class="ot">&lt;-</span> myts<span class="sc">$</span><span class="fu">simulate</span>()</span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(myts<span class="sc">$</span><span class="fu">getTimes</span>(), y2, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="unit5-programming_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We could set up a different object that has different parameter values. That new simulated time series is less wiggly because the <code>corParam</code> value is larger than before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>myts2 <span class="ot">&lt;-</span> tsSimClass<span class="sc">$</span><span class="fu">new</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done updating correlation matrix and Cholesky factor.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a><span class="do">## here's a simulated time series with a different value of</span></span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a><span class="do">## the correlation parameter (corParam)</span></span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a>y3 <span class="ot">&lt;-</span> myts2<span class="sc">$</span><span class="fu">simulate</span>()</span>
<span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myts<span class="sc">$</span><span class="fu">getTimes</span>(), y1, <span class="at">type =</span> <span class="st">'l'</span>, <span class="at">xlab =</span> <span class="st">'time'</span>,</span>
<span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">'process values'</span>)</span>
<span id="cb239-8"><a href="#cb239-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(myts<span class="sc">$</span><span class="fu">getTimes</span>(), y2, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb239-9"><a href="#cb239-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(myts2<span class="sc">$</span><span class="fu">getTimes</span>(), y3, <span class="at">col =</span> <span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="unit5-programming_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="copies-and-references" class="level4">
<h4 class="anchored" data-anchor-id="copies-and-references">Copies and references</h4>
<p>Next let’s think about when copies are made. In the next example <code>mytsRef</code> is a copy of <code>myts</code> in the sense that both names point to the same underlying object. But no data were copied when the assignment to <code>mytsRef</code> was done.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>mytsRef <span class="ot">&lt;-</span> myts</span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 'mytsRef' and 'myts' are names for the same underlying object</span></span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>mytsFullCopy <span class="ot">&lt;-</span> myts<span class="sc">$</span><span class="fu">clone</span>()  </span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Now let's change the values of a field</span></span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>myts<span class="sc">$</span><span class="fu">setTimes</span>(<span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1000</span>, <span class="at">length =</span> <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done updating correlation matrix and Cholesky factor.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>myts<span class="sc">$</span><span class="fu">getTimes</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  0.0 10.1 20.2 30.3 40.4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>mytsRef<span class="sc">$</span><span class="fu">getTimes</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="co"># the same as `myts`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  0.0 10.1 20.2 30.3 40.4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>mytsFullCopy<span class="sc">$</span><span class="fu">getTimes</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="co"># different from `myts`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3 4 5</code></pre>
</div>
</div>
<p>In contrast <code>mytsFullCopy</code> is a reference to a different object, and all the data from <code>myts</code> had to be copied over to <code>mytsFullCopy</code>. This takes additional memory (and time), but is also safer, as it avoids the possibility that the user might modify <code>myts</code> and not realize that they were also affecting <code>mytsRef</code>.</p>
</section>
<section id="encapsulation" class="level4">
<h4 class="anchored" data-anchor-id="encapsulation">Encapsulation</h4>
<p>Why have private fields (i.e., encapsulation)? The use of private fields shields them from modification by users. In this case, that prevent users from modifying the <em>times</em> field. Why is this important? In this example, the correlation matrix and the Cholesky factor U are both functions of the vector of times. So we don’t want to allow a user to directly modify <em>times</em>. If they did, it would leave the fields of the object in inconsistent states. Instead we force them to use <em>setTimes</em>, which correctly keeps all the fields in the object internally consistent (by calling <em>calcMats</em>). It also allows us to improve efficiency by controlling when computationally expensive operations are carried out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(myts<span class="sc">$</span>times <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in myts$times &lt;- 1:10 : cannot add bindings to a locked environment</code></pre>
</div>
</div>
</section>
<section id="final-comments" class="level4">
<h4 class="anchored" data-anchor-id="final-comments">Final comments</h4>
<ul>
<li><p>As we saw above, a copy of an object is just a pointer to the original object, unless we explicitly invoke the <em>clone</em> method.</p></li>
<li><p>Classes can inherit from other classes. E.g., if we had a <em>simClass</em> and we wanted the <em>tsSimClass</em> to inherit from it:</p>
<pre><code>R6Class(tsSimClass, inherit = simClass, ...) </code></pre></li>
<li><p>If you need to refer to methods and fields you refer to the entire object as either <em>self</em> or <em>private</em>.</p></li>
</ul>
<p>More details on R6 classes can be found in the <a href="https://adv-r.hadley.nz/r6.html">Advanced R book</a>.</p>
</section>
</section>
</section>
</section>
<section id="functional-programming" class="level1">
<h1>7. Functional programming</h1>
<section id="overview-of-functional-programming" class="level2">
<h2 class="anchored" data-anchor-id="overview-of-functional-programming">Overview of functional programming</h2>
<p>Functional programming is an approach to programming that emphasizes the use of modular, self-contained functions. Such functions should operate only on arguments provided to them (avoiding global variables), and <strong>produce no side effects</strong>, although in some cases there are good reasons for making an exception. Another aspect of functional programming is that functions are considered ‘first-class’ citizens in that they can be passed as arguments to another function, returned as the result of a function, and assigned to variables. In other words, a function can be treated as any other variable.</p>
<p>In many cases (including R and Python), anonymous functions (also called ‘lambda functions’) can be created on-the-fly for use in various circumstances.</p>
</section>
<section id="functional-programming-in-r" class="level2">
<h2 class="anchored" data-anchor-id="functional-programming-in-r">Functional programming in R</h2>
<p>R is a language that has strong functional programming aspects to it, including:</p>
<ul>
<li>All operations are carried out by functions.</li>
<li>Functions are first class citizens.</li>
<li>Functions (generally) do not have side effects.</li>
<li><em>Map</em> operations (e.g., <em>lapply</em>) are central to programming in R.</li>
</ul>
<p>Functions that are not implemented internally in R are also referred to officially as <em>closures</em> (this is their <em>type</em>) - this terminology sometimes comes up in error messages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "closure"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "closure"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(length)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "builtin"</code></pre>
</div>
</div>
<section id="no-side-effects" class="level3">
<h3 class="anchored" data-anchor-id="no-side-effects">No side effects</h3>
<p>Most functions available in R (and ideally functions that you write as well) operate by taking in arguments and producing output that is then (presumably) used subsequently. The functions generally don’t have any effect on the state of your R environment/session other than the output they produce.</p>
<p>An important reason for this (plus for not using global variables) is that it means that it is easy for people using the language to understand what code does. Every function can be treated a black box – you don’t need to understand what happens in the function or worry that the function might do something unexpected (such as changing the value of one of your variables). The result of running code is simply the result of a composition of functions, as in mathematical function composition.</p>
<p>One aspect of this is that R uses a <em>pass-by-value</em> approach to function arguments (as opposed to a <em>pass-by-reference</em> approach). We’ll talk about function arguments and when copies are made in much more detail later, but briefly, when you pass an object in as an argument and then modify it in the function, you are modifying a local copy of the variable that exists in the context (the <em>frame</em>) of the function and is deleted when the function call finishes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>myfun <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>      x[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(x)</span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(x)</span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>new_x <span class="ot">&lt;-</span> <span class="fu">myfun</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 7 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>x   <span class="co"># unmodified</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3</code></pre>
</div>
</div>
<p>In contrast, let’s see what happens in Python</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun(x):</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>  x[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(x)</span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>(x)</span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-7"><a href="#cb261-7" aria-hidden="true" tabindex="-1"></a>new_x <span class="op">=</span> myfun(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1, 7, 3]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>x   <span class="co"># modified!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1, 7, 3]</code></pre>
</div>
</div>
<p>There are some (necessary) exceptions to the idea of no side effects in R. An important exception is <em>par()</em>. If you change graphics parameters by calling <em>par()</em> in a user-defined function, they are changed permanently outside of the function. One trick is as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a>  oldpar <span class="ot">&lt;-</span> <span class="fu">par</span>()</span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">cex =</span> <span class="dv">2</span>)</span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># body of code</span></span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>() <span class="ot">&lt;-</span> oldpar</span>
<span id="cb265-8"><a href="#cb265-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that changing graphics parameters within a specific plotting function - e.g., <code>plot(x, y, pch = '+')</code>, doesn’t change things except for that particular plot.</p>
<blockquote class="blockquote">
<p><strong>Challenge</strong> What are some other functions that are called for the purpose of the side effects they produce? (For example, which functions change the state of your R session in some way?</p>
</blockquote>
</section>
<section id="functions-are-first-class-objects" class="level3">
<h3 class="anchored" data-anchor-id="functions-are-first-class-objects">Functions are first-class objects</h3>
<p>Everything in R is an object, including functions. We can assign functions to variables in the same way we assign numeric and other values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(x); <span class="fu">typeof</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "numeric"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "double"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">x</span>(<span class="dv">2</span>))    <span class="co"># x is not a function (yet)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in x(2) : could not find function "x"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="cf">function</span>(z) z<span class="sc">^</span><span class="dv">2</span>  <span class="co"># now it is a function</span></span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a><span class="fu">x</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(x); <span class="fu">typeof</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "function"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "closure"</code></pre>
</div>
</div>
<p>We can call a function based on the text name of the function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>myFun <span class="ot">&lt;-</span> <span class="st">'mean'</span>; x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">as.name</span>(myFun))(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.347</code></pre>
</div>
</div>
<p>We can also pass a function into another function as the actual function object. This is an important aspect of R being a functional programming language.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(x, abs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.636 0.462 1.432 0.651 0.207 0.393 0.320 0.279 0.494 0.177</code></pre>
</div>
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(fxn, x) {</span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fxn</span>(x)</span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(mean, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.12</code></pre>
</div>
</div>
<p>We can also pass in a function based on a a character vector of length one with the name of the function. Here <em>match.fun()</em> is a handy function that extracts a function when the function is passed in as an argument of a function. It looks in the calling environment for the function and can handle when the function is passed in as a function object or as a character vector of length 1 giving the function name.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(fxn, x){</span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">match.fun</span>(fxn)(x) </span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="st">"mean"</span>, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.12</code></pre>
</div>
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(mean, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.12</code></pre>
</div>
</div>
<p>Function objects contain three components: an argument list, a body (a parsed R statement), and an environment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) y <span class="ot">&lt;-</span> x<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> x<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x<span class="sc">^</span><span class="dv">3</span></span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(y, z))</span>
<span id="cb286-6"><a href="#cb286-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb286-7"><a href="#cb286-7" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(f1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "function"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="fu">body</span>(f2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
    y &lt;- x^2
    z &lt;- x^3
    return(list(y, z))
}</code></pre>
</div>
<div class="sourceCode cell-code" id="cb290"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(<span class="fu">body</span>(f1)); <span class="fu">class</span>(<span class="fu">body</span>(f1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "language"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "&lt;-"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(<span class="fu">body</span>(f2)); <span class="fu">class</span>(<span class="fu">body</span>(f2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "language"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "{"</code></pre>
</div>
</div>
<p>We’ll see more about objects relating to the R language and parsed code in the final section of this Unit. For now, just realize that the parsed code itself is treated as an object(s) with certain types and certain classes.</p>
<p>The <em>do.call</em> function is another example of a function that takes a function as an argument. It will apply a function to the elements of a list. For example, we can <code>rbind()</code> together (if compatible) the elements of a list of vectors instead of having to loop over the elements or manually type them in:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>myList <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">b =</span> <span class="dv">11</span><span class="sc">:</span><span class="dv">13</span>, <span class="at">c =</span> <span class="dv">21</span><span class="sc">:</span><span class="dv">23</span>)</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a><span class="fu">args</span>(rbind)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (..., deparse.level = 1) 
NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb298"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(myList<span class="sc">$</span>a, myList<span class="sc">$</span>b, myList<span class="sc">$</span>c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    1    2    3
[2,]   11   12   13
[3,]   21   22   23</code></pre>
</div>
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(myList)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       a         b         c        
myList integer,3 integer,3 integer,3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="fu">do.call</span>(rbind, myList)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [,1] [,2] [,3]
a    1    2    3
b   11   12   13
c   21   22   23</code></pre>
</div>
</div>
<p>Why couldn’t we just use <em>rbind</em> directly? Basically we’re using <code>do.call()</code> to use functions that take <code>...</code> as input (i.e., functions accepting an arbitrary number of arguments) and to use the list as the input instead (i.e., to use the list elements).</p>
<p>More generally <em>do.call</em> is a way to pass arguments to a function when the arguments you want to pass are part of a list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="fu">do.call</span>(mean, <span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.5</code></pre>
</div>
</div>
</section>
<section id="all-operations-are-functions" class="level3">
<h3 class="anchored" data-anchor-id="all-operations-are-functions">All operations are functions</h3>
<p>All operations in R are actually function calls, even things that don’t look like function calls, including various operators (such as addition, subtraction, etc.), printing to the screen, etc.</p>
<section id="operators" class="level4">
<h4 class="anchored" data-anchor-id="operators">Operators</h4>
<p>Operators, such as <code>+</code> and <code>[</code> are just functions, but their arguments can occur both before and after the function call:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">7</span>; b <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a><span class="co"># let's think about the following as a mathematical function</span></span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  -- what's the function call?</span></span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a>a <span class="sc">+</span> b </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb308"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">+</span><span class="st">`</span>(a, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10</code></pre>
</div>
</div>
<p>In general, you can use back-ticks to refer to the operators as operators instead of characters. In some cases single or double quotes also work. We can look at the code of an operator as follows using back-ticks to escape out of the standard R parsing, e.g.,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%*%</span><span class="st">`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, y)  .Primitive("%*%")</code></pre>
</div>
</div>
<p>Finally, since an operator is just a function, you can use it as an argument in various places:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>; y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">200</span>,<span class="dv">300</span>)</span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a><span class="fu">outer</span>(x, y, <span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]  101  201  301
[2,]  102  202  302
[3,]  103  203  303</code></pre>
</div>
<div class="sourceCode cell-code" id="cb314"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>myList <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">list</span>(<span class="at">state =</span> <span class="st">'new york'</span>, <span class="at">value =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>),</span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>               <span class="fu">list</span>(<span class="at">state =</span> <span class="st">'california'</span>, <span class="at">value =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>),</span>
<span id="cb314-3"><a href="#cb314-3" aria-hidden="true" tabindex="-1"></a>               <span class="fu">list</span>(<span class="at">state =</span> <span class="st">'delaware'</span>, <span class="at">value =</span> <span class="dv">11</span><span class="sc">:</span><span class="dv">15</span>))</span>
<span id="cb314-4"><a href="#cb314-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-5"><a href="#cb314-5" aria-hidden="true" tabindex="-1"></a><span class="do">## note that the index "2" is the additional argument to the [[ function</span></span>
<span id="cb314-6"><a href="#cb314-6" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">lapply</span>(myList, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="dv">2</span>)</span>
<span id="cb314-7"><a href="#cb314-7" aria-hidden="true" tabindex="-1"></a>result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 1 2 3 4 5

[[2]]
[1]  6  7  8  9 10

[[3]]
[1] 11 12 13 14 15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb316"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a>myMat <span class="ot">&lt;-</span> <span class="fu">sapply</span>(myList, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="dv">2</span>)</span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a>myMat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    1    6   11
[2,]    2    7   12
[3,]    3    8   13
[4,]    4    9   14
[5,]    5   10   15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb318"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(myList[[<span class="dv">1</span>]][[<span class="dv">2</span>]], myList[[<span class="dv">2</span>]][[<span class="dv">2</span>]])  <span class="do">## equivalent but doesn't scale</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]
[1,]    1    6
[2,]    2    7
[3,]    3    8
[4,]    4    9
[5,]    5   10</code></pre>
</div>
</div>
<p>You can define your own <em>binary</em> operator (an operator taking two arguments) using a string inside <em>%</em> symbols. Here’s how we could do Python-style string addition:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb320"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%+%</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) <span class="fu">paste0</span>(a, b, <span class="at">collapse =</span> <span class="st">''</span>)</span>
<span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a><span class="st">"Hi "</span> <span class="sc">%+%</span> <span class="st">"there"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Hi there"</code></pre>
</div>
</div>
<p>Since operators are just functions, there are cases in which there are optional arguments that we might not expect. Here’s how to pass a sometimes useful argument to the bracket operator (in this case avoiding conversion from a matrix to a vector, which can mess up subsequent code).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb322"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb322-2"><a href="#cb322-2" aria-hidden="true" tabindex="-1"></a>mat[ , <span class="dv">1</span>] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb324"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a>mat[ , <span class="dv">1</span>, drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="co"># what's the difference?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]
[1,]    1
[2,]    2</code></pre>
</div>
</div>
<p>We can also use operators with our S3 classes. Picking up our example from our discussion of S3 OOP, the following example will be a bit silly (it would make more sense with a class that is a mathematical object) but indicates the power of having methods.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a>yog <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">firstname =</span> <span class="st">'Yogi'</span>, <span class="at">surname =</span> <span class="st">'the Bear'</span>, <span class="at">age =</span> <span class="dv">20</span>)</span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(yog) <span class="ot">&lt;-</span> <span class="st">'bear'</span> </span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a><span class="fu">methods</span>(<span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] +,dgTMatrix,dgTMatrix-method +,Matrix,missing-method     
 [3] +,matrix,spam-method         +,spam,matrix-method        
 [5] +,spam,missing-method        +,spam,spam-method          
 [7] +.Date                       +.gg*                       
 [9] +.glue*                      +.POSIXt                    
[11] +.vctrs_vctr*               
see '?methods' for accessing help and source code</code></pre>
</div>
<div class="sourceCode cell-code" id="cb328"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">+.bear</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(object, incr) {</span>
<span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a>    object<span class="sc">$</span>age <span class="ot">&lt;-</span> object<span class="sc">$</span>age <span class="sc">+</span> incr</span>
<span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(object)</span>
<span id="cb328-4"><a href="#cb328-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb328-5"><a href="#cb328-5" aria-hidden="true" tabindex="-1"></a>older_yog <span class="ot">&lt;-</span> yog <span class="sc">+</span> <span class="dv">15</span></span>
<span id="cb328-6"><a href="#cb328-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb328-7"><a href="#cb328-7" aria-hidden="true" tabindex="-1"></a>older_yog</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$firstname
[1] "Yogi"

$surname
[1] "the Bear"

$age
[1] 35

attr(,"class")
[1] "bear"</code></pre>
</div>
</div>
</section>
<section id="other-operations-that-are-functions" class="level4">
<h4 class="anchored" data-anchor-id="other-operations-that-are-functions">Other operations that are functions</h4>
<p>Even beyond operators, all code in R can be viewed as a function call, including if statements and for and while loops.</p>
<p>What do you think is the functional version of the following code? What are the arguments?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb330"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(x <span class="sc">&gt;</span> <span class="dv">27</span>){</span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(x)    </span>
<span id="cb330-3"><a href="#cb330-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span>{</span>
<span id="cb330-4"><a href="#cb330-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">"too small"</span>) </span>
<span id="cb330-5"><a href="#cb330-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="replacement-functions" class="level4">
<h4 class="anchored" data-anchor-id="replacement-functions">Replacement functions</h4>
<p>Assignments that involve functions or operators on the left-hand side (LHS) are called <em>replacement expressions</em> or <em>replacement functions.</em> These can be quite handy. Here are a few examples:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb331"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a><span class="fu">is.na</span>(vec) <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'var1'</span>, <span class="st">'var2'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Replacement expressions are actually function calls. The R interpreter calls the replacement function (which often creates a new object that includes the replacement) and then assigns the result to the name of the original object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb332"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">4</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a>mat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]   [,2]
[1,] 3.00 -0.215
[2,] 1.34  2.000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb334"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="st">`</span><span class="at">diag&lt;-</span><span class="st">`</span>(mat, <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">21</span>))</span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a>mat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]   [,2]
[1,] 10.00 -0.215
[2,]  1.34 21.000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb336"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a>base<span class="sc">::</span><span class="st">`</span><span class="at">diag&lt;-</span><span class="st">`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, value) 
{
    dx &lt;- dim(x)
    if (length(dx) != 2L) 
        stop("only matrix diagonals can be replaced")
    len.i &lt;- min(dx)
    len.v &lt;- length(value)
    if (len.v != 1L &amp;&amp; len.v != len.i) 
        stop("replacement diagonal has wrong length")
    if (len.i) {
        i &lt;- seq_len(len.i)
        x[cbind(i, i)] &lt;- value
    }
    x
}
&lt;bytecode: 0x55a13034d828&gt;
&lt;environment: namespace:base&gt;</code></pre>
</div>
</div>
<p>The old version of <em>mat</em> still exists until R’s memory management cleans it up, but it’s no longer referred to by the symbol <em>mat</em>. This can cause memory use to increase temporarily (but generally very briefly). So it’s something to keep in mind if you’re doing replacements on large objects.</p>
<p>You can define your own replacement functions like this, with the requirements that the last argument be named <code>value</code> and that the function return the entire object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb338"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>yog <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">firstName =</span> <span class="st">'Yogi'</span>, <span class="at">lastName =</span> <span class="st">'Bear'</span>)</span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-3"><a href="#cb338-3" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">firstName&lt;-</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(obj, value){</span>
<span id="cb338-4"><a href="#cb338-4" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>firstName <span class="ot">&lt;-</span> value</span>
<span id="cb338-5"><a href="#cb338-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(obj)</span>
<span id="cb338-6"><a href="#cb338-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-7"><a href="#cb338-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-8"><a href="#cb338-8" aria-hidden="true" tabindex="-1"></a><span class="fu">firstName</span>(yog) <span class="ot">&lt;-</span> <span class="st">'Yogisandra'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use replacement functions with functional OOP. We need to define the generic replacement function and then the class-specific one.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb339"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">age&lt;-</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) <span class="fu">UseMethod</span>(<span class="st">"age&lt;-"</span>)</span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-3"><a href="#cb339-3" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">age&lt;-.bear</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(object, value){ </span>
<span id="cb339-4"><a href="#cb339-4" aria-hidden="true" tabindex="-1"></a>    object<span class="sc">$</span>age <span class="ot">&lt;-</span> value</span>
<span id="cb339-5"><a href="#cb339-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(object)</span>
<span id="cb339-6"><a href="#cb339-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb339-7"><a href="#cb339-7" aria-hidden="true" tabindex="-1"></a><span class="fu">age</span>(older_yog) <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb339-8"><a href="#cb339-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-9"><a href="#cb339-9" aria-hidden="true" tabindex="-1"></a>older_yog</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$firstname
[1] "Yogi"

$surname
[1] "the Bear"

$age
[1] 60

attr(,"class")
[1] "bear"</code></pre>
</div>
</div>
</section>
</section>
<section id="map-operations" class="level3">
<h3 class="anchored" data-anchor-id="map-operations">Map operations</h3>
<p>A <em>map</em> operation takes a function and runs the function on each element of some collection of items, analogous to a mathematical map. This kind of operation is very commonly used in programming, particularly functional programming, and often makes for clean, concise, and readable code.</p>
<p>Base R provides a variety of map-type functions: <em>lapply</em> and <em>sapply</em> and their variants, as well as <em>apply</em>. In addition, the <em>purrr</em> package for functional programming provides <code>purrr::map</code>. In R, often the map-type function is run on the elements of a list, but they can also generally be run on elements of a vector and in other ways. In other languages, map-type functions are run on a variety of data structures. These are examples of higher-order functions – functions that take a function as an argument.</p>
<p>Let’s compare using <em>lapply</em> to using a for loop to run a stratified analysis for a generic example (this code won’t run because the variables don’t exist):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb341"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stratification </span></span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a>subsets <span class="ot">&lt;-</span> <span class="fu">split</span>(df, grouping_variable)</span>
<span id="cb341-3"><a href="#cb341-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-4"><a href="#cb341-4" aria-hidden="true" tabindex="-1"></a><span class="co"># lapply: one line, easy to understand</span></span>
<span id="cb341-5"><a href="#cb341-5" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(subsets, analysis_function)</span>
<span id="cb341-6"><a href="#cb341-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-7"><a href="#cb341-7" aria-hidden="true" tabindex="-1"></a><span class="co"># for loop: needs storage set up and multiple lines</span></span>
<span id="cb341-8"><a href="#cb341-8" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb341-9"><a href="#cb341-9" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(results) <span class="ot">&lt;-</span> <span class="fu">length</span>(subsets)</span>
<span id="cb341-10"><a href="#cb341-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(subsets)) </span>
<span id="cb341-11"><a href="#cb341-11" aria-hidden="true" tabindex="-1"></a>  results[[i]] <span class="ot">&lt;-</span> <span class="fu">analysis_function</span>(subsets[[i]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Map operations are also at the heart of the famous map-reduce paradigm, used in Hadoop and Spark for big data processing.</p>
</section>
</section>
<section id="function-evaluation-frames-and-the-call-stack" class="level2">
<h2 class="anchored" data-anchor-id="function-evaluation-frames-and-the-call-stack">Function evaluation, frames, and the call stack</h2>
<section id="overview-1" class="level3">
<h3 class="anchored" data-anchor-id="overview-1">Overview</h3>
<p>When we run code, we end up calling functions inside of other function calls. This leads to a nested series of function calls. The series of calls is the <em>call stack</em>. The stack operates like a stack of cafeteria trays - when a function is called, it is added to the stack (pushed) and when it finishes, it is removed (popped).</p>
<p>Understanding the series of calls is important when reading error messages and debugging. In Python, when an error occurs, the call stack is shown, which has the advantage of giving the complete history of what led to the error and the disadvantage of producing often very verbose output that can be hard to understand. In R, only the function in which the error occurs is shown, but you can see the full call stack by invoking <code>traceback()</code> (see the <a href="https://github.com/berkeley-scf/tutorial-R-debugging">debugging tutorial</a>).</p>
<p>What happens when an R function is evaluated?</p>
<ul>
<li>The user-provided function arguments are evaluated in the calling environment and the results are matched to the argument names in the function definition.</li>
<li>A new environment with its own frame is created, with the frame on the call stack. Assignment to the argument names is done in the environment, including any default arguments.</li>
<li>The body of the function is evaluated in the environment. Any look-up of variables not found in the environment is done using R’s lexical scoping rules to look in the series of enclosing environments.</li>
<li>When the function finishes, the return value is passed back to the calling frame and the function frame is taken off the stack. The environment is removed, unless the environment serves as the enclosing environment of another environment.</li>
</ul>
<p>I’m not expecting you to fully understand that previous paragraph and all the terms in it yet. We’ll see all the details as we proceed through this Unit.</p>
</section>
<section id="frames-and-the-call-stack" class="level3">
<h3 class="anchored" data-anchor-id="frames-and-the-call-stack">Frames and the call stack</h3>
<p>R keeps track of the call stack. Each function call is associated with a <em>frame</em> that contains the local variables for that function call.</p>
<p>There are a bunch of functions that let us query what frames are on the stack and access objects in particular frames of interest. This gives us the ability to work with objects in the frame from which a function was called.</p>
<p>Some terminology: for our purposes we’ll use the terms <em>frame</em> and <em>environment</em> somewhat interchangeably for the moment. A <em>frame</em> or <em>environment</em> is a collection of named objects. (Note that when we talk about variable scope later in this Unit, we’ll have to be more careful with our terminology.) So in the context of a function call, the frame is the set of local variables available in the function, including arguments passed to the function.</p>
<p>R provides some functions that allow you to query the call stack and its frames. <em>sys.nframe</em> returns the number of the current frame/environment and <em>sys.parent</em> the number of the parent, while <em>parent.frame</em> gives the name of the frame/environment of the parent (i.e., the calling) frame. <em>sys.frame</em> gives the name of the frame/environment for a given frame number (for non-negative numbers). For negative numbers, it goes back that many frames in the call stack and returns the name of the frame/environment. I need to manually insert the output here because the R Markdown processing up the frame counting somehow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb342"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sys.nframe</span>()</span>
<span id="cb342-2"><a href="#cb342-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb342-3"><a href="#cb342-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">'in f: Frame number is '</span>, <span class="fu">sys.nframe</span>(),</span>
<span id="cb342-4"><a href="#cb342-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">'; parent frame number is '</span>, <span class="fu">sys.parent</span>(), <span class="st">'.</span><span class="sc">\n</span><span class="st">'</span>, <span class="at">sep =</span> <span class="st">''</span>)</span>
<span id="cb342-5"><a href="#cb342-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">'in f: Frame (i.e., environment) is: '</span>)</span>
<span id="cb342-6"><a href="#cb342-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">sys.frame</span>(<span class="fu">sys.nframe</span>()))</span>
<span id="cb342-7"><a href="#cb342-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">'in f: Parent is '</span>)</span>
<span id="cb342-8"><a href="#cb342-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">parent.frame</span>())</span>
<span id="cb342-9"><a href="#cb342-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">'in f: Two frames up is '</span>)</span>
<span id="cb342-10"><a href="#cb342-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">sys.frame</span>(<span class="sc">-</span><span class="dv">2</span>))</span>
<span id="cb342-11"><a href="#cb342-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb342-12"><a href="#cb342-12" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>in f: Frame number is 1; parent frame number is 0.
in f: Frame (i.e., environment) is: &lt;environment: 0x55a4d71beb88&gt;
in f: Parent is &lt;environment: R_GlobalEnv&gt;
in f: Two frames up is Error in sys.frame(-2) : not that many frames on the stack</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb344"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a>ff <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb344-2"><a href="#cb344-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">'in ff: Frame (i.e., environment) is: '</span>)</span>
<span id="cb344-3"><a href="#cb344-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">sys.frame</span>(<span class="fu">sys.nframe</span>()))</span>
<span id="cb344-4"><a href="#cb344-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">'in ff: Parent is '</span>)</span>
<span id="cb344-5"><a href="#cb344-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">parent.frame</span>())   </span>
<span id="cb344-6"><a href="#cb344-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>()</span>
<span id="cb344-7"><a href="#cb344-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb344-8"><a href="#cb344-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ff</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>in ff: Frame (i.e., environment) is: &lt;environment: 0x55a4d7391700&gt;
in ff: Parent is &lt;environment: R_GlobalEnv&gt;
in f: Frame number is 2; parent frame number is 1.
in f: Frame (i.e., environment) is: &lt;environment: 0x55a4d7393b38&gt;
in f: Parent is &lt;environment: 0x55a4d7391700&gt;
in f: Two frames up is &lt;environment: R_GlobalEnv&gt;</code></pre>
<p>Next we’ll use a recursive function to illustrate what information we can gather about the call stack using <em>sys.status</em>. <em>sys.status</em> gives extensive information about the call stack and the frames involved (<em>sys.status</em> uses <em>sys.calls</em>, <em>sys.parents</em> and <em>sys.frames</em>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb346"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="cf">function</span>(y) {</span>
<span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(y <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">g</span>(y<span class="dv">-1</span>) <span class="cf">else</span> <span class="fu">gg</span>()</span>
<span id="cb346-3"><a href="#cb346-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb346-4"><a href="#cb346-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-5"><a href="#cb346-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Ultimately, gg() is called, and it prints out info about the call stack</span></span>
<span id="cb346-6"><a href="#cb346-6" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb346-7"><a href="#cb346-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## this gives us the information from sys.calls(),</span></span>
<span id="cb346-8"><a href="#cb346-8" aria-hidden="true" tabindex="-1"></a>    <span class="do">##   sys.parents() and sys.frames() as one object</span></span>
<span id="cb346-9"><a href="#cb346-9" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Rather than running print(sys.status()),</span></span>
<span id="cb346-10"><a href="#cb346-10" aria-hidden="true" tabindex="-1"></a>    <span class="do">## which would involve adding print() to the call stack,</span></span>
<span id="cb346-11"><a href="#cb346-11" aria-hidden="true" tabindex="-1"></a>    <span class="do">## we'll run sys.status and then print the result out.</span></span>
<span id="cb346-12"><a href="#cb346-12" aria-hidden="true" tabindex="-1"></a>    tmp <span class="ot">&lt;-</span> <span class="fu">sys.status</span>()</span>
<span id="cb346-13"><a href="#cb346-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(tmp)</span>
<span id="cb346-14"><a href="#cb346-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb346-15"><a href="#cb346-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-16"><a href="#cb346-16" aria-hidden="true" tabindex="-1"></a><span class="fu">g</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>$sys.calls
$sys.calls[[1]]
g(3)

$sys.calls[[2]]
if(y &gt; 0) g(y-1) else gg()

$sys.calls[[3]]
if(y &gt; 0) g(y-1) else gg()

$sys.calls[[4]]
if(y &gt; 0) g(y-1) else gg()

$sys.calls[[5]]
if(y &gt; 0) g(y-1) else gg()

$sys.calls[[6]]
tmp &lt;- sys.status()


$sys.parents
[1] 0 1 2 3 4 5

$sys.frames
$sys.frames[[1]]
&lt;environment: 0x55a4d63479e8&gt;

$sys.frames[[2]]
&lt;environment: 0x55a4d6347ba8&gt;

$sys.frames[[3]]
&lt;environment: 0x55a4d5736638&gt;

$sys.frames[[4]]
&lt;environment: 0x55a4d5732028&gt;

$sys.frames[[5]]
&lt;environment: 0x55a4d5732098&gt;

$sys.frames[[6]]
&lt;environment: 0x55a4d5732488&gt;</code></pre>
<blockquote class="blockquote">
<p><strong>Challenge</strong> Why did I not do <code>print(sys.status())</code> directly?</p>
</blockquote>
<p>If you’re interested in parsing a somewhat complicated example of frames in action, Adler provides a user-defined timing function that evaluates statements in the calling frame.</p>
</section>
</section>
<section id="function-inputs-and-outputs" class="level2">
<h2 class="anchored" data-anchor-id="function-inputs-and-outputs">Function inputs and outputs</h2>
<section id="arguments" class="level3">
<h3 class="anchored" data-anchor-id="arguments">Arguments</h3>
<p>Arguments can be specified by position (based on the order of the inputs) or by name, using <code>name = value</code>. R first tries to match arguments by name and then by position. In general the more important arguments are specified first. You can see the arguments and defaults for a function using <em>args</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb348"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="fu">args</span>(lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (formula, data, subset, weights, na.action, method = "qr", 
    model = TRUE, x = FALSE, y = FALSE, qr = TRUE, singular.ok = TRUE, 
    contrasts = NULL, offset, ...) 
NULL</code></pre>
</div>
</div>
<p>You can’t generally tell directly which arguments are required; in general you’d need to look at the documentation. For example, <code>lm()</code> requires <code>formula</code> but not <code>data</code>, <code>subset</code>, etc., even though none of them have default arguments.</p>
<p>R will error out if it is expecting an argument, rather than looking for that argument elsewhere.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb350"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (..., na.rm = FALSE)  .Primitive("sum")</code></pre>
</div>
<div class="sourceCode cell-code" id="cb352"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb354"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(quantile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, ...) 
UseMethod("quantile")
&lt;bytecode: 0x55a129dfb1c8&gt;
&lt;environment: namespace:stats&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb356"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">quantile</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in is.factor(x) : argument "x" is missing, with no default</code></pre>
</div>
<div class="sourceCode cell-code" id="cb358"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb358-2"><a href="#cb358-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb358-3"><a href="#cb358-3" aria-hidden="true" tabindex="-1"></a>myfun <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb358-4"><a href="#cb358-4" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> y<span class="sc">+</span><span class="dv">3</span></span>
<span id="cb358-5"><a href="#cb358-5" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">&lt;-</span> x<span class="sc">+</span><span class="dv">3</span></span>
<span id="cb358-6"><a href="#cb358-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb358-7"><a href="#cb358-7" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">myfun</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in myfun() : argument "x" is missing, with no default</code></pre>
</div>
</div>
<p>You can check if an argument is missing with <code>missing()</code>. Arguments can also have default values, which may be <code>NULL</code>. If you are writing a function and designate the default as <code>argname = NULL</code>, you can check whether the user provided anything using <code>is.null(argname)</code>. The default values can also relate to other arguments. As an example, consider <em>dgamma</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb360"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="fu">args</span>(dgamma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, shape, rate = 1, scale = 1/rate, log = FALSE) 
NULL</code></pre>
</div>
</div>
<p>Functions may have unspecified arguments, which are designated using <code>...</code>. Unspecified arguments occurring at the beginning of the argument list are generally a collection of like objects that will be manipulated (consider <em>paste</em>, <em>c</em>, and <em>rbind</em>), while unspecified arguments occurring at the end are often optional arguments (consider <em>plot</em>). These optional arguments are sometimes passed along to a function within the function. For example, here’s my own wrapper for plotting, where any additional arguments specified by the user (such as <code>xlab</code> and <code>ylab</code>) will get passed along to plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb362"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a>pplot <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.4</span>, ...) {</span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(x, y, <span class="at">pch =</span> pch, <span class="at">cex =</span> cex, ...)</span>
<span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb362-4"><a href="#cb362-4" aria-hidden="true" tabindex="-1"></a><span class="fu">pplot</span>(<span class="fu">rnorm</span>(<span class="dv">10</span>), <span class="fu">rnorm</span>(<span class="dv">10</span>), <span class="at">xlab =</span> <span class="st">'x'</span>, <span class="at">ylab =</span> <span class="st">'y'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you want to manipulate what the user passed in as the <code>...</code> args, rather than just passing them along, you can extract them:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb363"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a>myFun <span class="ot">&lt;-</span> <span class="cf">function</span>(...){</span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(..<span class="dv">2</span>) </span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a>  args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(args[[<span class="dv">2</span>]])</span>
<span id="cb363-5"><a href="#cb363-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb363-6"><a href="#cb363-6" aria-hidden="true" tabindex="-1"></a><span class="fu">myFun</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3
[1] 3</code></pre>
</div>
</div>
<p>As we’ve seen, functions can be passed in as arguments (e.g., see the variants of <em>apply</em> and <em>lapply</em>). Note that one does not need to pass in a named function - you can create the function on the spot - this is called an <em>anonymous function</em> (also called a <em>lambda function</em> in some languages such as Python):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a>mylist <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">rnorm</span>(<span class="dv">2</span>), <span class="fu">rnorm</span>(<span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="dv">5</span>))</span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(mylist, length)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 3 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(mylist, <span class="cf">function</span>(x) x[x <span class="sc">&lt;</span> <span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] -0.1

[[2]]
[1] -0.0736 -0.0376 -0.6817

[[3]]
[1] -0.324 -0.589 -1.518</code></pre>
</div>
</div>
<p>We can see the arguments using <code>args()</code> and extract the arguments using <code>formals()</code>. <code>formals()</code> can be helpful if you need to manipulate the arguments.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb369"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">z =</span> <span class="dv">3</span> <span class="sc">/</span> y) { </span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">+</span> y <span class="sc">+</span> z </span>
<span id="cb369-3"><a href="#cb369-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb369-4"><a href="#cb369-4" aria-hidden="true" tabindex="-1"></a><span class="fu">args</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, y = 2, z = 3/y) 
NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb371"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="fu">formals</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$x


$y
[1] 2

$z
3/y</code></pre>
</div>
</div>
<p><em>match.call()</em> will show the user-suppled arguments explicitly matched to named arguments.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb373"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="fu">match.call</span>(<span class="at">definition =</span> mean, </span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">call =</span> <span class="fu">quote</span>(<span class="fu">mean</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>mean(x = y, na.rm = TRUE)</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p><strong>Challenge</strong> In the above code, what do you think <code>quote()</code>does? Why is it needed?</p>
</blockquote>
<section id="where-are-arguments-evaluated" class="level4">
<h4 class="anchored" data-anchor-id="where-are-arguments-evaluated">Where are arguments evaluated?</h4>
<p>User-supplied arguments are evaluated in the calling frame (why?), while default arguments are evaluated in the frame of the function (why?):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb375"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb375-3"><a href="#cb375-3" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">y =</span> x<span class="sc">*</span><span class="dv">3</span>) {x<span class="sc">+</span>y}</span>
<span id="cb375-4"><a href="#cb375-4" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(z<span class="sc">*</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 60</code></pre>
</div>
</div>
<p>Here, when <code>f()</code> is called and the code is evaluated, <code>z</code> is evaluated in the calling frame and <code>z*5</code> is assigned to <code>x</code> in the frame of the function, while <code>x*3</code> is evaluated in the frame of the function (using the local <code>x</code> that was just created) and assigned to <code>y</code>.</p>
</section>
</section>
<section id="function-outputs" class="level3">
<h3 class="anchored" data-anchor-id="function-outputs">Function outputs</h3>
<p><code>return(x)</code> will specify <code>x</code> as the output of the function. By default, if <code>return()</code> is not specified, the output is the result of the last evaluated statement. <code>return()</code> can occur anywhere in the function, and allows the function to exit as soon as it is done.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb377"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) { </span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(x <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb377-3"><a href="#cb377-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="sc">-</span>x<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb377-4"><a href="#cb377-4" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> res <span class="ot">&lt;-</span> x<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb377-5"><a href="#cb377-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb377-6"><a href="#cb377-6" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="sc">-</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb379"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="dv">3</span>)</span>
<span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">f</span>(<span class="dv">3</span>)</span>
<span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9</code></pre>
</div>
</div>
<p><code>invisible(x)</code> will return <code>x</code> and the result can be assigned in the calling environment but it will not be printed if not assigned:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb381"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x){ </span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(x<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb381-3"><a href="#cb381-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb381-4"><a href="#cb381-4" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="dv">3</span>)</span>
<span id="cb381-5"><a href="#cb381-5" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">f</span>(<span class="dv">3</span>)</span>
<span id="cb381-6"><a href="#cb381-6" aria-hidden="true" tabindex="-1"></a>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9</code></pre>
</div>
</div>
<p>A function can only return a single object (unlike Matlab, e.g.), but of course we can tack things together as a list and return that, as occurs with many functions, such as <em>lm</em>. (Of course <code>lm()</code> actually returns an object of the S3 <code>lm</code> class, which inherits from the list class.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb383"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> cyl, <span class="at">data =</span> mtcars)</span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "lm"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb385"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb385-1"><a href="#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is.list</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
</section>
<section id="pass-by-value-vs.-pass-by-reference" class="level2">
<h2 class="anchored" data-anchor-id="pass-by-value-vs.-pass-by-reference">Pass by value vs.&nbsp;pass by reference</h2>
<p>When talking about programming languages, one often distinguishes <em>pass-by-value</em> and <em>pass-by-reference</em>.</p>
<p><em>Pass-by-value</em> means that when a function is called with one or more arguments, a copy is made of each argument and the function operates on those copies.</p>
<p><em>Pass-by-reference</em> means that the arguments are not copied, but rather that information is passed allowing the function to find and modify the original value of the objects passed into the function.</p>
<p>In pass-by-value, changes to an argument made within a function do not affect the value of the argument in the calling environment. In pass-by-reference changes inside a function do affect the object outside of the function. R is (roughly) pass-by-value. R’s designers chose not to allow pass-by-reference because they didn’t like the idea that a function could have the side effect of changing an object. However, passing by reference can sometimes be very helpful, and we’ll see ways of passing by reference later (and also note our discussion of R6 classes).</p>
<p>Pass-by-value is elegant and modular in that functions do not have side effects - the effect of the function occurs only through the return value of the function. However, it can be inefficient in terms of the amount of computation and of memory used. In contrast, pass-by-reference is more efficient, but also more dangerous and less modular. It’s more difficult to reason about code that uses pass-by-reference because effects of calling a function can be hidden inside the function. Thus pass-by-value is directly related to functional programming.</p>
<p>Arrays in Python are pass-by-reference (but note that tuples are immutable, so one could not modify a tuple that is passed as an argument).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb387"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb387-1"><a href="#cb387-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun(x):</span>
<span id="cb387-2"><a href="#cb387-2" aria-hidden="true" tabindex="-1"></a>    x[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">99</span></span>
<span id="cb387-3"><a href="#cb387-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb387-4"><a href="#cb387-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb387-5"><a href="#cb387-5" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> myfun(y)</span>
<span id="cb387-6"><a href="#cb387-6" aria-hidden="true" tabindex="-1"></a>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0, 99, 2]</code></pre>
</div>
</div>
<section id="pointers" class="level3">
<h3 class="anchored" data-anchor-id="pointers">Pointers</h3>
<p>By way of contrast to a pass-by-value system, I want to briefly discuss the idea of a pointer, common in compiled languages such as C.</p>
<pre><code>int x = 3;
int* ptr;
ptr = &amp;x;
*ptr * 7; // returns 21</code></pre>
<ul>
<li>The <code>int*</code> declares <code>ptr</code> to be a pointer to (the address of) the integer <code>x</code>.</li>
<li>The <code>&amp;x</code> gets the address where <code>x</code> is stored.</li>
<li><code>*ptr</code> dereferences <code>ptr</code>, returning the value in that address (which is 3 since <code>ptr</code> is the address of <code>x</code>.</li>
</ul>
<p>Vectors in C are really pointers to a block of memory:</p>
<pre><code>int x[10];</code></pre>
<p>In this case <code>x</code> will be the address of the first element of the vector. We can access the first element as <code>x[0]</code> or <code>*x</code>.</p>
<p>Why have we gone into this? In C, you can pass a pointer as an argument to a function. The result is that only the scalar address is copied and not the entire object, and inside the function, one can modify the original object, with the new value persisting on exit from the function. For example in the following example one passes in the address of an object and that object is then modified in place, affecting its value when the function call finishes.</p>
<pre><code>int myCal(int* ptr){
    *ptr = *ptr + *ptr;
}

myCal(&amp;x)  # x itself will be modified</code></pre>
<blockquote class="blockquote">
<p><strong>Note</strong> When calling C or C++ from R, one (implicitly) passes pointers to the vectors into C.</p>
</blockquote>
</section>
<section id="pointers-in-r" class="level3">
<h3 class="anchored" data-anchor-id="pointers-in-r">Pointers in R?</h3>
<p>Are there pointers in R? From a user perspective, one might say ‘no’, because an R programmer can’t use pointers explicitly. But pointer-like behavior is occurring behind the scenes in lots of ways:</p>
<ul>
<li>Lists in R are essentially vectors of pointers to the elements of the list.</li>
<li>Character vectors in R are essentially pointers to the individual character strings.</li>
<li>Environments behave like pointers and are passed by reference rather than by copy.</li>
<li>R6 objects behave like pointers and are passed by reference, as seen earlier.</li>
</ul>
<p>We’ll see more on these ideas later in the Unit.</p>
</section>
<section id="alternatives-to-pass-by-value-in-r" class="level3">
<h3 class="anchored" data-anchor-id="alternatives-to-pass-by-value-in-r">Alternatives to pass by value in R</h3>
<p>There are occasions we do not want to pass by value. In addition to avoiding copies and the computation and memory use that that causes, another reason is when we want a function to modify a complicated object without having to return it and re-assign it in the parent environment. There are several work-arounds:</p>
<ol type="1">
<li>We can use R6 (or Reference Class) objects.</li>
<li>We can use a <em>closure</em>, as discussed later.</li>
<li>We can access the object in the enclosing environment as a ‘global variable’, as we’ll see when discussing scoping. More generally we can access the object using <code>get()</code>, specifying the environment from which we want to obtain the variable. To specify the location of an object when using <code>get()</code>, we can generally specify (1) a position in the search path, (2) an explicit environment, or (3) a location in the call stack by using <code>sys.frame()</code>. However we cannot change the value of the object in the parent environment without some additional tools:
<ol type="a">
<li>We can use the <code>&lt;&lt;-</code> operator to assign into an object in the enclosing environment (provided an object of that name exists in the enclosing environment). We’ll discuss enclosing environments when we talk about scoping.</li>
<li>We can also use <code>assign()</code>, specifying the environment in which we want the assignment to occur. While these techniques are possible and ok for exploratory coding, they’re generally bad practice for more formal code development.</li>
</ol></li>
<li>We can use replacement functions, which hide the reassignment in the parent environment from the user. Note that a second copy is generally created in this case, but the original copy is quickly removed.</li>
</ol>
</section>
<section id="promises-and-lazy-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="promises-and-lazy-evaluation">Promises and lazy evaluation</h3>
<p>In actuality, R is not quite pass-by-value; rather it is <em>call-by-value</em>. Copying of arguments is delayed in two ways:</p>
<ul>
<li>The first is the idea of <em>promises</em>, described next. Promises are an example of a general programming concept called <em>lazy evaluation</em>.</li>
<li>The second is the idea of <em>copy-on-modify</em>, described in more detail later. Basically, with copy-on-modify, copies of arguments are only made if the argument is changed within the function. Until then the object in the function just refers back to the original object.</li>
</ul>
<p>Let’s see what a <em>promise</em> object is. In function calls, when R matches user input arguments to formal argument names, it does not (usually) evaluate the arguments until they are needed, which is called <em>lazy evaluation</em>. Instead the formal arguments are of a special type called a <em>promise</em>. Let’s see lazy evaluation in action.</p>
<p>What’s strange about this?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb392"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">print</span>(<span class="st">"hi"</span>)</span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">mean</span>(<span class="fu">rnorm</span>(<span class="dv">1000000</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.056   0.004   0.060 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb394"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb394-1"><a href="#cb394-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">f</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "hi"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.000   0.000   0.001 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb397"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">f</span>(<span class="fu">mean</span>(<span class="fu">rnorm</span>(<span class="dv">1000000</span>)))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "hi"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.001   0.000   0.001 </code></pre>
</div>
</div>
<p>Here’s an even stranger situation. Do you think the following code will run?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb400"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(a, <span class="at">b =</span> d) {</span>
<span id="cb400-2"><a href="#cb400-2" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> a<span class="sc">*</span><span class="dv">3</span>; </span>
<span id="cb400-3"><a href="#cb400-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(a<span class="sc">*</span>b)</span>
<span id="cb400-4"><a href="#cb400-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb400-5"><a href="#cb400-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-6"><a href="#cb400-6" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb400-7"><a href="#cb400-7" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lazy evaluation is not just an R thing. It also occurs in Tensorflow (particularly version 1), the Python Dask package, and in Spark. The basic idea is to delay executation until it’s really needed, with the goal that if one does so, the system may be able to better optimize a series of multiple steps as a joint operation relative to executing them one by one.</p>
</section>
</section>
<section id="variable-scope-and-lookup" class="level2">
<h2 class="anchored" data-anchor-id="variable-scope-and-lookup">Variable scope and lookup</h2>
<section id="lexical-scoping" class="level3">
<h3 class="anchored" data-anchor-id="lexical-scoping">Lexical scoping</h3>
<p>In this section, we seek to understand what happens in the following circumstance. Namely, where does R get the value for the object <code>x</code>?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb401"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(y) {</span>
<span id="cb401-2"><a href="#cb401-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x <span class="sc">+</span> y)</span>
<span id="cb401-3"><a href="#cb401-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb401-4"><a href="#cb401-4" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 103</code></pre>
</div>
</div>
<p>To consider variable scope, we need to define the terms <em>environment</em> and <em>frame</em>. Environments and frames are closely related.</p>
<ul>
<li>A <em>frame</em> is a collection of named objects.</li>
<li>An <em>environment</em> is a frame, with a pointer to the ‘enclosing environment’, i.e., the next environment to look for something in. (Be careful as this is different than the parent frame of a function, discussed when we were talking about the call stack.)</li>
</ul>
<p>Variables in the enclosing environment (also called the parent environment) are available within a function. This is the analog of <em>global variables</em> in other languages. <strong>The enclosing environment is the environment in which a function is defined, not the environment from which a function is called.</strong></p>
<p>This approach is called <em>lexical scoping</em>. Python and many other languages also use lexical scoping.</p>
<p>Why is the enclosing environment defined in this way? Recall our example where I tried to break the usage of the <em>lm</em> function by redefining <em>lm.fit</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb403"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a>lm.fit <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">print</span>(<span class="st">'hi'</span>)</span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb403-3"><a href="#cb403-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb403-4"><a href="#cb403-4" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>x)  <span class="co"># this still works!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When R looks for <code>lm.fit</code> when it is called within <code>lm</code>, it looks in the enclosing environment of <code>lm</code>. That is where <code>lm</code> is defined, which is the stats package namespace. It finds <code>lm.fit</code> there. All is well! In contrast, if the scoping rules looked for <code>lm.fit</code> where <code>lm</code> was called from, then the user-defined <code>lm.fit</code> would be found and <code>lm()</code> would not work until that <code>lm.fit</code> was removed. That would be a very fragile system!</p>
<p>Let’s dig deeper to understand where R looks for non-local variables, illustrating lexical scoping:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb404"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">print</span>(x)</span>
<span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb404-5"><a href="#cb404-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f2</span>()</span>
<span id="cb404-6"><a href="#cb404-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb404-7"><a href="#cb404-7" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>() <span class="co"># what will happen?</span></span>
<span id="cb404-8"><a href="#cb404-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-9"><a href="#cb404-9" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb404-10"><a href="#cb404-10" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">print</span>(x)</span>
<span id="cb404-11"><a href="#cb404-11" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb404-12"><a href="#cb404-12" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb404-13"><a href="#cb404-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f2</span>()</span>
<span id="cb404-14"><a href="#cb404-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb404-15"><a href="#cb404-15" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb404-16"><a href="#cb404-16" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>() <span class="co"># what will happen?</span></span>
<span id="cb404-17"><a href="#cb404-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-18"><a href="#cb404-18" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb404-19"><a href="#cb404-19" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb404-20"><a href="#cb404-20" aria-hidden="true" tabindex="-1"></a>    f2 <span class="ot">&lt;-</span> <span class="cf">function</span>() { <span class="fu">print</span>(x) }</span>
<span id="cb404-21"><a href="#cb404-21" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb404-22"><a href="#cb404-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f2</span>()</span>
<span id="cb404-23"><a href="#cb404-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb404-24"><a href="#cb404-24" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>() <span class="co"># what will happen?</span></span>
<span id="cb404-25"><a href="#cb404-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-26"><a href="#cb404-26" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb404-27"><a href="#cb404-27" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() { </span>
<span id="cb404-28"><a href="#cb404-28" aria-hidden="true" tabindex="-1"></a>    f2 <span class="ot">&lt;-</span> <span class="cf">function</span>() { <span class="fu">print</span>(x) }</span>
<span id="cb404-29"><a href="#cb404-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f2</span>()</span>
<span id="cb404-30"><a href="#cb404-30" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb404-31"><a href="#cb404-31" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>() <span class="co"># what will happen?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s a tricky example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb405"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb405-1"><a href="#cb405-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb405-2"><a href="#cb405-2" aria-hidden="true" tabindex="-1"></a>fun_constructor <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb405-3"><a href="#cb405-3" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb405-4"><a href="#cb405-4" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb405-5"><a href="#cb405-5" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(x <span class="sc">+</span> y)</span>
<span id="cb405-6"><a href="#cb405-6" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb405-7"><a href="#cb405-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(g)</span>
<span id="cb405-8"><a href="#cb405-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb405-9"><a href="#cb405-9" aria-hidden="true" tabindex="-1"></a><span class="do">## fun_constructor() creates functions</span></span>
<span id="cb405-10"><a href="#cb405-10" aria-hidden="true" tabindex="-1"></a>myfun <span class="ot">&lt;-</span> <span class="fu">fun_constructor</span>()</span>
<span id="cb405-11"><a href="#cb405-11" aria-hidden="true" tabindex="-1"></a><span class="fu">myfun</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 13</code></pre>
</div>
</div>
<p>Let’s work through this:</p>
<ol type="1">
<li>What is the enclosing environment of the function <em>g()</em>?</li>
<li>What does <em>g()</em> use for <em>y</em>?</li>
<li>When <em>fun_constructor()</em> finishes, does its environment disappear? What would happen if it did?</li>
<li>What is the enclosing environment of <em>myfun()</em>?</li>
</ol>
<p>The following code helps explain things, but it’s a bit confusing because <code>environment()</code> gives back different results depending on whether it is given a function as its argument. If given a function, it returns the enclosing environment for that function. If given no argument, it returns the current execution environment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb407"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a><span class="fu">environment</span>(myfun)  <span class="co"># enclosing environment of h()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;environment: 0x55a134e2e488&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb409"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>(<span class="fu">environment</span>(myfun)) <span class="co"># objects in that environment</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "g" "y"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb411"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a>fun_constructor <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb411-2"><a href="#cb411-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">environment</span>()) <span class="co"># execution environment of fun_constructor()</span></span>
<span id="cb411-3"><a href="#cb411-3" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb411-4"><a href="#cb411-4" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x <span class="sc">+</span> y</span>
<span id="cb411-5"><a href="#cb411-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(g)</span>
<span id="cb411-6"><a href="#cb411-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb411-7"><a href="#cb411-7" aria-hidden="true" tabindex="-1"></a>myfun <span class="ot">&lt;-</span> <span class="fu">fun_constructor</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;environment: 0x55a133f25430&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb413"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="fu">environment</span>(myfun)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;environment: 0x55a133f25430&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb415"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a><span class="fu">myfun</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 13</code></pre>
</div>
<div class="sourceCode cell-code" id="cb417"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a><span class="fu">environment</span>(myfun)<span class="sc">$</span>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb419"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a><span class="do">## advanced: explain this:</span></span>
<span id="cb419-2"><a href="#cb419-2" aria-hidden="true" tabindex="-1"></a><span class="fu">environment</span>(myfun)<span class="sc">$</span>g</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function(x) x + y
&lt;environment: 0x55a133f25430&gt;</code></pre>
</div>
</div>
<p>Be careful when using variables from the enclosing environment as the value of that variable in the enclosing environment may well not be what you expect it to be. In general it’s bad practice to use variables that are taken from environments outside that of a function, but in some cases it can be useful. Here are some examples of using variables outside of the frame of a function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb421"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb421-2"><a href="#cb421-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() {x <span class="ot">&lt;-</span> x<span class="sc">^</span><span class="dv">2</span>; <span class="fu">print</span>(x)}</span>
<span id="cb421-3"><a href="#cb421-3" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>()</span>
<span id="cb421-4"><a href="#cb421-4" aria-hidden="true" tabindex="-1"></a>x <span class="co"># what do you expect?</span></span>
<span id="cb421-5"><a href="#cb421-5" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() { <span class="fu">assign</span>(<span class="st">'x'</span>, x<span class="sc">^</span><span class="dv">2</span>, <span class="at">env =</span> .GlobalEnv) } </span>
<span id="cb421-6"><a href="#cb421-6" aria-hidden="true" tabindex="-1"></a><span class="do">## careful: could be dangerous as a variable is changed as a side effect</span></span>
<span id="cb421-7"><a href="#cb421-7" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>()</span>
<span id="cb421-8"><a href="#cb421-8" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb421-9"><a href="#cb421-9" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) { x <span class="ot">&lt;&lt;-</span> x<span class="sc">^</span><span class="dv">2</span> }</span>
<span id="cb421-10"><a href="#cb421-10" aria-hidden="true" tabindex="-1"></a><span class="do">## careful: could be dangerous as a variable is changed as a side effect</span></span>
<span id="cb421-11"><a href="#cb421-11" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(<span class="dv">5</span>)</span>
<span id="cb421-12"><a href="#cb421-12" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="comprehension-problem" class="level4">
<h4 class="anchored" data-anchor-id="comprehension-problem">Comprehension problem</h4>
<p>Here’s a case where something I tried failed and I had to think more carefully about scoping to understand why.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb422"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>) </span>
<span id="cb422-2"><a href="#cb422-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rnorm</span>(<span class="dv">1</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.626</code></pre>
</div>
<div class="sourceCode cell-code" id="cb424"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(.Random.seed, <span class="at">file =</span> <span class="st">'tmp.Rda'</span>) </span>
<span id="cb424-2"><a href="#cb424-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rnorm</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.184</code></pre>
</div>
<div class="sourceCode cell-code" id="cb426"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="cf">function</span>() { </span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">'tmp.Rda'</span>) </span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>)) </span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tmp</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.836</code></pre>
</div>
</div>
<p>Question: what was I hoping that code to do, and why didn’t it work?</p>
</section>
<section id="detecting-non-local-variables" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="detecting-non-local-variables">Detecting non-local variables</h4>
<p>We can use <code>codetools::findGlobals()</code> to detect non-local variables when we are programming.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb428"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb428-3"><a href="#cb428-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(x <span class="sc">+</span> y)</span>
<span id="cb428-4"><a href="#cb428-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb428-5"><a href="#cb428-5" aria-hidden="true" tabindex="-1"></a>codetools<span class="sc">::</span><span class="fu">findGlobals</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "{"     "+"     "&lt;-"    "print" "x"    </code></pre>
</div>
</div>
<p>Is that result what you would expect? What does it say about my statement that using non-local variables is a bad idea?</p>
</section>
</section>
<section id="closures" class="level3">
<h3 class="anchored" data-anchor-id="closures">Closures</h3>
<p>One way to avoid passing data by value is to associate data with a function, using a <em>closure</em>. This is a functional programming way to achieve something like an OOP class. This <a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">Wikipedia entry</a> nicely summarizes the idea, which is a general functional programming idea and not specific to R.</p>
<p>Using a closure involves creating one (or more functions) within a function call and returning the function(s) as the output. When one executes the original function, the new function(s) is created and returned and one can then call that new function(s). The new function then can access objects in the enclosing environment (the environment of the original function) and can use <code>&lt;&lt;-</code> to assign into the enclosing environment, to which the function (or the multiple functions) have access. The nice thing about this compared to using a global variable is that the data in the closure is bound up with the function(s) and is protected from being changed by the user of the closure. Chambers provides an example of this in Sec. 5.4.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb430"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb430-1"><a href="#cb430-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb430-2"><a href="#cb430-2" aria-hidden="true" tabindex="-1"></a>scaler_constructor <span class="ot">&lt;-</span> <span class="cf">function</span>(input){</span>
<span id="cb430-3"><a href="#cb430-3" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> input</span>
<span id="cb430-4"><a href="#cb430-4" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="cf">function</span>(param) <span class="fu">return</span>(param <span class="sc">*</span> data) </span>
<span id="cb430-5"><a href="#cb430-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(g)</span>
<span id="cb430-6"><a href="#cb430-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb430-7"><a href="#cb430-7" aria-hidden="true" tabindex="-1"></a>scaler <span class="ot">&lt;-</span> <span class="fu">scaler_constructor</span>(x)</span>
<span id="cb430-8"><a href="#cb430-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x) <span class="co"># to demonstrate we no longer need x</span></span>
<span id="cb430-9"><a href="#cb430-9" aria-hidden="true" tabindex="-1"></a><span class="fu">scaler</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  4.786  0.989 -2.461  1.462  2.215  1.727 -0.916  4.535  1.170 -1.864</code></pre>
</div>
</div>
<p>So calling <code>scaler(3)</code> multiplies 3 by the value of <code>data</code> stored in the closure (the enclosing environment) of the function <code>scaler</code>.</p>
<p>It turns out that it can be hard to see the memory used involved in the closure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb432"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>)</span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="ot">&lt;-</span> <span class="fu">scaler_constructor</span>(x)</span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(scaler) <span class="co"># hmmm</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3800 bytes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb434"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(<span class="fu">environment</span>(scaler)<span class="sc">$</span>data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80000048 bytes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb436"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'pryr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked _by_ '.GlobalEnv':

    f</code></pre>
</div>
<div class="sourceCode cell-code" id="cb439"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb439-1"><a href="#cb439-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object_size</span>(scaler) <span class="co"># that's better!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80,012,560 B</code></pre>
</div>
</div>
<p>Here’s a fun example. You might do this with an <em>apply</em> variant, in particular <em>replicate</em>, but this is slick:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb441"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb441-1"><a href="#cb441-1" aria-hidden="true" tabindex="-1"></a>make_container <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb441-2"><a href="#cb441-2" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb441-3"><a href="#cb441-3" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb441-4"><a href="#cb441-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb441-5"><a href="#cb441-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(<span class="at">value =</span> <span class="cn">NULL</span>) {</span>
<span id="cb441-6"><a href="#cb441-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.null</span>(value)) {</span>
<span id="cb441-7"><a href="#cb441-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(x)</span>
<span id="cb441-8"><a href="#cb441-8" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb441-9"><a href="#cb441-9" aria-hidden="true" tabindex="-1"></a>            x[i] <span class="ot">&lt;&lt;-</span> value</span>
<span id="cb441-10"><a href="#cb441-10" aria-hidden="true" tabindex="-1"></a>            i <span class="ot">&lt;&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb441-11"><a href="#cb441-11" aria-hidden="true" tabindex="-1"></a>        }    </span>
<span id="cb441-12"><a href="#cb441-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb441-13"><a href="#cb441-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb441-14"><a href="#cb441-14" aria-hidden="true" tabindex="-1"></a>nboot <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb441-15"><a href="#cb441-15" aria-hidden="true" tabindex="-1"></a>bootmeans <span class="ot">&lt;-</span> <span class="fu">make_container</span>(nboot)</span>
<span id="cb441-16"><a href="#cb441-16" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> faithful[ , <span class="dv">1</span>] <span class="co"># Old Faithful geyser eruption lengths</span></span>
<span id="cb441-17"><a href="#cb441-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nboot)</span>
<span id="cb441-18"><a href="#cb441-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bootmeans</span>(<span class="fu">mean</span>(<span class="fu">sample</span>(data, <span class="fu">length</span>(data),</span>
<span id="cb441-19"><a href="#cb441-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">replace=</span><span class="cn">TRUE</span>)))</span>
<span id="cb441-20"><a href="#cb441-20" aria-hidden="true" tabindex="-1"></a><span class="fu">bootmeans</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] 3.59 3.41 3.47 3.46 3.43 3.48 3.51 3.48 3.50 3.46 3.41 3.62 3.46 3.46 3.49
 [16] 3.50 3.56 3.50 3.58 3.60 3.46 3.45 3.50 3.41 3.46 3.59 3.35 3.50 3.51 3.37
 [31] 3.46 3.38 3.58 3.52 3.45 3.58 3.50 3.47 3.54 3.57 3.53 3.58 3.40 3.50 3.50
 [46] 3.56 3.41 3.45 3.50 3.53 3.49 3.57 3.46 3.50 3.43 3.48 3.54 3.45 3.53 3.53
 [61] 3.46 3.36 3.41 3.58 3.58 3.47 3.51 3.50 3.56 3.48 3.39 3.48 3.62 3.54 3.51
 [76] 3.52 3.47 3.49 3.43 3.45 3.40 3.52 3.43 3.49 3.51 3.56 3.55 3.46 3.30 3.56
 [91] 3.47 3.49 3.41 3.40 3.46 3.43 3.43 3.44 3.45 3.42</code></pre>
</div>
</div>
<p>The closure stores the bootstrapped values and</p>
</section>
<section id="environments-and-the-search-path" class="level3">
<h3 class="anchored" data-anchor-id="environments-and-the-search-path">Environments and the search path</h3>
<p>So far we’ve seen lexical scoping in action primarily in terms of finding variables in a single enclosing environment. But what if the variable is not found in either the frame/environment of the function or the enclosing environment? When R goes looking for an object (in the form of a symbol), it starts in the current environment (e.g., the frame/environment of a function) and then runs up through the enclosing environments, until it reaches the global environment, which is where R starts when you open R.</p>
<p>Then, if R can’t find the object when reaching the global environment, it runs through the search path, which you can see with <code>search()</code>. The search path is a set of additional environments, mainly the namespaces of packages loaded in the R session.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb443"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a><span class="fu">search</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] ".GlobalEnv"          "package:pryr"        "package:R6"         
 [4] "package:fields"      "package:viridis"     "package:viridisLite"
 [7] "package:spam"        "package:dplyr"       "package:stringr"    
[10] "tools:quarto"        "package:stats"       "package:graphics"   
[13] "package:grDevices"   "package:utils"       "package:datasets"   
[16] "package:SCF"         "package:methods"     "Autoloads"          
[19] "package:base"       </code></pre>
</div>
</div>
<p>We can see the full set of environments in which R looks using code such as the following. This illustrates that in looking for a local variable used in <em>lm</em> the search process would go through the stats namespace, the base R namespace, the global environment and then the various packages loaded in the current R session.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb445"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">environment</span>(lm)</span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (<span class="fu">environmentName</span>(x) <span class="sc">!=</span> <span class="fu">environmentName</span>(<span class="fu">emptyenv</span>())) {</span>
<span id="cb445-3"><a href="#cb445-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">environmentName</span>(x))</span>
<span id="cb445-4"><a href="#cb445-4" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">parent.env</span>(x) <span class="co"># enclosing env't, NOT parent frame!</span></span>
<span id="cb445-5"><a href="#cb445-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "stats"
[1] "imports:stats"
[1] "base"
[1] "R_GlobalEnv"
[1] "package:pryr"
[1] "package:R6"
[1] "package:fields"
[1] "package:viridis"
[1] "package:viridisLite"
[1] "package:spam"
[1] "package:dplyr"
[1] "package:stringr"
[1] "tools:quarto"
[1] "package:stats"
[1] "package:graphics"
[1] "package:grDevices"
[1] "package:utils"
[1] "package:datasets"
[1] "package:SCF"
[1] "package:methods"
[1] "Autoloads"
[1] "base"</code></pre>
</div>
</div>
<p>That code uses <code>environmentName()</code>, which prints out a nice-looking version of the environment name.</p>
<p>Here’s an alternative way using <em>pryr</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb447"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb447-2"><a href="#cb447-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">environment</span>(lm)</span>
<span id="cb447-3"><a href="#cb447-3" aria-hidden="true" tabindex="-1"></a><span class="fu">parenvs</span>(x, <span class="at">all =</span> <span class="cn">TRUE</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   label                              name                 
1  &lt;environment: namespace:stats&gt;     ""                   
2  &lt;environment: 0x55a1285c3f68&gt;      "imports:stats"      
3  &lt;environment: namespace:base&gt;      ""                   
4  &lt;environment: R_GlobalEnv&gt;         ""                   
5  &lt;environment: package:pryr&gt;        "package:pryr"       
6  &lt;environment: package:R6&gt;          "package:R6"         
7  &lt;environment: package:fields&gt;      "package:fields"     
8  &lt;environment: package:viridis&gt;     "package:viridis"    
9  &lt;environment: package:viridisLite&gt; "package:viridisLite"
10 &lt;environment: package:spam&gt;        "package:spam"       
11 &lt;environment: package:dplyr&gt;       "package:dplyr"      
12 &lt;environment: package:stringr&gt;     "package:stringr"    
13 &lt;environment: 0x55a128302158&gt;      "tools:quarto"       
14 &lt;environment: package:stats&gt;       "package:stats"      
15 &lt;environment: package:graphics&gt;    "package:graphics"   
16 &lt;environment: package:grDevices&gt;   "package:grDevices"  
17 &lt;environment: package:utils&gt;       "package:utils"      
18 &lt;environment: package:datasets&gt;    "package:datasets"   
19 &lt;environment: package:SCF&gt;         "package:SCF"        
20 &lt;environment: package:methods&gt;     "package:methods"    
21 &lt;environment: 0x55a128326510&gt;      "Autoloads"          
22 &lt;environment: base&gt;                ""                   
23 &lt;environment: R_EmptyEnv&gt;          ""                   </code></pre>
</div>
</div>
<p>Note that eventually the global environment and the environments of the packages are nested within the base environment (of the base package) and the empty environment.</p>
</section>
</section>
</section>
<section id="memory-and-copies" class="level1">
<h1>8. Memory and copies</h1>
<section id="overview-2" class="level2">
<h2 class="anchored" data-anchor-id="overview-2">Overview</h2>
<p>The main things to remember when thinking about memory use are: (1) numeric vectors take 8 bytes per element and (2) we need to keep track of when large objects are created, including local variables in the frames of functions.</p>
<p>In some of our work here we’ll use functions from the <em>pryr</em> package, which provides functions to help understand what is going on under the hood in R.</p>
<p><strong>In general, don’t try to run this code within RStudio, as some of how RStudio works affects when copies are made. In particular the environment pane causes there to be an additional reference to each object. Also, as noted in the document, some of the output in the PDF does not reflect what is happening when running code directly within R, because of effects from the process of rendering the document.</strong></p>
<section id="allocating-and-freeing-memory" class="level3">
<h3 class="anchored" data-anchor-id="allocating-and-freeing-memory">Allocating and freeing memory</h3>
<p>Unlike compiled languages like C, in R we do not need to explicitly allocate storage for objects. (However, we will see that there are times that we do want to allocate storage in advance, rather than successively concatenating onto a larger object.)</p>
<p>R automatically manages memory, releasing memory back to the operating system when it’s not needed via garbage collection. Very occasionally you may want to remove large objects as soon as they are not needed. <code>rm()</code> does not actually free up memory, it just disassociates the name from the memory used to store the object. In general R will quickly clean up such objects without a reference (i.e., a name), so there is generally no need to call <code>gc()</code> to force the garbage collection. In particular, calling <code>gc()</code> uses some computation so it’s generally not recommended.</p>
<p>In a language like C in which the user allocates and frees up memory, memory leaks are a major cause of bugs. Basically if you are looping and you allocate memory at each iteration and forget to free it, the memory use builds up inexorably and eventually the machine runs out of memory. In R, with automatic garbage collection, this is generally not an issue, but occasionally memory leaks do occur.</p>
</section>
<section id="the-heap-and-the-stack" class="level3">
<h3 class="anchored" data-anchor-id="the-heap-and-the-stack">The heap and the stack</h3>
<p>The <em>heap</em> is the memory that is available for dynamically creating new objects while a program is executing, e.g., if you create a new object in R or call <em>new</em> in C++. When more memory is needed the program can request more from the operating system. When objects are removed in R, R will handle the garbage collection of releasing that memory.</p>
<p>The <em>stack</em> is the memory used for local variables when a function is called.</p>
<p>There’s a nice discussion of this on <a href="https://stackoverflow.com/questions/79923/what-and-where-are-the-stack-and-heap">this Stack Overflow thread</a>.</p>
</section>
</section>
<section id="monitoring-memory-use" class="level2">
<h2 class="anchored" data-anchor-id="monitoring-memory-use">Monitoring memory use</h2>
<section id="monitoring-overall-memory-use-on-a-unix-style-computer" class="level3">
<h3 class="anchored" data-anchor-id="monitoring-overall-memory-use-on-a-unix-style-computer">Monitoring overall memory use on a UNIX-style computer</h3>
<p>To understand how much memory is available on your computer, one needs to have a clear understanding of disk caching. The operating system will generally cache files/data in memory when it reads from disk. Then if that information is still in memory the next time it is needed, it will be much faster to access it the second time around than if it had to read the information from disk. While the cached information is using memory, that same memory is immediately available to other processes, so the memory is available even though it is “in use”.</p>
<p>We can see this via <code>free -h</code> (the <code>-h</code> is for ‘human-readable’, i.e. show in GB (G)) on Linux machine.</p>
<pre><code>          total used free shared buff/cache available 
    Mem:   251G 998M 221G   2.6G        29G      247G 
    Swap:  7.6G 210M 7.4G</code></pre>
<p>You’ll generally be interested in the <code>Mem</code> row. (See below for some comments on <code>Swap</code>.) The <code>shared</code> column is complicated and probably won’t be of use to you. The <code>buff/cache</code> column shows how much space is used for disk caching and related purposes but is actually available. Hence the <code>available</code> column is the sum of the <code>free</code> and <code>buff/cache</code> columns (more or less). In this case only about 1 GB is in use (indicated in the <code>used</code> column).</p>
<p><code>top</code> (Linux or Mac) and <code>vmstat</code> (on Linux) both show overall memory use, but remember that the amount actually available to you is the amount free plus any buff/cache usage. Here is some example output from <code>vmstat</code>:</p>
<pre><code>
    procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu----- 
    r b   swpd      free   buff    cache si so bi bo in cs us sy id wa st 
    1 0 215140 231655120 677944 30660296  0  0  1  2  0  0 18  0 82  0  0</code></pre>
<p>It shows 232 GB free and 31 GB used for cache and therefore available, for a total of 263 GB available.</p>
<p>Here are some example lines from <code>top</code>:</p>
<pre><code>    KiB Mem : 26413715+total, 23180236+free, 999704 used, 31335072 buff/cache 
    KiB Swap:  7999484 total,  7784336 free, 215148 used. 25953483+avail Mem</code></pre>
<p>We see that this machine has 264 GB RAM (the total column in the <code>Mem</code> row), with 259.5 GB available (232 GB free plus 31 GB buff/cache as seen in the <code>Mem</code> row). (I realize the numbers don’t quite add up for reasons I don’t fully understand, but we probably don’t need to worry about that degree of exactness.) Only 1 GB is in use.</p>
<p><em>Swap</em> is essentially the reverse of disk caching. It is disk space that is used for memory when the machine runs out of physical memory. You never want your machine to be using swap for memory because your jobs will slow to a crawl. As seen above, the <code>swap</code> line in both <code>free</code> and <code>top</code> shows 8 GB swap space, with very little in use, as desired.</p>
</section>
<section id="monitoring-memory-use-in-r" class="level3">
<h3 class="anchored" data-anchor-id="monitoring-memory-use-in-r">Monitoring memory use in R</h3>
<p>There are a number of ways to see how much memory is being used. When R is actively executing statements, you can use <code>top</code> from the UNIX shell. In R, you can use <code>gc()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb452"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb452-1"><a href="#cb452-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2348908  126    4160798  222  4160798  222
Vcells 14243782  109   23089362  176 14790823  113</code></pre>
</div>
</div>
<p><code>gc()</code> reports memory use and free memory as <code>Ncells</code> and <code>Vcells</code>. <code>Ncells</code> concerns the overhead of running R and <code>Vcells</code> relates to objects created by the user, so you’ll want to focus on <code>Vcells</code>. You can see the number of Mb currently used (the “<code>used</code>” column of the output) and the maximum used in the session (the “<code>max used</code>” column)“.</p>
<p>We can see the size of an object with <code>object.size()</code> from base R or <code>object_size</code> from pryr:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb454"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb454-1"><a href="#cb454-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e8</span>) <span class="co"># should use about 800 Mb</span></span>
<span id="cb454-2"><a href="#cb454-2" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>800000048 bytes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb456"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb456-1"><a href="#cb456-1" aria-hidden="true" tabindex="-1"></a>pryr<span class="sc">::</span><span class="fu">object_size</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>800,000,048 B</code></pre>
</div>
</div>
<p>A newer alternative to <code>gc()</code> is to use functions in the <code>pryr</code> package such as <code>mem_used()</code> and <code>mem_change()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb458"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb458-1"><a href="#cb458-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb458-2"><a href="#cb458-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.05 GB</code></pre>
</div>
<div class="sourceCode cell-code" id="cb460"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb460-1"><a href="#cb460-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells 2.35e+06  126   4.16e+06  222 4.16e+06  222
Vcells 1.14e+08  872   1.67e+08 1275 1.14e+08  872</code></pre>
</div>
<div class="sourceCode cell-code" id="cb462"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb462-1"><a href="#cb462-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x)</span>
<span id="cb462-2"><a href="#cb462-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>246 MB</code></pre>
</div>
<div class="sourceCode cell-code" id="cb464"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb464-1"><a href="#cb464-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>() <span class="co"># note the "max used" column is unchanged</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2350245  126   4.16e+06  222 4.16e+06  222
Vcells 14247267  109   1.07e+08  816 1.14e+08  872</code></pre>
</div>
<div class="sourceCode cell-code" id="cb466"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb466-1"><a href="#cb466-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_change</span>(x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e8</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>800 MB</code></pre>
</div>
<div class="sourceCode cell-code" id="cb468"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb468-1"><a href="#cb468-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_change</span>(x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-720 MB</code></pre>
</div>
</div>
<p>You can reset the value given for <code>max used</code>, with <code>gc(reset = TRUE)</code>.</p>
<p>In Windows only, <code>memory.size()</code> tells how much memory is being used.</p>
<p>Here is a useful function, <code>ls_sizes()</code>, that wraps <code>object.size()</code> to report the largest <span class="math inline">\(n\)</span> objects in a given environment:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb470"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb470-1"><a href="#cb470-1" aria-hidden="true" tabindex="-1"></a>ls_sizes <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">howMany =</span> <span class="dv">10</span>, <span class="at">minSize =</span> <span class="dv">1</span>){</span>
<span id="cb470-2"><a href="#cb470-2" aria-hidden="true" tabindex="-1"></a>    pf <span class="ot">&lt;-</span> <span class="fu">parent.frame</span>()</span>
<span id="cb470-3"><a href="#cb470-3" aria-hidden="true" tabindex="-1"></a>    obj <span class="ot">&lt;-</span> <span class="fu">ls</span>(pf) <span class="co"># or ls(sys.frame(-1)) </span></span>
<span id="cb470-4"><a href="#cb470-4" aria-hidden="true" tabindex="-1"></a>    objSizes <span class="ot">&lt;-</span> <span class="fu">sapply</span>(obj, <span class="cf">function</span>(x) {</span>
<span id="cb470-5"><a href="#cb470-5" aria-hidden="true" tabindex="-1"></a>                               pryr<span class="sc">::</span><span class="fu">object_size</span>(<span class="fu">get</span>(x, pf))</span>
<span id="cb470-6"><a href="#cb470-6" aria-hidden="true" tabindex="-1"></a>                           })</span>
<span id="cb470-7"><a href="#cb470-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## or sys.frame(-4) to get out of FUN, lapply(), sapply() and sizes()</span></span>
<span id="cb470-8"><a href="#cb470-8" aria-hidden="true" tabindex="-1"></a>    objNames <span class="ot">&lt;-</span> <span class="fu">names</span>(objSizes)</span>
<span id="cb470-9"><a href="#cb470-9" aria-hidden="true" tabindex="-1"></a>    howmany <span class="ot">&lt;-</span> <span class="fu">min</span>(howMany, <span class="fu">length</span>(objSizes))</span>
<span id="cb470-10"><a href="#cb470-10" aria-hidden="true" tabindex="-1"></a>    ord <span class="ot">&lt;-</span> <span class="fu">order</span>(objSizes, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb470-11"><a href="#cb470-11" aria-hidden="true" tabindex="-1"></a>    objSizes <span class="ot">&lt;-</span> objSizes[ord][<span class="dv">1</span><span class="sc">:</span>howMany]</span>
<span id="cb470-12"><a href="#cb470-12" aria-hidden="true" tabindex="-1"></a>    objSizes <span class="ot">&lt;-</span> objSizes[objSizes <span class="sc">&gt;</span> minSize]</span>
<span id="cb470-13"><a href="#cb470-13" aria-hidden="true" tabindex="-1"></a>    objSizes <span class="ot">&lt;-</span> <span class="fu">matrix</span>(objSizes, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb470-14"><a href="#cb470-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(objSizes) <span class="ot">&lt;-</span> objNames[ord][<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(objSizes)]</span>
<span id="cb470-15"><a href="#cb470-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(objSizes) <span class="ot">&lt;-</span> <span class="st">"bytes"</span></span>
<span id="cb470-16"><a href="#cb470-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">'object'</span>)</span>
<span id="cb470-17"><a href="#cb470-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">format</span>(objSizes, <span class="at">justify =</span> <span class="st">"right"</span>, <span class="at">width =</span> <span class="dv">11</span>),</span>
<span id="cb470-18"><a href="#cb470-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">quote =</span> <span class="cn">FALSE</span>)</span>
<span id="cb470-19"><a href="#cb470-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unfortunately with R6 and ReferenceClasses, closures, environments, and other such “containers”, it can be hard to see how much memory the object is using, including all the components of the object. Here’s a trick where we serialize the object, as if to export it, and then see how long the binary representation is. In this case the object is a closure that contains a large vector.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb471"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb471-1"><a href="#cb471-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb471-2"><a href="#cb471-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>)</span>
<span id="cb471-3"><a href="#cb471-3" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(input){</span>
<span id="cb471-4"><a href="#cb471-4" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> input</span>
<span id="cb471-5"><a href="#cb471-5" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="cf">function</span>(param) <span class="fu">return</span>(param <span class="sc">*</span> data) </span>
<span id="cb471-6"><a href="#cb471-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(g)</span>
<span id="cb471-7"><a href="#cb471-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb471-8"><a href="#cb471-8" aria-hidden="true" tabindex="-1"></a>myFun <span class="ot">&lt;-</span> <span class="fu">f</span>(x)</span>
<span id="cb471-9"><a href="#cb471-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x)</span>
<span id="cb471-10"><a href="#cb471-10" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(myFun)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1608 bytes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb473"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb473-1"><a href="#cb473-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object_size</span>(myFun)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80,013,376 B</code></pre>
</div>
<div class="sourceCode cell-code" id="cb475"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb475-1"><a href="#cb475-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">serialize</span>(myFun, <span class="cn">NULL</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 160007714</code></pre>
</div>
</div>
<p>Note that our discussion of copy-on-modify should help us understand why the serialized object is 160 MB, but only 80 MB is used to store the 10,000,000 numbers.</p>
<p>Here we examine the size of an environment:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb477"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb477-1"><a href="#cb477-1" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">new.env</span>()</span>
<span id="cb477-2"><a href="#cb477-2" aria-hidden="true" tabindex="-1"></a>e<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>)</span>
<span id="cb477-3"><a href="#cb477-3" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>56 bytes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb479"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb479-1"><a href="#cb479-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object_size</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80,000,496 B</code></pre>
</div>
<div class="sourceCode cell-code" id="cb481"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb481-1"><a href="#cb481-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">serialize</span>(e, <span class="cn">NULL</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 80000192</code></pre>
</div>
</div>
<p>One frustration with memory management is that if your code bumps up against the memory limits of the machine, it can be very slow to respond even when you’re trying to cancel the statement with <code>Ctrl-C</code>. You can impose memory limits in Linux by starting R (from the UNIX prompt) in a fashion such as this</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb483"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb483-1"><a href="#cb483-1" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> <span class="at">--max-vsize</span><span class="op">=</span>1000M</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then if you try to create an object that will push you over that limit or execute code that involves going over the limit, it will simply fail with the message “<em>Error: vector memory exhausted (limit reached?)</em>”. So this approach may be a nice way to avoid paging/swapping by setting the maximum in relation to the physical memory of the machine. It might also help in debugging memory leaks because the program would fail at the point that memory use was increasing. I haven’t played around with this much, so I offer this with a note of caution.</p>
<p>Apparently there is a memory profiler in R, <em>Rprofmem</em>, but it needs to be enabled when R is compiled (i.e., installed on the machine), because it slows R down even when not used. So I’ve never gotten to the point of playing around with it.</p>
</section>
</section>
<section id="how-memory-is-used-in-r" class="level2">
<h2 class="anchored" data-anchor-id="how-memory-is-used-in-r">How memory is used in R</h2>
<section id="a-secret-weapon-inspect" class="level3">
<h3 class="anchored" data-anchor-id="a-secret-weapon-inspect">A secret weapon: <code>inspect</code></h3>
<p>We can use an internal function called <code>inspect</code> to see where in memory an object is stored. It’s particularly useful for understanding storage and memory use for complicated data structures. We’ll also see that this can be a handy tool for seeing where copies are made and where they are not.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb484"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb484-1"><a href="#cb484-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb484-2"><a href="#cb484-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@55a134526b88 14 REALSXP g0c4 [REF(2)] (len=5, tl=0) -0.742042,0.577906,1.85653,0.449136,0.746484</code></pre>
</div>
</div>
<p>The first output is the address in memory (in hexadecimal) of the vector. The <code>REALSXP</code> indicates that the vector is stored as a real-valued “S” object under the hood in C. <code>REF(2)</code> indicates that two variables are referring to this particular memory location (more on this in much detail in a bit).</p>
</section>
<section id="memory-use-in-specific-circumstances" class="level3">
<h3 class="anchored" data-anchor-id="memory-use-in-specific-circumstances">Memory use in specific circumstances</h3>
<section id="how-lists-are-stored" class="level4">
<h4 class="anchored" data-anchor-id="how-lists-are-stored">How lists are stored</h4>
<p>Here we can use <code>inspect()</code> to see how the overall list is stored as well as the elements of the list and the attributes of the list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb486"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb486-1"><a href="#cb486-1" aria-hidden="true" tabindex="-1"></a>nums <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb486-2"><a href="#cb486-2" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">a =</span> nums, <span class="at">b =</span> nums, <span class="at">c =</span> <span class="fu">rnorm</span>(<span class="dv">5</span>), <span class="at">d =</span> <span class="fu">list</span>(<span class="at">some_string =</span> <span class="st">"adfs"</span>))</span>
<span id="cb486-3"><a href="#cb486-3" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(obj<span class="sc">$</span>a))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@55a1386c4768 14 REALSXP g0c4 [REF(4)] (len=5, tl=0) -1.47998,1.38282,0.22264,0.0640071,0.565649</code></pre>
</div>
<div class="sourceCode cell-code" id="cb488"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb488-1"><a href="#cb488-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(obj<span class="sc">$</span>b))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@55a1386c4768 14 REALSXP g0c4 [REF(5)] (len=5, tl=0) -1.47998,1.38282,0.22264,0.0640071,0.565649</code></pre>
</div>
<div class="sourceCode cell-code" id="cb490"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb490-1"><a href="#cb490-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(obj<span class="sc">$</span>c))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@55a1386c4df8 14 REALSXP g0c4 [REF(1)] (len=5, tl=0) -1.07213,-0.451605,-0.0594438,0.153536,-0.939612</code></pre>
</div>
<div class="sourceCode cell-code" id="cb492"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb492-1"><a href="#cb492-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(obj))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@55a13a35ca18 19 VECSXP g0c3 [REF(2),ATT] (len=4, tl=0)
  @55a1386c4768 14 REALSXP g0c4 [REF(6)] (len=5, tl=0) -1.47998,1.38282,0.22264,0.0640071,0.565649
  @55a1386c4768 14 REALSXP g0c4 [REF(6)] (len=5, tl=0) -1.47998,1.38282,0.22264,0.0640071,0.565649
  @55a1386c4df8 14 REALSXP g0c4 [REF(2)] (len=5, tl=0) -1.07213,-0.451605,-0.0594438,0.153536,-0.939612
  @55a138fdbeb0 19 VECSXP g0c1 [REF(1),ATT] (len=1, tl=0)
    @55a13924a030 16 STRSXP g0c1 [REF(3)] (len=1, tl=0)
      @55a13924a068 09 CHARSXP g0c1 [REF(2),gp=0x60] [ASCII] [cached] "adfs"
  ATTRIB:
    @55a1343f8780 02 LISTSXP g0c0 [REF(1)] 
      TAG: @55a128075800 01 SYMSXP g1c0 [MARK,REF(65535),LCK,gp=0x6000] "names" (has value)
      @55a138fdbee8 16 STRSXP g0c1 [REF(1)] (len=1, tl=0)
    @55a133bcfb28 09 CHARSXP g0c2 [REF(4),gp=0x61] [ASCII] [cached] "some_string"
ATTRIB:
  @55a1343f87f0 02 LISTSXP g0c0 [REF(1)] 
    TAG: @55a128075800 01 SYMSXP g1c0 [MARK,REF(65535),LCK,gp=0x6000] "names" (has value)
    @55a13a35ca68 16 STRSXP g0c3 [REF(65535)] (len=4, tl=0)
      @55a1283775d0 09 CHARSXP g1c1 [MARK,REF(811),gp=0x61] [ASCII] [cached] "a"
      @55a128696b80 09 CHARSXP g1c1 [MARK,REF(699),gp=0x61] [ASCII] [cached] "b"
      @55a128076bc0 09 CHARSXP g1c1 [MARK,REF(1008),gp=0x61] [ASCII] [cached] "c"
      @55a1285156b0 09 CHARSXP g1c1 [MARK,REF(421),gp=0x61] [ASCII] [cached] "d"</code></pre>
</div>
</div>
<p>What do we notice?</p>
<ul>
<li>The list itself is a vector of pointers to the component elements and a pointer to the attributes information.</li>
<li>Each element has its own address.</li>
<li>Attributes are themselves stored in particular locations.</li>
<li>Two elements of a list can use the same memory (see <code>a</code> and <code>b</code> here, whose contents are at the same memory address).</li>
</ul>
<p>The <em>pryr</em> package provides <code>address()</code> or <code>inspect()</code> as an alternative to <code>.Internal(inspect())</code> though even <code>pryr::inspect()</code> doesn’t give us the richness of information about complicated objects that <code>.Internal(inspect())</code> does.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb494"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb494-1"><a href="#cb494-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(obj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x55a13a35ca18"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb496"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb496-1"><a href="#cb496-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inspect</span>(obj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;VECSXP 0x55a13a35ca18&gt;
  &lt;REALSXP 0x55a1386c4768&gt;
  [REALSXP 0x55a1386c4768]
  &lt;REALSXP 0x55a1386c4df8&gt;
  &lt;VECSXP 0x55a138fdbeb0&gt;
    &lt;STRSXP 0x55a13924a030&gt;
      &lt;CHARSXP 0x55a13924a068&gt;
  attributes: 
    &lt;LISTSXP 0x55a1343f8780&gt;
    tag: 
      &lt;SYMSXP 0x55a128075800&gt;
    car: 
      &lt;STRSXP 0x55a138fdbee8&gt;
        &lt;CHARSXP 0x55a133bcfb28&gt;
    cdr: 
      NULL
attributes: 
  &lt;LISTSXP 0x55a1343f87f0&gt;
  tag: 
    [SYMSXP 0x55a128075800]
  car: 
    &lt;STRSXP 0x55a13a35ca68&gt;
      &lt;CHARSXP 0x55a1283775d0&gt;
      &lt;CHARSXP 0x55a128696b80&gt;
      &lt;CHARSXP 0x55a128076bc0&gt;
      &lt;CHARSXP 0x55a1285156b0&gt;
  cdr: 
    NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb498"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb498-1"><a href="#cb498-1" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">address</span>(obj<span class="sc">$</span>a)) <span class="co"># doesn't work</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error : x must be the name of an object</code></pre>
</div>
</div>
</section>
<section id="how-character-strings-are-stored." class="level4">
<h4 class="anchored" data-anchor-id="how-character-strings-are-stored.">How character strings are stored.</h4>
<p>Similar tricks are used for storing character vectors. We’ll explore this in a problem on PS4 using <code>inspect()</code>.</p>
</section>
<section id="replacement-functions-1" class="level4">
<h4 class="anchored" data-anchor-id="replacement-functions-1">Replacement functions</h4>
<p>Replacement functions can hide the use of additional memory. How much memory is used here? (Try running in R (not RStudio) on your own computer and note the <code>max_used</code> column in the <code>gc()</code> result should increase after we modify the dimensionality of <code>x</code>, indicating a copy was made.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb500"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb500-1"><a href="#cb500-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x)</span>
<span id="cb500-2"><a href="#cb500-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>(<span class="at">reset =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2350891  126   4.16e+06  222  2350891  126
Vcells 34249399  261   1.07e+08  816 34249399  261</code></pre>
</div>
<div class="sourceCode cell-code" id="cb502"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb502-1"><a href="#cb502-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>)</span>
<span id="cb502-2"><a href="#cb502-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2350816  126   4.16e+06  222  2363156  126
Vcells 44249273  338   1.07e+08  816 44270390  338</code></pre>
</div>
<div class="sourceCode cell-code" id="cb504"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb504-1"><a href="#cb504-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(x) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1e4</span>, <span class="fl">1e3</span>)</span>
<span id="cb504-2"><a href="#cb504-2" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(x) <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb504-3"><a href="#cb504-3" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2350843  126   4.16e+06  222  2368742  127
Vcells 44249313  338   1.07e+08  816 54282128  414</code></pre>
</div>
</div>
<p>However, not all replacement functions actually involve creating a new object and replacing the original object. Here <code>[&lt;-</code> is a primitive function, so the modification of the vector can be done without a copy in the underlying execution in C.</p>
<blockquote class="blockquote">
<p><strong>Warning</strong>: For some reason when I compile this document a copy is made. Try it in R (not RStudio) on your own computer, and you should see that the address of <code>x</code> is unchanged and no additional memory has been used.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb506"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb506-1"><a href="#cb506-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x)</span>
<span id="cb506-2"><a href="#cb506-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>(<span class="at">reset =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2350813  126   4.16e+06  222  2350813  126
Vcells 34249411  261   1.07e+08  816 34249411  261</code></pre>
</div>
<div class="sourceCode cell-code" id="cb508"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb508-1"><a href="#cb508-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>)</span>
<span id="cb508-2"><a href="#cb508-2" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dfdad9010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb510"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb510-1"><a href="#cb510-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2350842  126   4.16e+06  222  2369283  127
Vcells 44249455  338   1.07e+08  816 44280995  338</code></pre>
</div>
<div class="sourceCode cell-code" id="cb512"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb512-1"><a href="#cb512-1" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb512-2"><a href="#cb512-2" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">[&lt;-</span><span class="st">`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.Primitive("[&lt;-")</code></pre>
</div>
<div class="sourceCode cell-code" id="cb514"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb514-1"><a href="#cb514-1" aria-hidden="true" tabindex="-1"></a><span class="do">## When run plainly in R, should be the same address as before,</span></span>
<span id="cb514-2"><a href="#cb514-2" aria-hidden="true" tabindex="-1"></a><span class="do">## indicating no copy was made. Rendering the doc messes the</span></span>
<span id="cb514-3"><a href="#cb514-3" aria-hidden="true" tabindex="-1"></a><span class="do">## result up!</span></span>
<span id="cb514-4"><a href="#cb514-4" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3df8e8d010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb516"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb516-1"><a href="#cb516-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2350893  126   4.16e+06  222  2375902  127
Vcells 44249545  338   1.07e+08  816 54291217  414</code></pre>
</div>
</div>
<p>It makes some sense that modifying elements of a vector doesn’t cause a copy usually – if it did, working with large vectors would be very difficult.</p>
</section>
<section id="fast-representations-of-sequences" class="level4">
<h4 class="anchored" data-anchor-id="fast-representations-of-sequences">Fast representations of sequences</h4>
<p>As of R 3.5.0, <code>1:n</code> is not stored in memory as a vector of length <em>n</em>, but rather is represented by the first and last value in the sequence. However, some of the functions we use to determine object size don’t give us the right answer in this case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb518"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb518-1"><a href="#cb518-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb518-2"><a href="#cb518-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb518-3"><a href="#cb518-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e6</span></span>
<span id="cb518-4"><a href="#cb518-4" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(tmp <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: nanoseconds
       expr min  lq mean median  uq  max neval
 tmp &lt;- 1:n 174 184  277    244 264 3950   100</code></pre>
</div>
<div class="sourceCode cell-code" id="cb520"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb520-1"><a href="#cb520-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(tmp)  <span class="co"># incorrect</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>4000048 bytes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb522"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb522-1"><a href="#cb522-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object_size</span>(tmp)  <span class="co"># correct</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>680 B</code></pre>
</div>
<div class="sourceCode cell-code" id="cb524"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb524-1"><a href="#cb524-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_change</span>(mySeq <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>n)  <span class="co"># not sure why the result is negative!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-11.1 kB</code></pre>
</div>
<div class="sourceCode cell-code" id="cb526"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb526-1"><a href="#cb526-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">serialize</span>(mySeq, <span class="cn">NULL</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 133</code></pre>
</div>
</div>
<p>One implication is that in older versions of R, indexing large subsets can involve a lot of memory use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb528"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb528-1"><a href="#cb528-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>)</span>
<span id="cb528-2"><a href="#cb528-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> x[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(x) <span class="sc">-</span> <span class="dv">1</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, in old versions of R, more memory was used than just for <code>x</code> and <code>y</code>, because the index sequence itself used a bunch of memory.</p>
</section>
</section>
<section id="copy-on-modify" class="level3">
<h3 class="anchored" data-anchor-id="copy-on-modify">Copy-on-modify</h3>
<p>Next we’ll see that something like lazy evaluation occurs as well with some functionality called <em>delayed copying</em> or <em>copy-on-modify</em>. When we discussed R as being call-by-value, copy-on-modify was one of the reasons that copies of arguments are not always made. (But we didn’t talk about it at that time.)</p>
<section id="copy-on-modify-in-function-calls" class="level4">
<h4 class="anchored" data-anchor-id="copy-on-modify-in-function-calls">Copy-on-modify in function calls</h4>
<p>Let’s see what goes on within a function in terms of memory use in different situations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb529"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb529-1"><a href="#cb529-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x)</span>
<span id="cb529-2"><a href="#cb529-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>(<span class="at">reset =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2387959  128   4.16e+06  222  2387959  128
Vcells 34303403  262   1.07e+08  816 34303403  262</code></pre>
</div>
<div class="sourceCode cell-code" id="cb531"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb531-1"><a href="#cb531-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb531-2"><a href="#cb531-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">gc</span>())</span>
<span id="cb531-3"><a href="#cb531-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(x[<span class="dv">1</span>])</span>
<span id="cb531-4"><a href="#cb531-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">gc</span>())</span>
<span id="cb531-5"><a href="#cb531-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.Internal</span>(<span class="fu">inspect</span>(x))</span>
<span id="cb531-6"><a href="#cb531-6" aria-hidden="true" tabindex="-1"></a>    <span class="do">## print(address(x))  ## this gives the wrong answer; not sure why</span></span>
<span id="cb531-7"><a href="#cb531-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(lobstr<span class="sc">::</span><span class="fu">obj_addr</span>(x)) <span class="do">## fixed in lobstr, which supercedes pryr</span></span>
<span id="cb531-8"><a href="#cb531-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(x)</span>
<span id="cb531-9"><a href="#cb531-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb531-10"><a href="#cb531-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb531-11"><a href="#cb531-11" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>)</span>
<span id="cb531-12"><a href="#cb531-12" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2387939  128   4.16e+06  222  2406205  129
Vcells 44303400  338   1.07e+08  816 44334615  338</code></pre>
</div>
<div class="sourceCode cell-code" id="cb533"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb533-1"><a href="#cb533-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@7f3dfd455010 14 REALSXP g1c7 [MARK,REF(2)] (len=10000000, tl=0) 1.38438,0.609833,-0.283916,-1.52027,-0.213757,...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb535"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb535-1"><a href="#cb535-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">f</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2387969  128   4.16e+06  222  2406205  129
Vcells 44303452  338   1.07e+08  816 44334615  338
[1] 1.38
           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2387979  128   4.16e+06  222  2406205  129
Vcells 44303475  338   1.07e+08  816 44334615  338
@7f3dfd455010 14 REALSXP g1c7 [MARK,REF(4)] (len=10000000, tl=0) 1.38438,0.609833,-0.283916,-1.52027,-0.213757,...
[1] "0x7f3dfd455010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb537"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb537-1"><a href="#cb537-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@7f3dfd455010 14 REALSXP g1c7 [MARK,REF(6)] (len=10000000, tl=0) 1.38438,0.609833,-0.283916,-1.52027,-0.213757,...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb539"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb539-1"><a href="#cb539-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(out))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@7f3dfd455010 14 REALSXP g1c7 [MARK,REF(7)] (len=10000000, tl=0) 1.38438,0.609833,-0.283916,-1.52027,-0.213757,...</code></pre>
</div>
</div>
<p>We see that <code>y</code>, the local variable <code>x</code> in the function frame, and <code>out</code> all use the same memory, so no copies are made here. The <code>gc()</code> output confirms that no additional memory was used.</p>
<p>Only if <code>x</code> is changed do the addresses change and a copy in memory get made. (Note that we already saw this with the <code>diag&lt;-</code> replacement function example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb541"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb541-1"><a href="#cb541-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb541-2"><a href="#cb541-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.Internal</span>(<span class="fu">inspect</span>(x))</span>
<span id="cb541-3"><a href="#cb541-3" aria-hidden="true" tabindex="-1"></a>    x[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb541-4"><a href="#cb541-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.Internal</span>(<span class="fu">inspect</span>(x))</span>
<span id="cb541-5"><a href="#cb541-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(x)</span>
<span id="cb541-6"><a href="#cb541-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb541-7"><a href="#cb541-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb541-8"><a href="#cb541-8" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>)</span>
<span id="cb541-9"><a href="#cb541-9" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@7f3def5f4010 14 REALSXP g0c7 [REF(2)] (len=10000000, tl=0) 1.92264,1.19775,1.60747,0.417404,-0.102296,...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb543"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb543-1"><a href="#cb543-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">f</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@7f3def5f4010 14 REALSXP g0c7 [REF(4)] (len=10000000, tl=0) 1.92264,1.19775,1.60747,0.417404,-0.102296,...
@7f3dea9a8010 14 REALSXP g0c7 [REF(1)] (len=10000000, tl=0) 1.92264,7,1.60747,0.417404,-0.102296,...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb545"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb545-1"><a href="#cb545-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@7f3def5f4010 14 REALSXP g0c7 [REF(3)] (len=10000000, tl=0) 1.92264,1.19775,1.60747,0.417404,-0.102296,...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb547"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb547-1"><a href="#cb547-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.Internal</span>(<span class="fu">inspect</span>(out))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>@7f3dea9a8010 14 REALSXP g0c7 [REF(2)] (len=10000000, tl=0) 1.92264,7,1.60747,0.417404,-0.102296,...</code></pre>
</div>
</div>
</section>
<section id="copy-on-modify-in-general" class="level4">
<h4 class="anchored" data-anchor-id="copy-on-modify-in-general">Copy-on-modify in general</h4>
<p>In fact, copy-on-modify occurs outside function calls as well. Copies of objects are not made until one of the objects is actually modified. Initially, the copy points to the same memory location as the original object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb549"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb549-1"><a href="#cb549-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(y); <span class="fu">rm</span>(out)</span>
<span id="cb549-2"><a href="#cb549-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>(<span class="at">reset =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2388141  128   4.16e+06  222  2388141  128
Vcells 34304743  262   1.07e+08  816 34304743  262</code></pre>
</div>
<div class="sourceCode cell-code" id="cb551"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb551-1"><a href="#cb551-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>)</span>
<span id="cb551-2"><a href="#cb551-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2388132  128   4.16e+06  222  2400406  128
Vcells 44304727  338   1.07e+08  816 44325734  338</code></pre>
</div>
<div class="sourceCode cell-code" id="cb553"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb553-1"><a href="#cb553-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dfd455010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb555"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb555-1"><a href="#cb555-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> y</span>
<span id="cb555-2"><a href="#cb555-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2388158  128   4.16e+06  222  2406386  129
Vcells 44304772  338   1.07e+08  816 44335961  338</code></pre>
</div>
<div class="sourceCode cell-code" id="cb557"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb557-1"><a href="#cb557-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object_size</span>(x, y)  <span class="co"># from pryr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80,000,048 B</code></pre>
</div>
<div class="sourceCode cell-code" id="cb559"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb559-1"><a href="#cb559-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dfd455010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb561"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb561-1"><a href="#cb561-1" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb561-2"><a href="#cb561-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used (Mb) gc trigger (Mb) max used (Mb)
Ncells  2388191  128   4.16e+06  222  2414200  129
Vcells 54304821  414   1.07e+08  816 54346993  415</code></pre>
</div>
<div class="sourceCode cell-code" id="cb563"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb563-1"><a href="#cb563-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3def5f4010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb565"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb565-1"><a href="#cb565-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object_size</span>(x, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>160,000,096 B</code></pre>
</div>
<div class="sourceCode cell-code" id="cb567"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb567-1"><a href="#cb567-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x)</span>
<span id="cb567-2"><a href="#cb567-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> y</span>
<span id="cb567-3"><a href="#cb567-3" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dfd455010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb569"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb569-1"><a href="#cb569-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dfd455010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb571"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb571-1"><a href="#cb571-1" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb571-2"><a href="#cb571-2" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dfd455010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb573"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb573-1"><a href="#cb573-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dea9a8010"</code></pre>
</div>
</div>
<p>Or we can see this using <code>mem_change()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb575"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb575-1"><a href="#cb575-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb575-2"><a href="#cb575-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x)</span>
<span id="cb575-3"><a href="#cb575-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(y)</span>
<span id="cb575-4"><a href="#cb575-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_change</span>(x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80 MB</code></pre>
</div>
<div class="sourceCode cell-code" id="cb577"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb577-1"><a href="#cb577-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dfd455010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb579"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb579-1"><a href="#cb579-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_change</span>(x[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>320 B</code></pre>
</div>
<div class="sourceCode cell-code" id="cb581"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb581-1"><a href="#cb581-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dfd455010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb583"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb583-1"><a href="#cb583-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_change</span>(y <span class="ot">&lt;-</span> x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>376 B</code></pre>
</div>
<div class="sourceCode cell-code" id="cb585"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb585-1"><a href="#cb585-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dfd455010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb587"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb587-1"><a href="#cb587-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_change</span>(x[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80 MB</code></pre>
</div>
<div class="sourceCode cell-code" id="cb589"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb589-1"><a href="#cb589-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3def5f4010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb591"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb591-1"><a href="#cb591-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7f3dfd455010"</code></pre>
</div>
</div>
<p><strong>Challenge</strong>: explain the results of the example above.</p>
</section>
<section id="how-does-copy-on-modify-work" class="level4">
<h4 class="anchored" data-anchor-id="how-does-copy-on-modify-work">How does copy-on-modify work?</h4>
<p>R keeps track of how many names refer to an object and only makes copies as needed when multiple names refer to an object. Note the value of REF and the address returned by <code>.Internal(inspect())</code>, or simply use <code>refs()</code> and <code>address()</code> from <code>pryr</code>.</p>
<p>We’ll see this live in class. Unfortunately both rendering and RStudio can give us confusing results for <code>refs()</code>, so I’m adding the clean results from just running in R as comments here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb593"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb593-1"><a href="#cb593-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb593-2"><a href="#cb593-2" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x55a13715bc68"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb595"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb595-1"><a href="#cb595-1" aria-hidden="true" tabindex="-1"></a><span class="do">## refs(a)  ## 1</span></span>
<span id="cb595-2"><a href="#cb595-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> a</span>
<span id="cb595-3"><a href="#cb595-3" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x55a13715bc68"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb597"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb597-1"><a href="#cb597-1" aria-hidden="true" tabindex="-1"></a><span class="do">## refs(a)  ## 2</span></span>
<span id="cb597-2"><a href="#cb597-2" aria-hidden="true" tabindex="-1"></a><span class="do">## refs(b)  ## 2</span></span>
<span id="cb597-3"><a href="#cb597-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(b)</span>
<span id="cb597-4"><a href="#cb597-4" aria-hidden="true" tabindex="-1"></a><span class="do">## refs(a)  ## 1</span></span>
<span id="cb597-5"><a href="#cb597-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb597-6"><a href="#cb597-6" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> a</span>
<span id="cb597-7"><a href="#cb597-7" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb597-8"><a href="#cb597-8" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x55a1395669d8"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb599"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb599-1"><a href="#cb599-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x55a13715bc68"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb601"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb601-1"><a href="#cb601-1" aria-hidden="true" tabindex="-1"></a><span class="do">## refs(a)  ## 1</span></span>
<span id="cb601-2"><a href="#cb601-2" aria-hidden="true" tabindex="-1"></a><span class="do">## refs(b)  ## 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This notion of reference counting occurs in other contexts, such as shared pointers in C++ and garbage collection (deletion of unused objects) in Python and R.</p>
<p>In older versions of R (before R 4.0) there were some shortcomings in how R managed this, and one could see different results than shown above.</p>
</section>
</section>
</section>
<section id="strategies-for-saving-memory" class="level2">
<h2 class="anchored" data-anchor-id="strategies-for-saving-memory">Strategies for saving memory</h2>
<p>A couple basic strategies for saving memory include:</p>
<ul>
<li>Avoiding unnecessary copies.</li>
<li>Removing objects that are not being used, at which point the R garbage collector should free up the memory.</li>
</ul>
<p>If you’re really trying to optimize memory use, you may also consider:</p>
<ul>
<li>Using R6 classes and similar strategies to pass by reference.</li>
<li>Substituting integer and logical vectors for numeric vectors when possible.</li>
</ul>
</section>
<section id="example-1" class="level2">
<h2 class="anchored" data-anchor-id="example-1">Example</h2>
<p>Let’s work through a real example where we keep a running tally of current memory in use and maximum memory used in a function call. We’ll want to consider hidden uses of memory, when copies are made, and lazy evaluation. This code is courtesy of Yuval Benjamini. For our purposes here, let’s assume that <code>xvar</code> and <code>yvar</code> are very long vectors using a lot of memory. The use of <code>.C()</code> calls out to some user-written C code. (In a real example we’d also want to think about when copies are made in calling compiled code, but we don’t do that here.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb602"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb602-1"><a href="#cb602-1" aria-hidden="true" tabindex="-1"></a>fastcount <span class="ot">&lt;-</span> <span class="cf">function</span>(xvar, yvar) {</span>
<span id="cb602-2"><a href="#cb602-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(xvar[<span class="dv">1</span>])</span>
<span id="cb602-3"><a href="#cb602-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(yvar[<span class="dv">1</span>])</span>
<span id="cb602-4"><a href="#cb602-4" aria-hidden="true" tabindex="-1"></a>    naline <span class="ot">&lt;-</span> <span class="fu">is.na</span>(xvar)</span>
<span id="cb602-5"><a href="#cb602-5" aria-hidden="true" tabindex="-1"></a>    naline[<span class="fu">is.na</span>(yvar)] <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb602-6"><a href="#cb602-6" aria-hidden="true" tabindex="-1"></a>    xvar[naline] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb602-7"><a href="#cb602-7" aria-hidden="true" tabindex="-1"></a>    yvar[naline] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb602-8"><a href="#cb602-8" aria-hidden="true" tabindex="-1"></a>    useline <span class="ot">&lt;-</span> <span class="sc">!</span>naline</span>
<span id="cb602-9"><a href="#cb602-9" aria-hidden="true" tabindex="-1"></a>    <span class="do">## We'll ignore the rest of the code.</span></span>
<span id="cb602-10"><a href="#cb602-10" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Table must be initialized for -1's</span></span>
<span id="cb602-11"><a href="#cb602-11" aria-hidden="true" tabindex="-1"></a>    tablex <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">max</span>(xvar)<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb602-12"><a href="#cb602-12" aria-hidden="true" tabindex="-1"></a>    tabley <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">max</span>(yvar)<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb602-13"><a href="#cb602-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(xvar) <span class="sc">==</span> <span class="fu">length</span>(yvar))</span>
<span id="cb602-14"><a href="#cb602-14" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">.C</span>(<span class="st">"fastcount"</span>,<span class="at">PACKAGE=</span><span class="st">"GCcorrect"</span>,</span>
<span id="cb602-15"><a href="#cb602-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">tablex =</span> <span class="fu">as.integer</span>(tablex), <span class="at">tabley =</span> <span class="fu">as.integer</span>(tabley),</span>
<span id="cb602-16"><a href="#cb602-16" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.integer</span>(xvar), <span class="fu">as.integer</span>(yvar), <span class="fu">as.integer</span>(useline),</span>
<span id="cb602-17"><a href="#cb602-17" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.integer</span>(<span class="fu">length</span>(xvar)))</span>
<span id="cb602-18"><a href="#cb602-18" aria-hidden="true" tabindex="-1"></a>    xuse <span class="ot">&lt;-</span> <span class="fu">which</span>(res<span class="sc">$</span>tablex<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb602-19"><a href="#cb602-19" aria-hidden="true" tabindex="-1"></a>    xnames <span class="ot">&lt;-</span> xuse <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb602-20"><a href="#cb602-20" aria-hidden="true" tabindex="-1"></a>    resb <span class="ot">&lt;-</span> <span class="fu">rbind</span>(res<span class="sc">$</span>tablex[xuse], res<span class="sc">$</span>tabley[xuse]) </span>
<span id="cb602-21"><a href="#cb602-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(resb) <span class="ot">&lt;-</span> xnames</span>
<span id="cb602-22"><a href="#cb602-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(resb)</span>
<span id="cb602-23"><a href="#cb602-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="efficiency" class="level1">
<h1>9. Efficiency</h1>
<section id="interpreters-and-compilation" class="level2">
<h2 class="anchored" data-anchor-id="interpreters-and-compilation">Interpreters and compilation</h2>
<section id="why-are-interpreted-languages-slow" class="level3">
<h3 class="anchored" data-anchor-id="why-are-interpreted-languages-slow">Why are interpreted languages slow?</h3>
<p>Compiled code runs quickly because the original code has been translated into instructions (machine language) that the processor can understand (i.e., zeros and ones). In the process of doing so, various checking and lookup steps are done once and don’t need to be redone when running the compiled code.</p>
<p>In contrast, when one runs code in an interpreted language such as R or Python, the interpreter needs to do all the checking and lookup each time the code is run. This is required because the types and locations in memory of the variables could have changed.</p>
<p>We’ll focus on R in the following discussion, but most of the concepts apply to other interpreted languages (that said, R is particularly dynamic as illustrated below in Section 10 of this Unit).</p>
<p>For example, consider this code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb603"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb603-1"><a href="#cb603-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb603-2"><a href="#cb603-2" aria-hidden="true" tabindex="-1"></a>x<span class="sc">*</span><span class="dv">7</span></span>
<span id="cb603-3"><a href="#cb603-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">'hi'</span></span>
<span id="cb603-4"><a href="#cb603-4" aria-hidden="true" tabindex="-1"></a>x<span class="sc">*</span><span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because of dynamic typing, when the interpreter sees <code>x*3</code> it needs to check if <code>x</code> is something that can be multiplied by 3, including dealing with the fact that <code>x</code> could be a vector with many numbers in it. In addition it needs to (using scoping rules) look up the value of <code>x</code>. (Consider that <code>x</code> might not even exist at the point that <code>x*3</code> is called.) Only then can the multiplication happen.</p>
<p>Let’s consider writing a loop:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb604"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb604-1"><a href="#cb604-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb604-2"><a href="#cb604-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) x <span class="ot">&lt;-</span> <span class="st">'hi'</span></span>
<span id="cb604-3"><a href="#cb604-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;</span> <span class="fl">0.5</span>) <span class="fu">rm</span>(x)</span>
<span id="cb604-4"><a href="#cb604-4" aria-hidden="true" tabindex="-1"></a>  x[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(x[i])</span>
<span id="cb604-5"><a href="#cb604-5" aria-hidden="true" tabindex="-1"></a>}  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There is no way around the fact that because of how dynamic this is, the interpreter needs to check if <code>x</code> exists, if it is a vector of sufficient length, if it contains numeric values, and it needs to go retrieve the required value, EVERY TIME the <code>exp()</code> is executed. Now the code above is unusual, and in most cases, we wouldn’t have the if() statements that modify <code>x</code>. So you could imagine a process by which the checking were done on the first iteration and then not needed after that – that gets into the idea of just-in-time compilation, discussed later.</p>
<p>The R interpreter is a C function so in some sense everything that happens is running as compiled code, but there are lots more things being done to accomplish a given task using interpreted code than if the task had been written directly in code that is compiled. By analogy, consider talking directly to a person in a language you both know compared to talking to a person via an interpreter who has to translate between two languages. Ultimately, the same information gets communicated (hopefully!) but the number of words spoken and time involved is much greater.</p>
<p>When running more complicated functions, there is often a lot of checking that is part of the function itself. For example, consider all the checking in the <code>lm</code> function before it gets to calling <code>lm.fit()</code> to do the actual linear algebra needed to produce the least squares solution. Or consider the checking involved in <code>mean.default</code> before it finally calls R’s internal <code>mean</code> function, which runs compiled C code. Hadley Wickham’s Advanced R book has a <a href="https://adv-r.hadley.nz/perf-improve.html">section on performance</a> that discusses this in detail.</p>
<p>We can flip the question on its head and ask what operations in an interpreted language will execute quickly. In R, these include:</p>
<ul>
<li>operations that call out to compiled C code via <code>.Primitive()</code> or <code>.Internal()</code></li>
<li>linear algebra operations (these call out to compiled C or Fortran code provided by the BLAS and LAPACK software packages)</li>
<li>vectorized calls rather than loops in R
<ul>
<li>vectorized calls generally run loops in compiled C code rather than having the loop run in R</li>
<li>that means that the interpreter doesn’t have to do all the checking discussed above for every iteration of the loop</li>
</ul></li>
</ul>
</section>
<section id="compilation" class="level3">
<h3 class="anchored" data-anchor-id="compilation">Compilation</h3>
<section id="overview-3" class="level4">
<h4 class="anchored" data-anchor-id="overview-3">Overview</h4>
<p>Compilation is the process of turning code in a given language (such a C++) into machine code. Machine code is the code that the processor actually executes. The machine code is stored in the executable file, which is a binary file. The history of programming has seen ever great levels of abstraction, so that humans can write code using syntax that is easier for us to understand, re-use, and develop building blocks that can be put together to do complicated tasks. For example assembly language is a step above machine code. Languages like C and Fortran provide additional abstraction beyond that. The Stastics 750 class at CMU has a <a href="https://36-750.github.io/tools/computer-architecture/#how-programs--aka-apps--run">nice overview</a> if you want to see more details.</p>
<p>Note that interpreters such as R are themselves programs – the R interpreter is a C program that has been compiled. It happens to be a program that processes R code. The interpreter doesn’t turn R code into machine code, but the interpreter itself is machine code.</p>
</section>
<section id="just-in-time-jit-compilation" class="level4">
<h4 class="anchored" data-anchor-id="just-in-time-jit-compilation">Just-in-time (JIT) compilation</h4>
<p>Standard compilation (ahead-of-time or AOT compilation) happens before any code is executed and can involve a lot of optimization to produce the most efficient machine code possible.</p>
<p>In contrast, just-in-time (JIT) compilation happens at the time that the code is executing. JIT compilation is heavily used in Julia, which is very fast (in some cases as fast as C). JIT compilation involves translating to machine code as the code is running. One nice aspect is that the results are cached so that if code is rerun, the compilation process doesn’t have to be redone. So if you use a language like Julia, you’ll see that the speed can vary drastically between the first time and later times you run a given function during a given session.</p>
<p>One thing that needs to be dealt with is type checking. As discussed above, part of why an interpreter is slow is because the type of the variable(s) involved in execution of a piece of code is not known in advance, so the interpreter needs to check the type. In JIT systems, there are often type inference systems that determine variable types.</p>
<p>JIT compilation can involve translation from the original code to machine code or translation of bytecode (see next section) to machine code.</p>
</section>
<section id="byte-compiling-optional" class="level4">
<h4 class="anchored" data-anchor-id="byte-compiling-optional">Byte compiling (optional)</h4>
<p>Functions in R and R packages are byte compiled. What does that mean? Byte-compiled code is a special representation that can be executed more efficiently because it is in the form of compact codes that encode the results of parsing and semantic analysis of scoping and other complexities of the R source code. This byte code can be executed faster than the original R code because it skips the stage of having to be interpreted by the R interpreter.</p>
<p>If you print out a function that is byte-compiled, you’ll see something like <code>&lt;bytecode: 0x243a368&gt;</code> at the bottom.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb605"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb605-1"><a href="#cb605-1" aria-hidden="true" tabindex="-1"></a>mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, ...) 
UseMethod("mean")
&lt;bytecode: 0x55a12a52df80&gt;
&lt;environment: namespace:base&gt;</code></pre>
</div>
</div>
<p>We can byte compile our own functions using <code>cmpfun()</code>. Here’s an example (silly since as experienced R programmers, we would use vectorized calculation here rather than this unvectorized code.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb607"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb607-1"><a href="#cb607-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(compiler); <span class="fu">library</span>(rbenchmark)</span>
<span id="cb607-2"><a href="#cb607-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(vals){</span>
<span id="cb607-3"><a href="#cb607-3" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb607-4"><a href="#cb607-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(x) <span class="ot">&lt;-</span> <span class="fu">length</span>(vals)</span>
<span id="cb607-5"><a href="#cb607-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(vals)) x[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(vals[i])</span>
<span id="cb607-6"><a href="#cb607-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(x)</span>
<span id="cb607-7"><a href="#cb607-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb607-8"><a href="#cb607-8" aria-hidden="true" tabindex="-1"></a>fc <span class="ot">&lt;-</span> <span class="fu">cmpfun</span>(f)</span>
<span id="cb607-9"><a href="#cb607-9" aria-hidden="true" tabindex="-1"></a>fc <span class="co"># notice the indication that the function is byte compiled.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function(vals){
    x &lt;- as.numeric(NA)
    length(x) &lt;- length(vals)
    for(i in seq_along(vals)) x[i] &lt;- exp(vals[i])
    return(x)
}
&lt;bytecode: 0x55a133e0bb58&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb609"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb609-1"><a href="#cb609-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">100000</span>)</span>
<span id="cb609-2"><a href="#cb609-2" aria-hidden="true" tabindex="-1"></a><span class="fu">benchmark</span>(<span class="fu">f</span>(x), <span class="fu">fc</span>(x), y <span class="ot">&lt;-</span> <span class="fu">exp</span>(x), <span class="at">replications =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         test replications elapsed relative user.self sys.self user.child
1        f(x)            5   0.047     11.8     0.047        0          0
2       fc(x)            5   0.046     11.5     0.046        0          0
3 y &lt;- exp(x)            5   0.004      1.0     0.003        0          0
  sys.child
1         0
2         0
3         0</code></pre>
</div>
</div>
<p>Unfortunately, in my experience (as illustrated above), byte compiling doesn’t usually speed things up much. I’m not sure why.</p>
<p>You can compile an entire source file with <code>cmpfile()</code>, which produces a <code>.Rc</code> file. You then need to use <code>loadcmp()</code> to load in the <code>.Rc</code> file, which runs the code.</p>
</section>
</section>
</section>
<section id="benchmarking-and-profiling" class="level2">
<h2 class="anchored" data-anchor-id="benchmarking-and-profiling">Benchmarking and profiling</h2>
<p>The <a href="https://berkeley-scf.github.io/tutorial-efficient-R/timing">efficient R tutorial</a> discusses strategies for timing and profiling R code.</p>
<p>Recall that it’s a waste of time to optimize code before you determine (1) that the code is too slow for how it will be used and (2) which are the slow steps on which to focus your attempts to speed the code up. A 100x speedup in a step that takes 1% of the time will speed up the overall code by very little.</p>
</section>
<section id="writing-efficient-r-code" class="level2">
<h2 class="anchored" data-anchor-id="writing-efficient-r-code">Writing efficient R code</h2>
<p>The <a href="https://berkeley-scf.github.io/tutorial-efficient-R/efficiency">efficient R tutorial</a> discusses strategies for improving the efficiency of R code. We’ll discuss a variety of these strategies, including:</p>
<ul>
<li>Pre-allocating memory rather than growing objects iteratively</li>
<li>Vectorization and use of fast matrix algebra</li>
<li>Consideration of loops vs.&nbsp;map operations</li>
<li>Speed of lookup operations, including hashing</li>
<li>Effectively using the CPU cache</li>
</ul>
</section>
<section id="hashing-including-name-lookup" class="level2">
<h2 class="anchored" data-anchor-id="hashing-including-name-lookup">Hashing (including name lookup)</h2>
<p>In the tutorial on efficient R coding, it mentions that looking up objects by name in an R environment occurs via hashing, so it is very fast. I’ll briefly describe what hashing is here, because it is a commonly-used strategy in programming in general.</p>
<p>A hash function is a function that takes as input some data and maps it to a fixed-length output that can be used as a shortened reference to the data. (The function should be deterministic, always returing the same output for a given input.) We’ve seen this in the context of git commits where each commit was labeled with a long base-16 number. This also comes up when verifying files on the Internet. You can compute the hash value on the file you get and check that it is the same as the hash value associated with the legitimate copy of the file.</p>
<p>While there are various uses of hashing, for our purposes here, hashing can allow one to look up values by their name via a hash table. The idea is that you have a set of key-value pairs (sometimes called a dictionary) where the key is the name associated with the value and the value is some arbitrary object. You want to be able to quickly find the value/object quickly.</p>
<p>Hashing allows one to quickly determine an index associated with the key and therefore quickly find the relevant value based on the index. For example, one approach is to compute the hash as a function of the key and then take the remainder when dividing by the number of possible results (here the fact that the result is a fixed-length output is important) to get the index. Here’s the procedure in pseudocode:</p>
<pre><code>    hash = hashfunc(key) 
    index = hash %% array_size 
    ## %% is modulo operator - it gives the remainder</code></pre>
<p>In general, there will be collisions – multiple keys will be assigned to the same index. However with a good hash function, usually there will be a small number of keys associated with a given bucket. So each bucket will contain a list of a small number of values and the associated keys. (The buckets might contain the actual values or they might contain the addresses of where the values are actually stored if the values are complicated objects.) Then determining the correct value (or the required address) within a given bucket is fast even with simple linear search through the items one by one. Put another way, the hash function distributes the keys amongst an array of buckets and allows one to look up the appropriate bucket quickly based on the computed index value. When the hash table is properly set up, the cost of looking up a value does not depend on the number of key-value pairs stored.</p>
<p>R uses hashing to look up the value of a variable based on the variable name in a given environment, including the frames of functions and the global environment. This allows R to retrieve objects very quickly.</p>
</section>
<section id="efficiency-challenges" class="level2">
<h2 class="anchored" data-anchor-id="efficiency-challenges">Efficiency challenges</h2>
<p>We’ll work on some of these challenges in class. In addition, one or more of these challenges will appear on PS4.</p>
<p>Some things to think about in trying to write more efficient code (or improve the efficiency of existing code) in R and more generally include:</p>
<ul>
<li>avoid repeated calculations, particularly in a loop
<ul>
<li>save (i.e., cache) the result in an object</li>
<li>move repeated calculations outside of loops
<ul>
<li>watch out for calculations in a loop that don’t involve all the indices of the loop(s)</li>
</ul></li>
</ul></li>
<li>avoid entirely unneeded calculations
<ul>
<li>e.g., consider <code>diag(X%*%Y)</code></li>
</ul></li>
<li>avoid calculations where you know the answer
<ul>
<li>e.g., any part of a computation where you multiply by or add zero or multiply by one</li>
</ul></li>
<li>use vectorization in interpreted languages</li>
<li>consider the order of operations</li>
<li>combine operations when possible (e.g., use of <code>crossprod</code>)</li>
</ul>
<p><strong>Challenge 1</strong>: Here’s a calculation of the sort needed in mixture component modeling. I have a vector of <span class="math inline">\(n\)</span> observations. I need to find the likelihood of each observation under each of <span class="math inline">\(p\)</span> mixture components (i.e., what’s the likelihood if it came from each of the components). (In this case, the the likelihood is simply the normal density of the observation given the mean and standard deviation of the component normal distribution.) So I should produce a matrix of <span class="math inline">\(n\)</span> rows and <span class="math inline">\(p\)</span> columns where the value in the <span class="math inline">\(i\)</span>th row, <span class="math inline">\(j\)</span>th column is the likelihood of the <span class="math inline">\(i\)</span>th observation under the <span class="math inline">\(j\)</span>th mixture component. The idea is that the likelihoods for a given observation are used in assigning observations to clusters. A naive implementation is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb612"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb612-1"><a href="#cb612-1" aria-hidden="true" tabindex="-1"></a>lik <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">nr =</span> n, <span class="at">nc =</span> p)</span>
<span id="cb612-2"><a href="#cb612-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) lik[ , j] <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(y, mns[j], sds[j])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that <code>dnorm()</code> can handle matrices and vectors as the observations <strong>and</strong> as the means and sds, so there are multiple ways to do this. Try to figure out the fastest way to do this, amongst the options of looping over the mixture components, looping over the observations, using vectorized operations that recycle the observations, using vectorized operations that recycle the mixture components, etc.</p>
<p><strong>Challenge 2</strong>: Here’s a calculation of the sort needed in a mixed membership model, where each observation is associated with some number of components. Suppose you have</p>
<p><span class="math display">\[y_{i}\sim\mathcal{N}(\sum_{j=1}^{m_{i}}w_{i,j}\mu_{ID[i,j]},\sigma^{2})\]</span></p>
<p>for a large number of observations, <span class="math inline">\(n\)</span>. I give you a vector of <span class="math inline">\(\mu=(\mu_{1},\ldots,\mu_{K})\)</span> values and a ragged list of weights (i.e., the number of weights varies by observation) and a ragged list of IDs identifying the cluster corresponding to each weight (note <span class="math inline">\(m_{i}\)</span> varies by observation). Figure out how to calculate the vector of means, <span class="math inline">\(\sum_{j}w_{i,j}\mu_{ID[i,j]}\)</span> as fast as possible. Suppose that <span class="math inline">\(m_{i}\)</span> never gets too big (but <span class="math inline">\(\mu\)</span> might have many elements) - could this help you? Part of thinking this through involves thinking about how you want to store the information so that the calculations can be done quickly. The data file <code>mixedMember.Rda</code> contains example data for two scenarios: Scenario A has many <span class="math inline">\(\mu\)</span> values and Scenario B has few <span class="math inline">\(\mu\)</span> values.</p>
<p><strong>Challenge 3</strong>: Write code that simulates a random walk in two dimensions for <span class="math inline">\(n\)</span> steps. First write out a straightforward implementation that involves looping. Then try to speed it up. The <code>cumsum</code> function may be helpful.</p>
<p><strong>Challenge 4:</strong> Determine if it’s faster to subset based on vector of indices or a vector of logicals. Determine if it matters how big the original object is and how large the subset is, as well as whether the vector of indices is ordered.</p>
<p><strong>Challenge 5:</strong> Figure out how to improve the efficiency of the following code chunk, which is part of an iterative optimization of a log-likelihood for a student’s PhD research. Some test data is in <code>likLoops.Rda</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb613"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb613-1"><a href="#cb613-1" aria-hidden="true" tabindex="-1"></a>ll <span class="ot">&lt;-</span> <span class="cf">function</span>(Theta, A) {</span>
<span id="cb613-2"><a href="#cb613-2" aria-hidden="true" tabindex="-1"></a>  sum.ind <span class="ot">&lt;-</span> <span class="fu">which</span>(A<span class="sc">==</span><span class="dv">1</span>, <span class="at">arr.ind=</span>T)</span>
<span id="cb613-3"><a href="#cb613-3" aria-hidden="true" tabindex="-1"></a>  logLik <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">log</span>(Theta[sum.ind])) <span class="sc">-</span> <span class="fu">sum</span>(Theta)</span>
<span id="cb613-4"><a href="#cb613-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(logLik)</span>
<span id="cb613-5"><a href="#cb613-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb613-6"><a href="#cb613-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb613-7"><a href="#cb613-7" aria-hidden="true" tabindex="-1"></a>oneUpdate <span class="ot">&lt;-</span> <span class="cf">function</span>(A, n, K, theta.old, <span class="at">thresh =</span> <span class="fl">0.1</span>) { </span>
<span id="cb613-8"><a href="#cb613-8" aria-hidden="true" tabindex="-1"></a>  theta.old1 <span class="ot">&lt;-</span> theta.old</span>
<span id="cb613-9"><a href="#cb613-9" aria-hidden="true" tabindex="-1"></a>  Theta.old <span class="ot">&lt;-</span> theta.old <span class="sc">%*%</span> <span class="fu">t</span>(theta.old)</span>
<span id="cb613-10"><a href="#cb613-10" aria-hidden="true" tabindex="-1"></a>  L.old <span class="ot">&lt;-</span> <span class="fu">ll</span>(Theta.old, A)</span>
<span id="cb613-11"><a href="#cb613-11" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(n, n, K))</span>
<span id="cb613-12"><a href="#cb613-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb613-13"><a href="#cb613-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb613-14"><a href="#cb613-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb613-15"><a href="#cb613-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (z <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb613-16"><a href="#cb613-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (theta.old[i, z]<span class="sc">*</span>theta.old[j, z] <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb613-17"><a href="#cb613-17" aria-hidden="true" tabindex="-1"></a>          q[i, j, z] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb613-18"><a href="#cb613-18" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb613-19"><a href="#cb613-19" aria-hidden="true" tabindex="-1"></a>          q[i, j, z] <span class="ot">&lt;-</span> theta.old[i, z]<span class="sc">*</span>theta.old[j, z] <span class="sc">/</span></span>
<span id="cb613-20"><a href="#cb613-20" aria-hidden="true" tabindex="-1"></a>            Theta.old[i, j]</span>
<span id="cb613-21"><a href="#cb613-21" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb613-22"><a href="#cb613-22" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb613-23"><a href="#cb613-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb613-24"><a href="#cb613-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb613-25"><a href="#cb613-25" aria-hidden="true" tabindex="-1"></a>  theta.new <span class="ot">&lt;-</span> theta.old</span>
<span id="cb613-26"><a href="#cb613-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (z <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb613-27"><a href="#cb613-27" aria-hidden="true" tabindex="-1"></a>    theta.new[,z] <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(A<span class="sc">*</span>q[,,z])<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">sum</span>(A<span class="sc">*</span>q[,,z]))</span>
<span id="cb613-28"><a href="#cb613-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb613-29"><a href="#cb613-29" aria-hidden="true" tabindex="-1"></a>  Theta.new <span class="ot">&lt;-</span> theta.new <span class="sc">%*%</span> <span class="fu">t</span>(theta.new)</span>
<span id="cb613-30"><a href="#cb613-30" aria-hidden="true" tabindex="-1"></a>  L.new <span class="ot">&lt;-</span> <span class="fu">ll</span>(Theta.new, A)</span>
<span id="cb613-31"><a href="#cb613-31" aria-hidden="true" tabindex="-1"></a>      converge.check <span class="ot">&lt;-</span> <span class="fu">abs</span>(L.new <span class="sc">-</span> L.old) <span class="sc">&lt;</span> thresh</span>
<span id="cb613-32"><a href="#cb613-32" aria-hidden="true" tabindex="-1"></a>  theta.new <span class="ot">&lt;-</span> theta.new<span class="sc">/</span><span class="fu">rowSums</span>(theta.new)</span>
<span id="cb613-33"><a href="#cb613-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">theta =</span> theta.new, <span class="at">loglik =</span> L.new,</span>
<span id="cb613-34"><a href="#cb613-34" aria-hidden="true" tabindex="-1"></a>              <span class="at">converged =</span> converge.check)) </span>
<span id="cb613-35"><a href="#cb613-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb613-36"><a href="#cb613-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb613-37"><a href="#cb613-37" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize the parameters at random starting values</span></span>
<span id="cb613-38"><a href="#cb613-38" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(n<span class="sc">*</span>K), n, K)</span>
<span id="cb613-39"><a href="#cb613-39" aria-hidden="true" tabindex="-1"></a>theta.init <span class="ot">&lt;-</span> temp<span class="sc">/</span><span class="fu">rowSums</span>(temp)</span>
<span id="cb613-40"><a href="#cb613-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb613-41"><a href="#cb613-41" aria-hidden="true" tabindex="-1"></a><span class="co"># do single update</span></span>
<span id="cb613-42"><a href="#cb613-42" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">oneUpdate</span>(A, n, K, theta.init)</span>
<span id="cb613-43"><a href="#cb613-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb613-44"><a href="#cb613-44" aria-hidden="true" tabindex="-1"></a><span class="co"># in the real code, oneUpdate was called repeatedly in a while loop as </span></span>
<span id="cb613-45"><a href="#cb613-45" aria-hidden="true" tabindex="-1"></a><span class="co"># part of an iterative optimization to find a maximum likelihood estimator</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Challenge 6</strong>: Another problem involving a computation from a student’s PhD research. The following is the probability mass function for an overdispersed binomial random variable:</p>
<p><span class="math display">\[
P(Y =y )  =  \frac{f(y;n,p,\phi)}{\sum_{k=0}^{n}f(k;n,p,\phi)} \\
\]</span></p>
<p><span class="math display">\[
f(k;n,p,\phi)  =  {n \choose k}\frac{k^{k}(n-k)^{n-k}}{n^{n}}\left(\frac{n^{n}}{k^{k}(n-k)^{n-k}}\right)^{\phi}p^{k\phi}(1-p)^{(n-k)\phi}
\]</span></p>
<p>where the denominator serves as a normalizing constant to ensure this is a valid probability mass function. How would one efficiently code the computation of the denominator? For our purposes here you can take <span class="math inline">\(n=10000\)</span>, <span class="math inline">\(p=0.3\)</span> and <span class="math inline">\(\phi=0.5\)</span> when you need to actually run your code. Note that <span class="math inline">\(0^0=1\)</span>.</p>
<blockquote class="blockquote">
<p><strong>Warning</strong>: we always want to do such calculations on the log scale, only exponentiating at the end if necessary. Otherwise we’re likely to run into overflow or underflow, where the result is too big or too small to store in the 8-byte floating point representation (more in a later Unit).</p>
</blockquote>
<p>Here’s a non-vectorized approach:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb614"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb614-1"><a href="#cb614-1" aria-hidden="true" tabindex="-1"></a>logLik <span class="ot">&lt;-</span> <span class="cf">function</span>(k, n, p, phi) {</span>
<span id="cb614-2"><a href="#cb614-2" aria-hidden="true" tabindex="-1"></a>  klogk <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(k <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, k<span class="sc">*</span><span class="fu">log</span>(k))</span>
<span id="cb614-3"><a href="#cb614-3" aria-hidden="true" tabindex="-1"></a>  nmklognmk <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(n<span class="sc">-</span>k <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, (n<span class="sc">-</span>k)<span class="sc">*</span><span class="fu">log</span>(n<span class="sc">-</span>k))</span>
<span id="cb614-4"><a href="#cb614-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>(<span class="fu">lchoose</span>(n, k) <span class="sc">+</span> klogk <span class="sc">+</span> nmklognmk <span class="sc">-</span> n<span class="sc">*</span><span class="fu">log</span>(n) <span class="sc">+</span> phi<span class="sc">*</span>(n<span class="sc">*</span><span class="fu">log</span>(n) <span class="sc">-</span></span>
<span id="cb614-5"><a href="#cb614-5" aria-hidden="true" tabindex="-1"></a>      klogk <span class="sc">-</span> nmklognmk) <span class="sc">+</span> k<span class="sc">*</span>phi<span class="sc">*</span><span class="fu">log</span>(p) <span class="sc">+</span> (n<span class="sc">-</span>k)<span class="sc">*</span>phi<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>p))</span>
<span id="cb614-6"><a href="#cb614-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb614-7"><a href="#cb614-7" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb614-8"><a href="#cb614-8" aria-hidden="true" tabindex="-1"></a>out1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(<span class="dv">0</span><span class="sc">:</span>n, logLik, n, p, phi))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And here’s a basic vectorized approach.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb615"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb615-1"><a href="#cb615-1" aria-hidden="true" tabindex="-1"></a>normConstVecNaive <span class="ot">&lt;-</span> <span class="cf">function</span>(n, p, phi) {</span>
<span id="cb615-2"><a href="#cb615-2" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span>n</span>
<span id="cb615-3"><a href="#cb615-3" aria-hidden="true" tabindex="-1"></a>    loglik <span class="ot">&lt;-</span> <span class="fu">lchoose</span>(n, k)</span>
<span id="cb615-4"><a href="#cb615-4" aria-hidden="true" tabindex="-1"></a>    klogk <span class="ot">&lt;-</span> k<span class="sc">*</span><span class="fu">log</span>(k)</span>
<span id="cb615-5"><a href="#cb615-5" aria-hidden="true" tabindex="-1"></a>    klogk[<span class="fu">is.nan</span>(klogk)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb615-6"><a href="#cb615-6" aria-hidden="true" tabindex="-1"></a>    nmklognmk <span class="ot">&lt;-</span> (n<span class="sc">-</span>k)<span class="sc">*</span><span class="fu">log</span>((n<span class="sc">-</span>k))</span>
<span id="cb615-7"><a href="#cb615-7" aria-hidden="true" tabindex="-1"></a>    nmklognmk[<span class="fu">is.nan</span>(nmklognmk)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb615-8"><a href="#cb615-8" aria-hidden="true" tabindex="-1"></a>    logLik <span class="ot">&lt;-</span> <span class="fu">lchoose</span>(n, k) <span class="sc">+</span> klogk <span class="sc">+</span> nmklognmk <span class="sc">-</span> n<span class="sc">*</span><span class="fu">log</span>(n) <span class="sc">+</span> phi<span class="sc">*</span>(n<span class="sc">*</span><span class="fu">log</span>(n) <span class="sc">-</span> klogk <span class="sc">-</span> nmklognmk) <span class="sc">+</span></span>
<span id="cb615-9"><a href="#cb615-9" aria-hidden="true" tabindex="-1"></a>        k<span class="sc">*</span>phi<span class="sc">*</span><span class="fu">log</span>(p) <span class="sc">+</span> (n <span class="sc">-</span> k)<span class="sc">*</span>phi<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>p)</span>
<span id="cb615-10"><a href="#cb615-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sum</span>(<span class="fu">exp</span>(logLik)))</span>
<span id="cb615-11"><a href="#cb615-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb615-12"><a href="#cb615-12" aria-hidden="true" tabindex="-1"></a>out2 <span class="ot">&lt;-</span> <span class="fu">normConstVecNaive</span>(n, p, phi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Questions: 1. List some inefficiencies in <code>normConstVecNaive</code>. 2. Write a faster version.</p>
<p><strong>Challenge 7:</strong> Suppose we have a matrix in which each row is a vector of probabilities that add to one, and we want to generate a categorical sample based on each row. E.g., the first row might be (0.9, 0.05, 0.05) and the second row might be (0.1, 0.85, .0.5). When we generate the first sample, it is very likely to be a 1 and the second sample is very likely to be a 2. We could do this using a for loop over the rows of the matrix, and the <em>sample</em> function, but that is a lot slower than some other ways we might do it. How can we do it faster?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb616"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb616-1"><a href="#cb616-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100000</span></span>
<span id="cb616-2"><a href="#cb616-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">5</span>  <span class="do">## number of categories</span></span>
<span id="cb616-3"><a href="#cb616-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb616-4"><a href="#cb616-4" aria-hidden="true" tabindex="-1"></a><span class="do">## way to generate a random matrix of row-normalized probabilities:</span></span>
<span id="cb616-5"><a href="#cb616-5" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>p), <span class="at">nrow =</span> n, <span class="at">ncol =</span> p))</span>
<span id="cb616-6"><a href="#cb616-6" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> tmp <span class="sc">/</span> <span class="fu">rowSums</span>(tmp)</span>
<span id="cb616-7"><a href="#cb616-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb616-8"><a href="#cb616-8" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)</span>
<span id="cb616-9"><a href="#cb616-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb616-10"><a href="#cb616-10" aria-hidden="true" tabindex="-1"></a><span class="do">## loop by row and use sample()</span></span>
<span id="cb616-11"><a href="#cb616-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb616-12"><a href="#cb616-12" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb616-13"><a href="#cb616-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(n))</span>
<span id="cb616-14"><a href="#cb616-14" aria-hidden="true" tabindex="-1"></a>        smp[i] <span class="ot">&lt;-</span> <span class="fu">sample</span>(p, <span class="dv">1</span>, <span class="at">prob =</span> probs[i, ])</span>
<span id="cb616-15"><a href="#cb616-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="computing-on-the-language-optional" class="level1">
<h1>10. Computing on the language (optional)</h1>
<p>We won’t cover this section, and I won’t expect you to know this material, but some of you may find it interesting. Also, when I talked about R being a particularly flexible language in explaining in part why R can be slow, much of that flexibility is illustrated here.</p>
<section id="the-r-interpreter" class="level2">
<h2 class="anchored" data-anchor-id="the-r-interpreter">The R interpreter</h2>
<section id="parsing" class="level3">
<h3 class="anchored" data-anchor-id="parsing">Parsing</h3>
<p>When you run R, the R interpreter takes the code you type or the lines of code that are read in a batch session and parses each statement, translating the text into functional form. It substitutes objects for the symbols (names) that represent those objects and evaluates the statement, returning the resulting object. For complicated R code, this may be recursive.</p>
<p>Since everything in R is an object, the result of parsing is an object that we’ll be able to investigate, and the result of evaluating the parsed statement is an object.</p>
<p>We’ll see more on parsing in the next section.</p>
</section>
<section id="primitive-and-.internal-and-.external" class="level3">
<h3 class="anchored" data-anchor-id="primitive-and-.internal-and-.external"><code>.Primitive()</code> and <code>.Internal()</code> (and <code>.External()</code>)</h3>
<p>Some functionality is implemented internally within the C implementation that lies at the heart of R. If you see <code>.Internal()</code> or <code>.Primitive()</code> or <code>.External()</code>, in the code of a function, you know it’s implemented internally (and therefore generally very quickly). Unfortunately, it also means that you don’t get to see R code that implements the functionality, though Chambers p.&nbsp;465 describes how you can look into the C source code. Basically you need to download the source code for the relevant package off of CRAN.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb617"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb617-1"><a href="#cb617-1" aria-hidden="true" tabindex="-1"></a>plot.xy <span class="co"># plot.xy() is called by plot.default()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (xy, type, pch = par("pch"), lty = par("lty"), col = par("col"), 
    bg = NA, cex = 1, lwd = par("lwd"), ...) 
{
    if (is.null(type)) 
        type &lt;- "p"
    type &lt;- as.character(type)
    if (length(type) != 1L || !nzchar(type) || is.na(type)) 
        stop(gettextf("invalid plot type"))
    if (nchar(type) &gt; 1L) 
        warning(gettextf("plot type '%s' will be truncated to first character", 
            type))
    t &lt;- substr(type, 1L, 1L)
    if (!isTRUE(t %in% c("l", "o", "b", "c", "s", "S", "h", "p", 
        "n"))) 
        stop(gettextf("invalid plot type '%s'", t))
    invisible(.External.graphics(C_plotXY, xy, t, pch, lty, col, 
        bg, cex, lwd, ...))
}
&lt;bytecode: 0x55a135347870&gt;
&lt;environment: namespace:graphics&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb619"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb619-1"><a href="#cb619-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">`</span><span class="at">%*%</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, y)  .Primitive("%*%")</code></pre>
</div>
</div>
</section>
</section>
<section id="parsing-code-and-understanding-language-objects" class="level2">
<h2 class="anchored" data-anchor-id="parsing-code-and-understanding-language-objects">Parsing code and understanding language objects</h2>
<p>R code can be manipulated in text form and we can actually write R code that will create or manipulate R code. We can then evaluate that R code using <code>eval()</code>.</p>
<p><code>quote()</code> will parse R code, but not evaluate it. This allows you to work with the code rather than the results of evaluating that code. The <code>print()</code> method for language objects is not very helpful! But we can see the parsed code by treating the result as a list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb621"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb621-1"><a href="#cb621-1" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="cf">if</span> (x <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="st">"orange"</span> <span class="cf">else</span> <span class="st">"apple"</span>)</span>
<span id="cb621-2"><a href="#cb621-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(obj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
`if`

[[2]]
x &gt; 1

[[3]]
[1] "orange"

[[4]]
[1] "apple"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb623"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb623-1"><a href="#cb623-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(obj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "if"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb625"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb625-1"><a href="#cb625-1" aria-hidden="true" tabindex="-1"></a>weirdObj <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="st">`</span><span class="at">if</span><span class="st">`</span>(x <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="st">'orange'</span>, <span class="st">'apple'</span>))</span>
<span id="cb625-2"><a href="#cb625-2" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(obj, weirdObj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Recall that to access symbols that involve special syntax (such as special characters), you use backquotes.</p>
<p>Officially, the name that you assign to an object (including functions) is a <em>symbol</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb627"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb627-1"><a href="#cb627-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">3</span>; <span class="fu">typeof</span>(<span class="fu">quote</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "symbol"</code></pre>
</div>
</div>
<p>We can create an <em>expression</em> object that contains R code as</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb629"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb629-1"><a href="#cb629-1" aria-hidden="true" tabindex="-1"></a>myExpr <span class="ot">&lt;-</span> <span class="fu">expression</span>(x <span class="ot">&lt;-</span> <span class="dv">3</span>)</span>
<span id="cb629-2"><a href="#cb629-2" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(myExpr)</span>
<span id="cb629-3"><a href="#cb629-3" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(myExpr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "expression"</code></pre>
</div>
</div>
<p>The difference between <code>quote()</code> and <code>expression()</code> is basically that <code>quote()</code> works with a single statement (including multiple statements inside {...}), while <code>expression()</code> can deal with multiple statements, returning a list-like object of parsed statements. Both of them parse R code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb631"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb631-1"><a href="#cb631-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">quote</span>(x <span class="ot">&lt;-</span> <span class="dv">5</span>)</span>
<span id="cb631-2"><a href="#cb631-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">expression</span>(x <span class="ot">&lt;-</span> <span class="dv">5</span>, y <span class="ot">&lt;-</span> <span class="dv">3</span>)</span>
<span id="cb631-3"><a href="#cb631-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">quote</span>({x <span class="ot">&lt;-</span> <span class="dv">5</span>; y <span class="ot">&lt;-</span> <span class="dv">3</span>})</span>
<span id="cb631-4"><a href="#cb631-4" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "&lt;-"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb633"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb633-1"><a href="#cb633-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "expression"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb635"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb635-1"><a href="#cb635-1" aria-hidden="true" tabindex="-1"></a>b[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>x &lt;- 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb637"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb637-1"><a href="#cb637-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(b[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "&lt;-"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb639"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb639-1"><a href="#cb639-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(a, b[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb641"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb641-1"><a href="#cb641-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(d[[<span class="dv">2</span>]], b[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>The following table shows the <em>language</em> objects in R; note that there are three classes of language objects: <em>expressions</em>, <em>calls</em>, and <em>names</em>.</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 33%">
<col style="width: 15%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>Example syntax to create</th>
<th>Class</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>object names</td>
<td><code>quote(x)</code></td>
<td>name</td>
<td>symbol (language)</td>
</tr>
<tr class="even">
<td>expressions</td>
<td><code>expression(x &lt;- 3)</code></td>
<td>expression</td>
<td>expression (language)</td>
</tr>
<tr class="odd">
<td>function calls</td>
<td><code>quote(f())</code></td>
<td>call</td>
<td>language</td>
</tr>
<tr class="even">
<td>if statements</td>
<td><code>quote(if(x &lt; 3) y=5)</code></td>
<td>if (call)</td>
<td>language</td>
</tr>
<tr class="odd">
<td>for statement</td>
<td><code>quote(for(i in 1:5) {})</code></td>
<td>for (call)</td>
<td>language</td>
</tr>
<tr class="even">
<td>assignments</td>
<td><code>quote(x &lt;- 3)</code></td>
<td>&lt;- (call)</td>
<td>language</td>
</tr>
<tr class="odd">
<td>operators</td>
<td><code>quote(3 + 7)</code></td>
<td>call</td>
<td>language</td>
</tr>
</tbody>
</table>
<p><br>
Basically any standard function, operator, <code>if</code> statement, <code>for</code> statement, assignment, etc. are function calls and inherit from the <code>call</code> class.</p>
<p>Objects of type language are not officially lists, but they can be queried as such. You can convert between language objects and lists with <code>as.list()</code> and <code>as.call()</code>.</p>
<p>An official expression is one or more syntactically correct R statements. When we use <code>quote()</code>, we’re working with a single statement, while <code>expression()</code> will create a list of separate statements (essentially separate call objects). I’m trying to use the term <em>statement</em> to refer colloquially to R code, rather than using the term <em>expression</em>, since that has formal definition in this context.</p>
<p>Let’s take a look at some examples of language objects and parsing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb643"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb643-1"><a href="#cb643-1" aria-hidden="true" tabindex="-1"></a>e0 <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="dv">3</span>)</span>
<span id="cb643-2"><a href="#cb643-2" aria-hidden="true" tabindex="-1"></a>e1 <span class="ot">&lt;-</span> <span class="fu">expression</span>(x <span class="ot">&lt;-</span> <span class="dv">3</span>) </span>
<span id="cb643-3"><a href="#cb643-3" aria-hidden="true" tabindex="-1"></a>e1m <span class="ot">&lt;-</span> <span class="fu">expression</span>({x <span class="ot">&lt;-</span> <span class="dv">3</span>; y <span class="ot">&lt;-</span> <span class="dv">5</span>}) </span>
<span id="cb643-4"><a href="#cb643-4" aria-hidden="true" tabindex="-1"></a>e2 <span class="ot">&lt;-</span> <span class="fu">quote</span>(x <span class="ot">&lt;-</span> <span class="dv">3</span>) </span>
<span id="cb643-5"><a href="#cb643-5" aria-hidden="true" tabindex="-1"></a>e3 <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="fu">rnorm</span>(<span class="dv">3</span>))</span>
<span id="cb643-6"><a href="#cb643-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e0), <span class="fu">typeof</span>(e0)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "numeric" "double" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb645"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb645-1"><a href="#cb645-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e1), <span class="fu">typeof</span>(e1)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "expression" "expression"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb647"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb647-1"><a href="#cb647-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e1[[<span class="dv">1</span>]]), <span class="fu">typeof</span>(e1[[<span class="dv">1</span>]])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "&lt;-"       "language"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb649"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb649-1"><a href="#cb649-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e1m), <span class="fu">typeof</span>(e1m)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "expression" "expression"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb651"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb651-1"><a href="#cb651-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e2), <span class="fu">typeof</span>(e2)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "&lt;-"       "language"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb653"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb653-1"><a href="#cb653-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(e1[[<span class="dv">1</span>]], e2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb655"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb655-1"><a href="#cb655-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e3), <span class="fu">typeof</span>(e3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "call"     "language"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb657"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb657-1"><a href="#cb657-1" aria-hidden="true" tabindex="-1"></a>e4 <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="sc">-</span><span class="dv">7</span>)</span>
<span id="cb657-2"><a href="#cb657-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e4), <span class="fu">typeof</span>(e4))) <span class="co"># huh? what does this imply?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "call"     "language"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb659"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb659-1"><a href="#cb659-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(e4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
`-`

[[2]]
[1] 7</code></pre>
</div>
</div>
<p>We can evaluate language types using <code>eval()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb661"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb661-1"><a href="#cb661-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x)</span>
<span id="cb661-2"><a href="#cb661-2" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(e1)</span>
<span id="cb661-3"><a href="#cb661-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x)</span>
<span id="cb661-4"><a href="#cb661-4" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(e2)</span>
<span id="cb661-5"><a href="#cb661-5" aria-hidden="true" tabindex="-1"></a>e1mlist <span class="ot">&lt;-</span> <span class="fu">as.list</span>(e1m)</span>
<span id="cb661-6"><a href="#cb661-6" aria-hidden="true" tabindex="-1"></a>e2list <span class="ot">&lt;-</span> <span class="fu">as.list</span>(e2)</span>
<span id="cb661-7"><a href="#cb661-7" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">as.call</span>(e2list)) </span>
<span id="cb661-8"><a href="#cb661-8" aria-hidden="true" tabindex="-1"></a><span class="do">## here's how to do it if the language object is actually an expression (multiple statements)</span></span>
<span id="cb661-9"><a href="#cb661-9" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">as.expression</span>(e1mlist))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s look in more detail at the components of R expressions. We’ll be able to get a sense from this of how R evaluates code. We see that when R evaluates a parse tree, the first element says what function to use and the remaining elements are the arguments. But in many cases one or more arguments will themselves be call objects, so there’s recursion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb662"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb662-1"><a href="#cb662-1" aria-hidden="true" tabindex="-1"></a>e1 <span class="ot">&lt;-</span> <span class="fu">expression</span>(x <span class="ot">&lt;-</span> <span class="dv">3</span>) </span>
<span id="cb662-2"><a href="#cb662-2" aria-hidden="true" tabindex="-1"></a><span class="do">## e1 is one-element list with the element an object of class '&lt;-' </span></span>
<span id="cb662-3"><a href="#cb662-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e1), <span class="fu">typeof</span>(e1)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "expression" "expression"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb664"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb664-1"><a href="#cb664-1" aria-hidden="true" tabindex="-1"></a>e1[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>x &lt;- 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb666"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb666-1"><a href="#cb666-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(e1[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
`&lt;-`

[[2]]
x

[[3]]
[1] 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb668"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb668-1"><a href="#cb668-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(e1[[<span class="dv">1</span>]], class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "name"

[[2]]
[1] "name"

[[3]]
[1] "numeric"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb670"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb670-1"><a href="#cb670-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb670-2"><a href="#cb670-2" aria-hidden="true" tabindex="-1"></a>e3 <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="fu">mean</span>(y))</span>
<span id="cb670-3"><a href="#cb670-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e3), <span class="fu">typeof</span>(e3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "call"     "language"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb672"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb672-1"><a href="#cb672-1" aria-hidden="true" tabindex="-1"></a>e3[[<span class="dv">1</span>]] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>mean</code></pre>
</div>
<div class="sourceCode cell-code" id="cb674"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb674-1"><a href="#cb674-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e3[[<span class="dv">1</span>]]), <span class="fu">typeof</span>(e3[[<span class="dv">1</span>]])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "name"   "symbol"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb676"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb676-1"><a href="#cb676-1" aria-hidden="true" tabindex="-1"></a>e3[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>y</code></pre>
</div>
<div class="sourceCode cell-code" id="cb678"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb678-1"><a href="#cb678-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">class</span>(e3[[<span class="dv">2</span>]]), <span class="fu">typeof</span>(e3[[<span class="dv">2</span>]])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "name"   "symbol"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb680"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb680-1"><a href="#cb680-1" aria-hidden="true" tabindex="-1"></a><span class="do">## we have recursion</span></span>
<span id="cb680-2"><a href="#cb680-2" aria-hidden="true" tabindex="-1"></a>e3 <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="fu">mean</span>(<span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">15</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">3</span>)))</span>
<span id="cb680-3"><a href="#cb680-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(e3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
mean

[[2]]
c(12, 13, 15) + rnorm(3)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb682"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb682-1"><a href="#cb682-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(e3[[<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
`+`

[[2]]
c(12, 13, 15)

[[3]]
rnorm(3)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb684"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb684-1"><a href="#cb684-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(e3[[<span class="dv">2</span>]][[<span class="dv">3</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
rnorm

[[2]]
[1] 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb686"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb686-1"><a href="#cb686-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb686-2"><a href="#cb686-2" aria-hidden="true" tabindex="-1"></a><span class="fu">call_tree</span>(e3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>\- ()
  \- `mean
  \- ()
    \- `+
    \- ()
      \- `c
      \-  12
      \-  13
      \-  15
    \- ()
      \- `rnorm
      \-  3 </code></pre>
</div>
</div>
</section>
<section id="manipulating-the-parse-tree" class="level2">
<h2 class="anchored" data-anchor-id="manipulating-the-parse-tree">Manipulating the parse tree</h2>
<p>Of course since the parsed code is just an object, we can manipulate it, i.e., <em>compute on the language</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb688"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb688-1"><a href="#cb688-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">quote</span>(y <span class="ot">&lt;-</span> <span class="dv">3</span>)</span>
<span id="cb688-2"><a href="#cb688-2" aria-hidden="true" tabindex="-1"></a>out[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb688-3"><a href="#cb688-3" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(out)</span>
<span id="cb688-4"><a href="#cb688-4" aria-hidden="true" tabindex="-1"></a>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>Here’s another example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb690"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb690-1"><a href="#cb690-1" aria-hidden="true" tabindex="-1"></a>e1 <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="dv">4</span> <span class="sc">+</span> <span class="dv">5</span>)</span>
<span id="cb690-2"><a href="#cb690-2" aria-hidden="true" tabindex="-1"></a>e2 <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="fu">plot</span>(x, y))</span>
<span id="cb690-3"><a href="#cb690-3" aria-hidden="true" tabindex="-1"></a>e2[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="st">`</span><span class="at">+</span><span class="st">`</span></span>
<span id="cb690-4"><a href="#cb690-4" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(e2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb692"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb692-1"><a href="#cb692-1" aria-hidden="true" tabindex="-1"></a>e1[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> e2</span>
<span id="cb692-2"><a href="#cb692-2" aria-hidden="true" tabindex="-1"></a>e1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>4 + .Primitive("+")(x, y)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb694"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb694-1"><a href="#cb694-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(e1[[<span class="dv">3</span>]]) <span class="co"># note the nesting</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "call"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb696"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb696-1"><a href="#cb696-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(e1) <span class="co"># what should I get?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 11</code></pre>
</div>
</div>
<p>We can also turn it back into standard R code, as a character, using <code>deparse()</code>, which turns the parse tree back into R code as text. <code>parse()</code> is like <code>quote()</code> but it takes the code in the form of a string rather than an actual expression:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb698"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb698-1"><a href="#cb698-1" aria-hidden="true" tabindex="-1"></a>codeText <span class="ot">&lt;-</span> <span class="fu">deparse</span>(out)</span>
<span id="cb698-2"><a href="#cb698-2" aria-hidden="true" tabindex="-1"></a>parsedCode <span class="ot">&lt;-</span> <span class="fu">parse</span>(<span class="at">text =</span> codeText) </span>
<span id="cb698-3"><a href="#cb698-3" aria-hidden="true" tabindex="-1"></a><span class="do">## parse() works like quote() except on the code in the form of a string</span></span>
<span id="cb698-4"><a href="#cb698-4" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(parsedCode)</span>
<span id="cb698-5"><a href="#cb698-5" aria-hidden="true" tabindex="-1"></a><span class="fu">deparse</span>(<span class="fu">quote</span>(<span class="cf">if</span> (x <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="st">"orange"</span> <span class="cf">else</span> <span class="st">"apple"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "if (x &gt; 1) \"orange\" else \"apple\""</code></pre>
</div>
</div>
<p>Note that the quotes have been escaped since they’re inside a string.</p>
<p>It can be very useful to be able to convert names of objects that are in the form of text to names that R interprets as symbols referring to objects:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb700"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb700-1"><a href="#cb700-1" aria-hidden="true" tabindex="-1"></a>x3 <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb700-2"><a href="#cb700-2" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb700-3"><a href="#cb700-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as.name</span>(<span class="fu">paste</span>(<span class="st">'x'</span>, i, <span class="at">sep=</span><span class="st">''</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>x3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb702"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb702-1"><a href="#cb702-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(<span class="fu">as.name</span>(<span class="fu">paste</span>(<span class="st">'x'</span>, i, <span class="at">sep=</span><span class="st">''</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb704"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb704-1"><a href="#cb704-1" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="fu">paste</span>(<span class="st">'x'</span>, i, <span class="at">sep =</span> <span class="st">''</span>), <span class="dv">11</span>)</span>
<span id="cb704-2"><a href="#cb704-2" aria-hidden="true" tabindex="-1"></a>x3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 11</code></pre>
</div>
</div>
</section>
<section id="parsing-replacement-expressions" class="level2">
<h2 class="anchored" data-anchor-id="parsing-replacement-expressions">Parsing replacement expressions</h2>
<p>Let’s consider replacement expressions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb706"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb706-1"><a href="#cb706-1" aria-hidden="true" tabindex="-1"></a>animals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'cat'</span>, <span class="st">'dog'</span>, <span class="st">'rat'</span>,<span class="st">'mouse'</span>)</span>
<span id="cb706-2"><a href="#cb706-2" aria-hidden="true" tabindex="-1"></a>out1 <span class="ot">&lt;-</span> <span class="fu">quote</span>(animals[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">'rat'</span>) </span>
<span id="cb706-3"><a href="#cb706-3" aria-hidden="true" tabindex="-1"></a>out2 <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="st">`</span><span class="at">&lt;-</span><span class="st">`</span>(animals[<span class="dv">4</span>], <span class="st">'rat'</span>)) </span>
<span id="cb706-4"><a href="#cb706-4" aria-hidden="true" tabindex="-1"></a>out3 <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="st">'[&lt;-'</span>(animals,<span class="dv">4</span>,<span class="st">'rat'</span>)) </span>
<span id="cb706-5"><a href="#cb706-5" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(out1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
`&lt;-`

[[2]]
animals[4]

[[3]]
[1] "rat"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb708"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb708-1"><a href="#cb708-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(out2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
`&lt;-`

[[2]]
animals[4]

[[3]]
[1] "rat"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb710"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb710-1"><a href="#cb710-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(out1, out2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb712"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb712-1"><a href="#cb712-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(out3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
`[&lt;-`

[[2]]
animals

[[3]]
[1] 4

[[4]]
[1] "rat"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb714"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb714-1"><a href="#cb714-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(out1, out3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb716"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb716-1"><a href="#cb716-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(out1[[<span class="dv">2</span>]]) <span class="co"># language</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "language"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb718"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb718-1"><a href="#cb718-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(out1[[<span class="dv">2</span>]]) <span class="co"># call</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "call"</code></pre>
</div>
</div>
<p>The parse tree for <code>out3</code> is different than those for <code>out1</code> and <code>out2</code>, but when <code>out3</code> is evaluated the result is the same as for <code>out1</code> and <code>out2</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb720"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb720-1"><a href="#cb720-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(out1)</span>
<span id="cb720-2"><a href="#cb720-2" aria-hidden="true" tabindex="-1"></a>animals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cat" "dog" "rat" "rat"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb722"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb722-1"><a href="#cb722-1" aria-hidden="true" tabindex="-1"></a>animals[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">'mouse'</span>  <span class="co"># reset things to original state</span></span>
<span id="cb722-2"><a href="#cb722-2" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(out3) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cat" "dog" "rat" "rat"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb724"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb724-1"><a href="#cb724-1" aria-hidden="true" tabindex="-1"></a>animals <span class="co"># both do the same thing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cat"   "dog"   "rat"   "mouse"</code></pre>
</div>
</div>
<p>Why? When R evaluates a call to ‘&lt;-’, if the first argument is a name, then it does the assignment, but if the first argument (i.e.&nbsp;what’s on the left-hand side of the “assignment”) is a call then it calls the appropriate replacement function. The second argument (the value being assigned) is evaluated first. Ultimately in all of these cases, the replacement function is used.</p>
</section>
<section id="substitute" class="level2">
<h2 class="anchored" data-anchor-id="substitute">substitute()</h2>
<p>The substitute function acts like <code>quote()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb726"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb726-1"><a href="#cb726-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">quote</span>(z <span class="ot">&lt;-</span> x<span class="sc">^</span><span class="dv">2</span>), <span class="fu">substitute</span>(z <span class="ot">&lt;-</span> x<span class="sc">^</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>But if you also pass <code>substitute()</code> an environment, it will replace symbols with their object values in that environment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb728"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb728-1"><a href="#cb728-1" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">new.env</span>(); e<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb728-2"><a href="#cb728-2" aria-hidden="true" tabindex="-1"></a><span class="fu">substitute</span>(z <span class="ot">&lt;-</span> x<span class="sc">^</span><span class="dv">2</span>, e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>z &lt;- 3^2</code></pre>
</div>
</div>
<p>This can do non-sensical stuff:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb730"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb730-1"><a href="#cb730-1" aria-hidden="true" tabindex="-1"></a>e<span class="sc">$</span>z <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb730-2"><a href="#cb730-2" aria-hidden="true" tabindex="-1"></a><span class="fu">substitute</span>(z <span class="ot">&lt;-</span> x<span class="sc">^</span><span class="dv">2</span>, e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5 &lt;- 3^2</code></pre>
</div>
</div>
<p>Let’s see a practical example of substituting for variables in statements:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb732"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb732-1"><a href="#cb732-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">5</span>), <span class="at">y =</span> <span class="fu">rgamma</span>(<span class="dv">5</span>, <span class="dv">1</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How does <code>plot()</code> get the axis label names? In the <code>plot()</code> function, you can see this syntax:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb733"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb733-1"><a href="#cb733-1" aria-hidden="true" tabindex="-1"></a>xlabel <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">missing</span>(x)) <span class="fu">deparse</span>(<span class="fu">substitute</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So what’s going on is that within <code>plot.default()</code>, it substitutes in for ‘<code>x</code>’ with the statement that was passed in as the <code>x</code> argument, and then uses <code>deparse()</code> to convert to character. The fact that <code>x</code> still has <code>rnorm(5)</code> associated with it rather than the five numerical values from evaluating <code>rnorm()</code> has to do with lazy evaluation and promises. Here’s the same idea in action in a stripped down example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb734"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb734-1"><a href="#cb734-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(obj){</span>
<span id="cb734-2"><a href="#cb734-2" aria-hidden="true" tabindex="-1"></a>objName <span class="ot">&lt;-</span> <span class="fu">deparse</span>(<span class="fu">substitute</span>(obj))</span>
<span id="cb734-3"><a href="#cb734-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(objName)</span>
<span id="cb734-4"><a href="#cb734-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb734-5"><a href="#cb734-5" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "y"</code></pre>
</div>
</div>
<p>More generally, we can substitute into <em>expression</em> and <em>call</em> objects by providing a named list (or an environment) - the substition happens within the context of this list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb736"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb736-1"><a href="#cb736-1" aria-hidden="true" tabindex="-1"></a><span class="fu">substitute</span>(a <span class="sc">+</span> b, <span class="fu">list</span>(<span class="at">a =</span> <span class="dv">1</span>, <span class="at">b =</span> <span class="fu">quote</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 + x</code></pre>
</div>
</div>
<p>Things can get intricate quickly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb738"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb738-1"><a href="#cb738-1" aria-hidden="true" tabindex="-1"></a>e1 <span class="ot">&lt;-</span> <span class="fu">quote</span>(x <span class="sc">+</span> y)</span>
<span id="cb738-2"><a href="#cb738-2" aria-hidden="true" tabindex="-1"></a>e2 <span class="ot">&lt;-</span> <span class="fu">substitute</span>(e1, <span class="fu">list</span>(<span class="at">x =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The problem is that <code>substitute()</code> doesn’t evaluate its first argument, <code>e1</code>, so it can’t replace the parsed elements in <code>e1</code>. Instead, we’d need to do the following, where we force the evaluation of <code>e1</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb739"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb739-1"><a href="#cb739-1" aria-hidden="true" tabindex="-1"></a>e2 <span class="ot">&lt;-</span> <span class="fu">substitute</span>(<span class="fu">substitute</span>(e, <span class="fu">list</span>(<span class="at">x =</span> <span class="dv">3</span>)), <span class="fu">list</span>(<span class="at">e =</span> e1))</span>
<span id="cb739-2"><a href="#cb739-2" aria-hidden="true" tabindex="-1"></a><span class="fu">substitute</span>(<span class="fu">substitute</span>(e, <span class="fu">list</span>(<span class="at">x =</span> <span class="dv">3</span>)), <span class="fu">list</span>(<span class="at">e =</span> e1)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>substitute(x + y, list(x = 3))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb741"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb741-1"><a href="#cb741-1" aria-hidden="true" tabindex="-1"></a><span class="do">## so e1 is substituted as an evaluated object, </span></span>
<span id="cb741-2"><a href="#cb741-2" aria-hidden="true" tabindex="-1"></a><span class="do">## which then allows for substitution for 'x' </span></span>
<span id="cb741-3"><a href="#cb741-3" aria-hidden="true" tabindex="-1"></a>e2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>substitute(x + y, list(x = 3))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb743"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb743-1"><a href="#cb743-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(e2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3 + y</code></pre>
</div>
<div class="sourceCode cell-code" id="cb745"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb745-1"><a href="#cb745-1" aria-hidden="true" tabindex="-1"></a><span class="fu">substitute_q</span>(e1, <span class="fu">list</span>(<span class="at">x =</span> <span class="dv">3</span>))  <span class="co"># from pryr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3 + y</code></pre>
</div>
</div>
<p>If this subsection is confusing, let me assure you that it has confused me too. The indirection going on here is very involved.</p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final thoughts</h2>
<p><strong>Challenge</strong>: figure out how a <code>for</code> loop is parsed in R. See how a <code>for</code> loop with one statement within the loop differs from one with two or more statements.</p>
<p>We’ll see <code>expression()</code> again when we talk about inserting mathematical notation in plots.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../units/unit4-goodPractices.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Unit 4</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../units/unit6-parallel.html" class="pagination-link">
        <span class="nav-page-text">Unit 6</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>